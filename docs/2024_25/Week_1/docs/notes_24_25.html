<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="generator" content="quarto-1.4.553">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
<title>Data Analysis Week 1 - Week 1: Visualising and data tidying using R</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>

<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<link href="./UofG_Coat_of_Arms.png" rel="icon" type="image/png">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-text-highlighting-styles">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-dark.css" rel="prefetch" class="quarto-color-scheme quarto-color-alternate" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-bootstrap" data-mode="light">
<link href="site_libs/bootstrap/bootstrap-dark.min.css" rel="prefetch" class="quarto-color-scheme quarto-color-alternate" id="quarto-bootstrap" data-mode="dark">
<link href="site_libs/quarto-contrib/bootstrap-icons-1.11.1/all.css" rel="stylesheet"><script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script><script src="site_libs/kePrint-0.0.1/kePrint.js"></script><link href="site_libs/lightable-0.0.1/lightable.css" rel="stylesheet">
<script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script><script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script><script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script><link rel="stylesheet" href="styles.css">
<link rel="stylesheet" href="include/webex.css">
</head>
<body class="floating nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top"><nav class="navbar navbar-expand-lg " data-bs-theme="dark"><div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a href="./index.html" class="navbar-brand navbar-brand-logo">
    <img src="./UofG.png" alt="" class="navbar-logo"></a>
    <a class="navbar-brand" href="./index.html">
    <span class="navbar-title">Data Analysis Week 1</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
<li class="nav-item">
    <a class="nav-link active" href="./notes_24_25.html" aria-current="page"> 
<span class="menu-text">Notes</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="./tutorial.html"> 
<span class="menu-text">Extra material</span></a>
  </li>  
</ul>
</div> <!-- /navcollapse -->
          <div class="quarto-navbar-tools">
  <a href="" class="quarto-color-scheme-toggle quarto-navigation-tool  px-1" onclick="window.quartoToggleColorScheme(); return false;" title="Toggle dark mode"><i class="bi"></i></a>
</div>
      </div> <!-- /container-fluid -->
    </nav></header><!-- content --><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto"><nav id="TOC" role="doc-toc" class="toc-active"><h2 id="toc-title">Contents</h2>
   
  <ul>
<li><a href="#getting-started-1" id="toc-getting-started-1" class="nav-link active" data-scroll-target="#getting-started-1"><span class="header-section-number">1</span> Getting started 1</a></li>
  <li><a href="#viewing-the-data" id="toc-viewing-the-data" class="nav-link" data-scroll-target="#viewing-the-data"><span class="header-section-number">2</span> Viewing the data</a></li>
  <li><a href="#tidy-data" id="toc-tidy-data" class="nav-link" data-scroll-target="#tidy-data"><span class="header-section-number">3</span> Tidy data</a></li>
  <li><a href="#tidying" id="toc-tidying" class="nav-link" data-scroll-target="#tidying"><span class="header-section-number">4</span> Converting to <strong>tidy</strong> data format</a></li>
  <li><a href="#reminder-of-ggplot" id="toc-reminder-of-ggplot" class="nav-link" data-scroll-target="#reminder-of-ggplot"><span class="header-section-number">5</span> Reminder of ggplot</a></li>
  <li>
<a href="#wrangling" id="toc-wrangling" class="nav-link" data-scroll-target="#wrangling"><span class="header-section-number">6</span> Data wrangling</a>
  <ul class="collapse">
<li><a href="#piping" id="toc-piping" class="nav-link" data-scroll-target="#piping"><span class="header-section-number">6.1</span> The pipe %&gt;%</a></li>
  <li><a href="#verbs" id="toc-verbs" class="nav-link" data-scroll-target="#verbs"><span class="header-section-number">6.2</span> Data wrangling verbs</a></li>
  <li><a href="#select-and-rename-columns" id="toc-select-and-rename-columns" class="nav-link" data-scroll-target="#select-and-rename-columns"><span class="header-section-number">6.3</span> Select and rename columns</a></li>
  <li><a href="#filter" id="toc-filter" class="nav-link" data-scroll-target="#filter"><span class="header-section-number">6.4</span> Filter observations using filter</a></li>
  <li><a href="#mutate" id="toc-mutate" class="nav-link" data-scroll-target="#mutate"><span class="header-section-number">6.5</span> Create new variables/change old variables using mutate</a></li>
  <li><a href="#summarize" id="toc-summarize" class="nav-link" data-scroll-target="#summarize"><span class="header-section-number">6.6</span> Summarise variables using summarize</a></li>
  <li><a href="#groupby" id="toc-groupby" class="nav-link" data-scroll-target="#groupby"><span class="header-section-number">6.7</span> Using grouping structures</a></li>
  <li><a href="#grouping-by-more-than-one-variable" id="toc-grouping-by-more-than-one-variable" class="nav-link" data-scroll-target="#grouping-by-more-than-one-variable"><span class="header-section-number">6.8</span> Grouping by more than one variable</a></li>
  </ul>
</li>
  <li>
<a href="#working-with-categorical-data" id="toc-working-with-categorical-data" class="nav-link" data-scroll-target="#working-with-categorical-data"><span class="header-section-number">7</span> Working with categorical data</a>
  <ul class="collapse">
<li><a href="#visualizing-categorical-data" id="toc-visualizing-categorical-data" class="nav-link" data-scroll-target="#visualizing-categorical-data"><span class="header-section-number">7.1</span> Visualizing categorical data</a></li>
  <li><a href="#vectorised-if-else-thru-case_when" id="toc-vectorised-if-else-thru-case_when" class="nav-link" data-scroll-target="#vectorised-if-else-thru-case_when"><span class="header-section-number">7.2</span> Vectorised if-else thru <code>case_when</code></a></li>
  </ul>
</li>
  <li>
<a href="#joins" id="toc-joins" class="nav-link" data-scroll-target="#joins"><span class="header-section-number">8</span> Joining data frames</a>
  <ul class="collapse">
<li><a href="#joining-by-key-variables" id="toc-joining-by-key-variables" class="nav-link" data-scroll-target="#joining-by-key-variables"><span class="header-section-number">8.1</span> Joining by “key” variables</a></li>
  <li><a href="#joining-by-key-variables-with-different-names" id="toc-joining-by-key-variables-with-different-names" class="nav-link" data-scroll-target="#joining-by-key-variables-with-different-names"><span class="header-section-number">8.2</span> Joining by “key” variables with different names</a></li>
  <li><a href="#joining-by-multiple-key-variables" id="toc-joining-by-multiple-key-variables" class="nav-link" data-scroll-target="#joining-by-multiple-key-variables"><span class="header-section-number">8.3</span> Joining by multiple “key” variables</a></li>
  </ul>
</li>
  <li><a href="#the-end" id="toc-the-end" class="nav-link" data-scroll-target="#the-end">The end?</a></li>
  </ul><div class="quarto-alternate-formats"><h2>Other Formats</h2><ul><li><a href="notes_24_25.pdf"><i class="bi bi-file-pdf"></i>PDF</a></li></ul></div></nav>
</nav><div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
    </div>
<!-- main -->
<main class="content" id="quarto-document-content"><header id="title-block-header" class="quarto-title-block default"><div class="quarto-title">
<div class="quarto-title-block"><div><h1 class="title">Week 1: Visualising and data tidying using R</h1><button type="button" class="btn code-tools-button dropdown-toggle" id="quarto-code-tools-menu" data-bs-toggle="dropdown" aria-expanded="false"><i class="bi"></i> Code</button><ul class="dropdown-menu dropdown-menu-end" aria-labelelledby="quarto-code-tools-menu"><li><a id="quarto-show-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Show All Code</a></li><li><a id="quarto-hide-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Hide All Code</a></li></ul></div></div>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header><section id="getting-started-1" class="level1" data-number="1"><h1 data-number="1">
<span class="header-section-number">1</span> Getting started 1</h1>
<p>This week we will review various techniques for data <strong>tidying</strong>, <strong>wrangling</strong> and <strong>visualization</strong> in R. We’ll revisit key concepts from your previous <strong>R programming</strong> course and build on them with more advanced methods for data manipulation and plotting.</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>A lot of the content within this course is based on the open-source book <a href="https://moderndive.com/index.html">Statistical Inference via Data Science</a> and thus is a useful source for additional examples and questions.</p>
</div>
</div>
<p>First, start by opening <strong>RStudio</strong> by going to <code>Desktop -&gt; Maths-Stats -&gt; RStudio</code>. Once RStudio has opened create a new R script by going to <code>File -&gt; New File -&gt; R Script</code>. Next go to <code>File -&gt; Save As...</code> and save the script into your personal drive, either <code>M:</code> or <code>K:</code> (do not save it to the <code>H:</code> drive). We shall now load into R all of the libraries we will need for this session. This can be done by typing the following into your R script:</p>
<div class="cell">
<details open="" class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb1"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org">ggplot2</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyverse.tidyverse.org">tidyverse</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/hadley/nycflights13">nycflights13</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/rudeboybert/fivethirtyeight">fivethirtyeight</a></span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>The libraries can be loaded into R by highlighting them in your script and then clicking on the <code>Run</code> button located in the top right of the script window. The first library <code>ggplot2</code> allows us to use functions within that package in order to create nice data visualisations. The <code>tidyverse</code> library is actually a collection of different R packages for manipulating data. The final two libraries (<code>nycflights13</code> and <code>fivethirtyeight</code>) contain interesting data sets that we shall examine in this session.</p>
<p>Notice that when loading the <code>tidyverse</code> package you get a message that tells you about conflicting functions of certain packages. This means that there is at least one or more functions with the same name loaded from different packages (and thus one the function will mask the other).</p>
<ol type="1">
<li><p>Using <code>::</code> after calling the package name every time we use the function from that package. E.g., <code>dplyr::filter(…)</code> will tell R to explicitly use the function <code>filter</code> from the <code>dplyr</code> library.</p></li>
<li><p>Load the <code>conflicted</code> library and use the <code>conflicts_prefer("function","package")</code> function to explicitly declare which version of the function you want to use in the remaining R session (i.e.&nbsp;after <code>conflicts_prefer()</code> is called, e.g., <code>conflict_prefer("filter","dplyr")</code> .</p></li>
</ol>
<div class="callout callout-style-default callout-tip no-icon callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<i class="bi-question-octagon " style="color: #6dc83c;" role="img" aria-hidden="true"></i> Question
</div>
</div>
<div class="callout-body-container callout-body">
<p>What do you think is the advantage of using the <code>conflicts_prefer</code> as opposed to the first approach?</p>
</div>
</div>
</section><section id="viewing-the-data" class="level1" data-number="2"><h1 data-number="2">
<span class="header-section-number">2</span> Viewing the data</h1>
<p>Before visualising any data set, we first need to know its contents. For example, the contents of the <code>flights</code> data within the <code>nycflights13</code> library can be observed using the following command:</p>
<div class="cell">
<details class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb2"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://pillar.r-lib.org/reference/glimpse.html">glimpse</a></span><span class="op">(</span><span class="va">flights</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code>Rows: 336,776
Columns: 19
$ year           &lt;int&gt; 2013, 2013, 2013, 2013, 2013, 2013, 2013, 2013, 2013, 2…
$ month          &lt;int&gt; 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1…
$ day            &lt;int&gt; 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1…
$ dep_time       &lt;int&gt; 517, 533, 542, 544, 554, 554, 555, 557, 557, 558, 558, …
$ sched_dep_time &lt;int&gt; 515, 529, 540, 545, 600, 558, 600, 600, 600, 600, 600, …
$ dep_delay      &lt;dbl&gt; 2, 4, 2, -1, -6, -4, -5, -3, -3, -2, -2, -2, -2, -2, -1…
$ arr_time       &lt;int&gt; 830, 850, 923, 1004, 812, 740, 913, 709, 838, 753, 849,…
$ sched_arr_time &lt;int&gt; 819, 830, 850, 1022, 837, 728, 854, 723, 846, 745, 851,…
$ arr_delay      &lt;dbl&gt; 11, 20, 33, -18, -25, 12, 19, -14, -8, 8, -2, -3, 7, -1…
$ carrier        &lt;chr&gt; "UA", "UA", "AA", "B6", "DL", "UA", "B6", "EV", "B6", "…
$ flight         &lt;int&gt; 1545, 1714, 1141, 725, 461, 1696, 507, 5708, 79, 301, 4…
$ tailnum        &lt;chr&gt; "N14228", "N24211", "N619AA", "N804JB", "N668DN", "N394…
$ origin         &lt;chr&gt; "EWR", "LGA", "JFK", "JFK", "LGA", "EWR", "EWR", "LGA",…
$ dest           &lt;chr&gt; "IAH", "IAH", "MIA", "BQN", "ATL", "ORD", "FLL", "IAD",…
$ air_time       &lt;dbl&gt; 227, 227, 160, 183, 116, 150, 158, 53, 140, 138, 149, 1…
$ distance       &lt;dbl&gt; 1400, 1416, 1089, 1576, 762, 719, 1065, 229, 944, 733, …
$ hour           &lt;dbl&gt; 5, 5, 5, 5, 6, 5, 6, 6, 6, 6, 6, 6, 6, 6, 6, 5, 6, 6, 6…
$ minute         &lt;dbl&gt; 15, 29, 40, 45, 0, 58, 0, 0, 0, 0, 0, 0, 0, 0, 0, 59, 0…
$ time_hour      &lt;dttm&gt; 2013-01-01 05:00:00, 2013-01-01 05:00:00, 2013-01-01 0…</code></pre>
</div>
</div>
<p>This function provides a concise overview of a data frame’s structure. For each column/variable, it displays the name, data type, and a brief preview of the actual values along with dimensions of the data set (i.e, 19 columns and 336776 rows).</p>
<p>Another useful function that can be used to quickly explore your data is the <code><a href="https://dplyr.tidyverse.org/reference/slice.html">slice()</a></code> function. It allows you to extract specific rows from a data frame based on their positions.</p>
<p>For example, <code>slice(flights, 1:5)</code> retrieves the first 5 rows of the <code>flights</code> data frame. Additionally, the <code>.by</code> argument in <code><a href="https://dplyr.tidyverse.org/reference/slice.html">slice()</a></code> enables grouped slicing (e.g.&nbsp;<code>slice(flights, 1:3, .by = carrier)</code> retrieves the first three rows within each group defined by the carrier variable). This function is useful for obtaining subsets of data for inspection or further analysis while preserving the structure within subgroups.</p>
<div class="callout callout-style-default callout-warning no-icon callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<i class="bi-pencil-square " style="color: #c8793c;" role="img" aria-hidden="true"></i> Task
</div>
</div>
<div class="callout-body-container callout-body">
<p>Use the <code>slice</code> function to print the first row of the <code>flights</code> data frame grouped by origin.</p>
<div class="webex-solution">
<button>
Take hint
</button>
<p>See the documentation for <code><a href="https://dplyr.tidyverse.org/reference/slice.html">slice()</a></code> (<code><a href="https://dplyr.tidyverse.org/reference/slice.html">?slice</a></code>).</p>
</div>
<div class="cell" data-webex.hide="Click here to see the solution">
<div class="webex-solution">
<button>
Click here to see the solution
</button>
<details open="" class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb4"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/slice.html">slice</a></span><span class="op">(</span><span class="va">flights</span>, <span class="fl">1</span>, .by <span class="op">=</span> <span class="va">origin</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code># A tibble: 3 × 19
   year month   day dep_time sched_dep_time dep_delay arr_time sched_arr_time
  &lt;int&gt; &lt;int&gt; &lt;int&gt;    &lt;int&gt;          &lt;int&gt;     &lt;dbl&gt;    &lt;int&gt;          &lt;int&gt;
1  2013     1     1      517            515         2      830            819
2  2013     1     1      533            529         4      850            830
3  2013     1     1      542            540         2      923            850
# ℹ 11 more variables: arr_delay &lt;dbl&gt;, carrier &lt;chr&gt;, flight &lt;int&gt;,
#   tailnum &lt;chr&gt;, origin &lt;chr&gt;, dest &lt;chr&gt;, air_time &lt;dbl&gt;, distance &lt;dbl&gt;,
#   hour &lt;dbl&gt;, minute &lt;dbl&gt;, time_hour &lt;dttm&gt;</code></pre>
</div>
</div>
</div>
</div>
</div>
</section><section id="tidy-data" class="level1" data-number="3"><h1 data-number="3">
<span class="header-section-number">3</span> Tidy data</h1>
<p>What does it mean for your data to be <strong>tidy</strong>? Beyond just being organised, having <strong>tidy</strong> data means that your data follows a standardised format. Tidy data is about structuring your data so that:</p>
<ol type="1">
<li><p>Each variable has its own column</p></li>
<li><p>Each observation has its own row</p></li>
<li><p>Each type of observation forms a table.</p></li>
</ol>
<p>This format makes it much easier to perform data analysis and ensures that your data is compatible with many of the tools and packages used in data science.</p>
<div class="cell">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><img src="tidy-1.png" class="img-fluid figure-img"></p>
<figcaption>Tidy data graphic from http://r4ds.had.co.nz/tidy-data.html</figcaption></figure>
</div>
</div>
</div>
<p>For example, say the following table consists of stock prices:</p>
<div class="cell">
<div class="cell-output-display">
<div>
<table class="table table-sm table-striped small" data-quarto-postprocess="true">
<caption>Stock Prices (Non-Tidy Format)</caption>
<thead><tr class="header">
<th style="text-align: left;" data-quarto-table-cell-role="th">Date</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">Boeing Stock Price</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">Amazon Stock Price</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">Google Stock Price</th>
</tr></thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">2009-01-01</td>
<td style="text-align: left;">$173.55</td>
<td style="text-align: left;">$174.90</td>
<td style="text-align: left;">$174.34</td>
</tr>
<tr class="even">
<td style="text-align: left;">2009-01-02</td>
<td style="text-align: left;">$172.61</td>
<td style="text-align: left;">$171.42</td>
<td style="text-align: left;">$170.04</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<p>Although the data are neatly organised in a spreadsheet-type format, they are not in tidy format since there are three variables corresponding to three unique pieces of information (Date, Stock Name, and Stock Price), but there are not three columns. In tidy data format each variable should be its own column, as shown below. Notice that both tables present the same information, but in different formats.</p>
<div class="cell">
<div class="cell-output-display">
<div>
<table class="table table-sm table-striped small" data-quarto-postprocess="true">
<caption>Stock Prices (Tidy Format)</caption>
<thead><tr class="header">
<th style="text-align: left;" data-quarto-table-cell-role="th">Date</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">Stock Name</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">Stock Price</th>
</tr></thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">2009-01-01</td>
<td style="text-align: left;">Boeing</td>
<td style="text-align: left;">$173.55</td>
</tr>
<tr class="even">
<td style="text-align: left;">2009-01-02</td>
<td style="text-align: left;">Boeing</td>
<td style="text-align: left;">$172.61</td>
</tr>
<tr class="odd">
<td style="text-align: left;">2009-01-01</td>
<td style="text-align: left;">Amazon</td>
<td style="text-align: left;">$174.90</td>
</tr>
<tr class="even">
<td style="text-align: left;">2009-01-02</td>
<td style="text-align: left;">Amazon</td>
<td style="text-align: left;">$171.42</td>
</tr>
<tr class="odd">
<td style="text-align: left;">2009-01-01</td>
<td style="text-align: left;">Google</td>
<td style="text-align: left;">$174.34</td>
</tr>
<tr class="even">
<td style="text-align: left;">2009-01-02</td>
<td style="text-align: left;">Google</td>
<td style="text-align: left;">$170.04</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<p>However, consider the following table:</p>
<div class="cell">
<div class="cell-output-display">
<div>
<table class="table table-sm table-striped small" data-quarto-postprocess="true">
<caption>Date, Boeing Price, Weather Data</caption>
<thead><tr class="header">
<th style="text-align: left;" data-quarto-table-cell-role="th">Date</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">Boeing Price</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">Weather</th>
</tr></thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">2009-01-01</td>
<td style="text-align: left;">$173.55</td>
<td style="text-align: left;">Sunny</td>
</tr>
<tr class="even">
<td style="text-align: left;">2009-01-02</td>
<td style="text-align: left;">$172.61</td>
<td style="text-align: left;">Overcast</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<p>In this case, even though the variable <strong>Boeing Price</strong> occurs again, the data <em>is</em> tidy since there are three variables corresponding to three unique pieces of information (Date, Boeing stock price, and the weather on that particular day).</p>
<p>The non-tidy data format in the original table is also known as <a href="https://en.wikipedia.org/wiki/Wide_and_narrow_data">wide</a> format whereas the tidy data format in the second table is also known as <a href="https://en.wikipedia.org/wiki/Wide_and_narrow_data#Narrow">long/narrow</a> data format. In this course, we will work mostly with data sets that are already in the tidy format.</p>
<div class="callout callout-style-default callout-tip no-icon callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<i class="bi-question-octagon " style="color: #6dc83c;" role="img" aria-hidden="true"></i> Question
</div>
</div>
<div class="callout-body-container callout-body">
<p>Consider the following data frame of average number of servings of beer, spirits, and wine consumption in three countries as reported in the FiveThirtyEight article <a href="https://fivethirtyeight.com/features/dear-mona-followup-where-do-people-drink-the-most-beer-wine-and-spirits/">Dear Mona Followup: Where Do People Drink The Most Beer, Wine And Spirits?</a></p>
<div class="cell">
<div class="cell-output-display">
<table class="table table-sm table-striped small">
<thead><tr class="header">
<th style="text-align: left;">country</th>
<th style="text-align: right;">beer_servings</th>
<th style="text-align: right;">spirit_servings</th>
<th style="text-align: right;">wine_servings</th>
</tr></thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">Canada</td>
<td style="text-align: right;">240</td>
<td style="text-align: right;">122</td>
<td style="text-align: right;">100</td>
</tr>
<tr class="even">
<td style="text-align: left;">South Korea</td>
<td style="text-align: right;">140</td>
<td style="text-align: right;">16</td>
<td style="text-align: right;">9</td>
</tr>
<tr class="odd">
<td style="text-align: left;">USA</td>
<td style="text-align: right;">249</td>
<td style="text-align: right;">158</td>
<td style="text-align: right;">84</td>
</tr>
</tbody>
</table>
</div>
</div>
<p>This data frame is not in tidy format. What would it look like if it were?</p>
<div class="webex-solution">
<button>
I need a hint
</button>
<p>Think of these data as being in a wide format. What variables in this data set could be placed in different columns?</p>
</div>
<!-- note: you could also just set webex.hide to TRUE -->
<div class="cell" data-webex.hide="See the solution">
<div class="webex-solution">
<button>
See the solution
</button>
<div class="cell-output-display">
<table class="table table-sm table-striped small">
<thead><tr class="header">
<th style="text-align: left;">country</th>
<th style="text-align: left;">beverages type</th>
<th style="text-align: right;">number of servings</th>
</tr></thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">Canada</td>
<td style="text-align: left;">beer_servings</td>
<td style="text-align: right;">240</td>
</tr>
<tr class="even">
<td style="text-align: left;">South Korea</td>
<td style="text-align: left;">beer_servings</td>
<td style="text-align: right;">140</td>
</tr>
<tr class="odd">
<td style="text-align: left;">USA</td>
<td style="text-align: left;">beer_servings</td>
<td style="text-align: right;">249</td>
</tr>
<tr class="even">
<td style="text-align: left;">Canada</td>
<td style="text-align: left;">spirit_servings</td>
<td style="text-align: right;">122</td>
</tr>
<tr class="odd">
<td style="text-align: left;">South Korea</td>
<td style="text-align: left;">spirit_servings</td>
<td style="text-align: right;">16</td>
</tr>
<tr class="even">
<td style="text-align: left;">USA</td>
<td style="text-align: left;">spirit_servings</td>
<td style="text-align: right;">158</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Canada</td>
<td style="text-align: left;">wine_servings</td>
<td style="text-align: right;">100</td>
</tr>
<tr class="even">
<td style="text-align: left;">South Korea</td>
<td style="text-align: left;">wine_servings</td>
<td style="text-align: right;">9</td>
</tr>
<tr class="odd">
<td style="text-align: left;">USA</td>
<td style="text-align: left;">wine_servings</td>
<td style="text-align: right;">84</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
</div>
</div>
</section><section id="tidying" class="level1" data-number="4"><h1 data-number="4">
<span class="header-section-number">4</span> Converting to <strong>tidy</strong> data format</h1>
<p>In this section, we will see how to convert a data set that is not in the <strong>tidy</strong> format i.e.&nbsp;<a href="https://en.wikipedia.org/wiki/Wide_and_narrow_data">wide</a> format, to a data set that is in the <strong>tidy</strong> format i.e.&nbsp;<a href="https://en.wikipedia.org/wiki/Wide_and_narrow_data#Narrow">long/narrow</a> format.</p>
<p>First, let’s download a <strong>Comma Separated Values</strong> (CSV) file of ratings of the level of democracy in different countries spanning 1952 to 1992: <a href="https://moderndive.com/data/dem_score.csv" class="uri">https://moderndive.com/data/dem_score.csv</a>. We use the <code><a href="https://readr.tidyverse.org/reference/read_delim.html">read_csv()</a></code> function from the <code>readr</code> package to read it off the web:</p>
<div class="cell">
<details class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb6"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">dem_score</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://readr.tidyverse.org/reference/read_delim.html">read_csv</a></span><span class="op">(</span><span class="st">"https://moderndive.com/data/dem_score.csv"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>Please refer back to your <strong>R programming</strong> course for an overview of how to import spreadsheets and <code>.csv</code> files into R.</p>
</div>
</div>
<p>In this <code>dem_score</code> data frame, the minimum value of -10 corresponds to a highly autocratic nation whereas a value of 10 corresponds to a highly democratic nation. Let’s use the <code>dem_score</code> data frame but focus on only data corresponding to the country of Guatemala.</p>
<div class="cell">
<details open="" class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb7"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">guat_dem</span> <span class="op">&lt;-</span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">dem_score</span>,<span class="va">country</span> <span class="op">==</span> <span class="st">"Guatemala"</span><span class="op">)</span></span>
<span><span class="va">guat_dem</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code># A tibble: 1 × 10
  country   `1952` `1957` `1962` `1967` `1972` `1977` `1982` `1987` `1992`
  &lt;chr&gt;      &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;
1 Guatemala      2     -6     -5      3      1     -3     -7      3      3</code></pre>
</div>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>Here we have used the <code>filter</code> function from <code>dplyr</code> package to subset the data set. We will revisit this code for subsetting data later in the session.</p>
</div>
</div>
<p>In order for this data set to be on a <strong>tidy</strong> format, we need to take the values of the current column names in <code>guat_dem</code> (aside from <code>country</code>) and convert them into a new variable that will act as a key called <code>year</code>. Then, we’d like to take the numbers on the inside of the table and turn them into a column that will act as values called <code>democracy_score</code>. Our resulting data frame will have three columns: <code>country</code>, <code>year</code>, and <code>democracy_score</code>.</p>
<p>The <code>pivot_longer</code> function in the <code>tidyr</code> package can complete this task for us. The first argument to <code>pivot_longer</code>, is the <code>data</code> argument where we specify which data frame we would like to tidy. The next argument to <code>pivot_longer</code> is <code>cols</code> which specifies which columns we want to pivot into the longer format.</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>There are helper functions which help us declaring which variable (or variables) we want to pivot&nbsp;<code>!</code>,<code>start_with</code>,&nbsp;<code>last_col</code>,&nbsp;<code>everything</code>,&nbsp;<code>contains</code>, etc. E.g. <code>!country</code> will the tell the function that all the variables except for <code>country</code> should be included in the pivoting process.</p>
</div>
</div>
<p>The next two arguments <code>names_to</code> and <code>values_to</code>, specify what we would like to call the new columns that convert our wide data into tidy/long format.</p>
<div class="cell">
<details open="" class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb9"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">guat_dem_long</span> <span class="op">=</span> <span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_longer.html">pivot_longer</a></span><span class="op">(</span><span class="va">guat_dem</span>,cols <span class="op">=</span> <span class="op">!</span><span class="va">country</span>,</span>
<span>                             names_to <span class="op">=</span> <span class="st">"year"</span>,</span>
<span>                             values_to <span class="op">=</span> <span class="st">"democracy_score"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/slice.html">slice</a></span><span class="op">(</span><span class="va">guat_dem_long</span>,<span class="fl">1</span><span class="op">:</span><span class="fl">5</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code># A tibble: 5 × 3
  country   year  democracy_score
  &lt;chr&gt;     &lt;chr&gt;           &lt;dbl&gt;
1 Guatemala 1952                2
2 Guatemala 1957               -6
3 Guatemala 1962               -5
4 Guatemala 1967                3
5 Guatemala 1972                1</code></pre>
</div>
</div>
<p>The inverse transformation of <code><a href="https://tidyr.tidyverse.org/reference/pivot_longer.html">pivot_longer()</a></code> is of course, <code><a href="https://tidyr.tidyverse.org/reference/pivot_wider.html">pivot_wider()</a></code> and allows us to pivot from a long to a wide format. As arguments we need to provide which column (or columns) to get the name of the output column (<code>names_from</code>), and which column (or columns) to get the cell values from (<code>values_from</code>). For instance, if want the data from the previous example to go back to a wide-format, we can use the following code:</p>
<div class="cell">
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">guat_dem_wide</span> <span class="op">=</span> <span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_wider.html">pivot_wider</a></span><span class="op">(</span><span class="va">guat_dem_long</span>,</span>
<span>                            names_from <span class="op">=</span> <span class="va">year</span>, </span>
<span>                            values_from <span class="op">=</span> <span class="va">democracy_score</span><span class="op">)</span></span>
<span><span class="va">guat_dem_wide</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 1 × 10
  country   `1952` `1957` `1962` `1967` `1972` `1977` `1982` `1987` `1992`
  &lt;chr&gt;      &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;
1 Guatemala      2     -6     -5      3      1     -3     -7      3      3</code></pre>
</div>
</div>
<div class="callout callout-style-default callout-warning no-icon callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<i class="bi-pencil-square " style="color: #c8793c;" role="img" aria-hidden="true"></i> Task
</div>
</div>
<div class="callout-body-container callout-body">
<p>The information about drink consumption across countries is available on the <code>drinks</code> data set in the <code>fivethirtyeight</code> library:</p>
<div class="cell">
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/rudeboybert/fivethirtyeight">fivethirtyeight</a></span><span class="op">)</span></span>
<span><span class="va">drinks</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="cell-output-display">
<table class="table table-sm table-striped small">
<colgroup>
<col style="width: 14%">
<col style="width: 16%">
<col style="width: 18%">
<col style="width: 16%">
<col style="width: 34%">
</colgroup>
<thead><tr class="header">
<th style="text-align: left;">country</th>
<th style="text-align: right;">beer_servings</th>
<th style="text-align: right;">spirit_servings</th>
<th style="text-align: right;">wine_servings</th>
<th style="text-align: right;">total_litres_of_pure_alcohol</th>
</tr></thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">Afghanistan</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0.0</td>
</tr>
<tr class="even">
<td style="text-align: left;">Albania</td>
<td style="text-align: right;">89</td>
<td style="text-align: right;">132</td>
<td style="text-align: right;">54</td>
<td style="text-align: right;">4.9</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Algeria</td>
<td style="text-align: right;">25</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">14</td>
<td style="text-align: right;">0.7</td>
</tr>
</tbody>
</table>
</div>
</div>
<p>Convert this data frame to tidy data (long) format by pivoting the variables related to the servings of beer, spirits and wine. Name the new type of beverage column as <code>beverages type</code> and the servings as <code>number of servings</code>.</p>
<div class="webex-solution">
<button>
Take hint
</button>
<p>Your new data frame should contain 4 columns: <code>country</code>, <code>total_litres_of_pure_alcohol</code>, <code>beverages type</code> and <code>number of servings</code>. You can use the <code><a href="https://tidyselect.r-lib.org/reference/starts_with.html">ends_with()</a></code> function to match variables according to a given pattern.</p>
</div>
<div class="cell" data-webex.hide="Click here to see the solution">
<div class="webex-solution">
<button>
Click here to see the solution
</button>
<details open="" class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb14"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># There are multiples ways of doing this:</span></span>
<span></span>
<span><span class="co"># (1) We can explicitly declare which variable we don't want to pivot</span></span>
<span></span>
<span><span class="va">drinks</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_longer.html">pivot_longer</a></span><span class="op">(</span>cols <span class="op">=</span> <span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">country</span>,<span class="va">total_litres_of_pure_alcohol</span><span class="op">)</span>,</span>
<span>               names_to <span class="op">=</span> <span class="st">"beverages type"</span>,</span>
<span>               values_to <span class="op">=</span> <span class="st">"number of servings"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># (2) use a helper function to select the variables that end with the word "servings"</span></span>
<span></span>
<span><span class="va">drinks</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_longer.html">pivot_longer</a></span><span class="op">(</span>cols <span class="op">=</span> <span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html">ends_with</a></span><span class="op">(</span><span class="st">"servings"</span><span class="op">)</span>,</span>
<span>               names_to <span class="op">=</span> <span class="st">"beverages type"</span>,</span>
<span>               values_to <span class="op">=</span> <span class="st">"number of servings"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</div>
</div>
</div>
</section><section id="reminder-of-ggplot" class="level1" data-number="5"><h1 data-number="5">
<span class="header-section-number">5</span> Reminder of ggplot</h1>
<p>Now that we have our data on a tidy format we can use <code>ggplot2</code> to produce a plot showing how the democracy scores have changed over the 40 years from 1952 to 1992 for Guatemala. Lets have a reminder of how we can do this using the ggplot.</p>
<p>First, we need to pass our data to the <code><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot()</a></code> function and then add layers that can combines data, aesthetic mapping, a geom (geometric object), a stat (statistical transformation), and a position adjustment.</p>
<p>Let’s start by laying out how we would map our aesthetics to variables in the data frame:</p>
<ul>
<li>The <code>data</code> frame is <code>guat_dem_long</code> so we use <code>data = guat_dem_long</code>.</li>
<li>The mapping of the coordinates for the axes using <code>aes(x = year, y = democracy_score)</code>, where <code><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes()</a></code> relates to the plots aesthetics. That is,
<ul>
<li>
<code>year</code> maps to the <code>x</code> coordinate.</li>
<li>
<code>democracy_score</code> maps to the <code>y</code> coordinate.</li>
</ul>
</li>
</ul>
<p>Now we need to add an additional layer using the <code>+</code> command. Lets include a points layer first:</p>
<div class="cell" data-layout-align="center">
<details open="" class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb15"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">guat_dem_long</span>, mapping <span class="op">=</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">year</span>, y <span class="op">=</span> <span class="va">democracy_score</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><img src="notes_24_25_files/figure-html/unnamed-chunk-17-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="384"></p>
</figure>
</div>
</div>
</div>
<p>When adding layers using <code>ggplot</code> it should be noted that:</p>
<ul>
<li>the <code>+</code> command should come at the end of lines, otherwise R will produce an error.</li>
<li>when adding additional layers it is a good idea to take a new line after each <code>+</code> command. This is so your code will be nice and clear with each layer given its own line of code. This is handy for code debugging.</li>
</ul>
<p>Now we add a line connecting each point:</p>
<div class="cell" data-layout-align="center">
<details open="" class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb16"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">guat_dem_long</span>, mapping <span class="op">=</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">year</span>, y <span class="op">=</span> <span class="va">democracy_score</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span><span class="op">(</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stderr">
<pre><code>`geom_line()`: Each group consists of only one observation.
ℹ Do you need to adjust the group aesthetic?</code></pre>
</div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><img src="notes_24_25_files/figure-html/unnamed-chunk-18-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="384"></p>
</figure>
</div>
</div>
</div>
<p><strong>What happened?</strong> Note that the <code>year</code> variable in <code>guat_dem_long</code> is stored as a character vector since we had to circumvent the naming rules in R by adding backticks around the different year columns in <code>guat_dem_long</code>. This is leading to <code>ggplot</code> not knowing exactly how to plot a line using a categorical variable. We can fix this by using the <code>parse_number</code> function in the <code>readr</code> package:</p>
<div class="cell" data-layout-align="center">
<details class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb18"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">guat_dem_long</span>, mapping <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="fu"><a href="https://readr.tidyverse.org/reference/parse_number.html">parse_number</a></span><span class="op">(</span><span class="va">year</span><span class="op">)</span>, y <span class="op">=</span> <span class="va">democracy_score</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>   <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span><span class="op">(</span><span class="op">)</span><span class="op">+</span></span>
<span>   <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><img src="notes_24_25_files/figure-html/unnamed-chunk-19-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="384"></p>
</figure>
</div>
</div>
</div>
<p>We’ll see later how we could use the <code>mutate</code> function to change <code>year</code> to be a numeric variable during the tidying process (alternatively we could have added the argument <code>names_transform = list(year = as.integer)</code> in the <code><a href="https://tidyr.tidyverse.org/reference/pivot_longer.html">pivot_longer()</a></code> function to declare the <code>year</code> column values as an integers; see <code><a href="https://tidyr.tidyverse.org/reference/pivot_longer.html">?pivot_longer</a></code> for more details).</p>
<p>As a final step we can change the axes labels and include a title on our plot by adding another layer as follows:</p>
<div class="cell" data-layout-align="center">
<details class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb19"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">guat_dem_long</span>, mapping <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="fu"><a href="https://readr.tidyverse.org/reference/parse_number.html">parse_number</a></span><span class="op">(</span><span class="va">year</span><span class="op">)</span>, y <span class="op">=</span> <span class="va">democracy_score</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>   <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span><span class="op">(</span><span class="op">)</span><span class="op">+</span></span>
<span>   <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span><span class="op">(</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span>x <span class="op">=</span> <span class="st">"year"</span>, y <span class="op">=</span> <span class="st">"Democracy score"</span>,</span>
<span>       title <span class="op">=</span> <span class="st">"Guatemala's democracy score ratings from 1952 to 1992"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><img src="notes_24_25_files/figure-html/unnamed-chunk-20-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="384"></p>
</figure>
</div>
</div>
</div>
</section><section id="wrangling" class="level1" data-number="6"><h1 data-number="6">
<span class="header-section-number">6</span> Data wrangling</h1>
<p>We are now able to import data and perform basic operations on the data to get it into the <strong>tidy</strong> format. In this and subsequent sections we will use tools from the <code>dplyr</code> package (included in <code>tidyverse</code>) to perform data <strong>wrangling</strong> which includes transforming, mapping and summarising variables.</p>
<section id="piping" class="level2" data-number="6.1"><h2 data-number="6.1" class="anchored" data-anchor-id="piping">
<span class="header-section-number">6.1</span> The pipe %&gt;%</h2>
<p>Before we dig into data wrangling, let’s first introduce the pipe operator (<code>%&gt;%</code>). Just as the <code>+</code> sign was used to add layers to a plot created using <code>ggplot</code>, the pipe operator allows us to chain together data wrangling functions. The pipe operator can be read as <strong>then</strong>.</p>
<p>The piping syntax will be our major focus throughout the rest of this course and you’ll find that you’ll quickly be addicted to the chaining with some practice.</p>
</section><section id="verbs" class="level2" data-number="6.2"><h2 data-number="6.2" class="anchored" data-anchor-id="verbs">
<span class="header-section-number">6.2</span> Data wrangling verbs</h2>
<p>The <code>d</code> in <code>dplyr</code> stands for data frames, so the functions in <code>dplyr</code> are built for working with objects of the data frame type. In your previous <strong>R programming</strong> course you have already covered some of the most commonly used functions/verbs for wrangling and summarising data (i.e.&nbsp;<code>filter</code>, <code>summarise</code> and <code>group_by</code>). Thus, on this session we won’t review these deeply (for more details of how these verbs work please refer back to your <strong>R programming</strong> course) but rather we will introduce new verbs that you might not have seen before. Here is a description of some of these verbs:</p>
<ol type="1">
<li><p><code>select</code>: Select variables in a data frame</p></li>
<li><p><code>filter</code>: Pick rows based on conditions about their values</p></li>
<li><p><code>summarize</code>: Compute summary measures known as “summary statistics” of variables</p></li>
<li><p><code>group_by</code>: Group rows of observations together</p></li>
<li><p><code>mutate</code>: Create a new variable in the data frame by mutating existing ones</p></li>
<li><p><code>join</code>: Join/merge two data frames by matching along a “key” variable. There are many different <code>join</code> available. Here, we will focus on the <code>inner_join</code> function.</p></li>
</ol>
<p>All of the verbs are used similarly where you: take a data frame, pipe it using the <code>%&gt;%</code> syntax into one of the verbs above followed by other arguments specifying which criteria you would like the verb to work with in parentheses.</p>
</section><section id="select-and-rename-columns" class="level2" data-number="6.3"><h2 data-number="6.3" class="anchored" data-anchor-id="select-and-rename-columns">
<span class="header-section-number">6.3</span> Select and rename columns</h2>
<div class="cell">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><img src="select.png" class="img-fluid figure-img"></p>
<figcaption>Select diagram from Data Wrangling with dplyr and tidyr cheatsheet.</figcaption></figure>
</div>
</div>
</div>
<p>We’ve seen that the <code>flights</code> data frame in the <code>nycflights13</code> package contains many different variables. The <code>names</code> function gives a listing of all the columns in a data frame; in our case you would run <code>names(flights)</code>. However, say you only want to consider two of these variables, <code>carrier</code> and <code>flight</code>. You can <code>select</code> these as follows:</p>
<div class="cell">
<details open="" class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb20"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">flights</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">carrier</span>, <span class="va">flight</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell">
<div class="cell-output-display">
<table class="table table-sm table-striped small">
<thead><tr class="header">
<th style="text-align: left;">carrier</th>
<th style="text-align: right;">flight</th>
</tr></thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">UA</td>
<td style="text-align: right;">1545</td>
</tr>
<tr class="even">
<td style="text-align: left;">UA</td>
<td style="text-align: right;">1714</td>
</tr>
<tr class="odd">
<td style="text-align: left;">AA</td>
<td style="text-align: right;">1141</td>
</tr>
<tr class="even">
<td style="text-align: left;">B6</td>
<td style="text-align: right;">725</td>
</tr>
<tr class="odd">
<td style="text-align: left;">DL</td>
<td style="text-align: right;">461</td>
</tr>
</tbody>
</table>
</div>
</div>
<p>The <code>select</code> function allows a subset of columns to be extracted, making navigation data sets with a very large number of variables easier.</p>
<p>Reversely, one can exclude specific columns via negative selection (using -). For instance, in the <code>flights</code> data set, the <code>year</code> variable isn’t really a variable here in that it doesn’t vary (the <code>flights</code> data set actually comes from a larger data set that covers many years). Thus, we may want to remove the <code>year</code> variable from our data set since it won’t be helpful for analysis in this case. We can deselect <code>year</code> by using the <code>-</code> sign:</p>
<div class="cell">
<details open="" class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb21"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">flights_no_year</span> <span class="op">&lt;-</span> <span class="va">flights</span>  <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="op">-</span><span class="va">year</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>The <code>select</code> function can also be used to reorder columns in combination with the <code>everything</code> helper function. Let’s suppose we would like the <code>hour</code>, <code>minute</code>, and <code>time_hour</code> variables, which appear at the end of the <code>flights</code> data set, to actually appear immediately after the <code>day</code> variable:</p>
<div class="cell">
<details open="" class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb22"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">flights_reorder</span> <span class="op">&lt;-</span> <span class="va">flights</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">month</span><span class="op">:</span><span class="va">day</span>, <span class="va">hour</span><span class="op">:</span><span class="va">time_hour</span>, <span class="fu"><a href="https://tidyselect.r-lib.org/reference/everything.html">everything</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">flights_reorder</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code> [1] "month"          "day"            "hour"           "minute"        
 [5] "time_hour"      "year"           "dep_time"       "sched_dep_time"
 [9] "dep_delay"      "arr_time"       "sched_arr_time" "arr_delay"     
[13] "carrier"        "flight"         "tailnum"        "origin"        
[17] "dest"           "air_time"       "distance"      </code></pre>
</div>
</div>
<p>in this case <code><a href="https://tidyselect.r-lib.org/reference/everything.html">everything()</a></code> picks up all remaining variables.</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>Alternatively we could use the <code><a href="https://dplyr.tidyverse.org/reference/relocate.html">relocate()</a></code> verb to change column positions, using the same syntax as <code><a href="https://dplyr.tidyverse.org/reference/select.html">select()</a></code> to make it easy to move blocks of columns at once. We will see an example of this in the next section.</p>
</div>
</div>
<p>Lastly, the helper functions <code>starts_with</code>, <code>ends_with</code>, and <code>contains</code> can be used to choose <strong>variables / column names</strong> that match those conditions.</p>
<div class="callout callout-style-default callout-warning no-icon callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<i class="bi-pencil-square " style="color: #c8793c;" role="img" aria-hidden="true"></i> Task
</div>
</div>
<div class="callout-body-container callout-body">
<ul>
<li><p>Use <code>starts_with</code> helper function to select the arrival time and arrival delay columns from the <code>flights</code> data frame.</p></li>
<li><p>Use <code>ends_with</code> to select departure and arrival delay columns from the <code>flights</code> data frame.</p></li>
<li><p>Use <code>contains</code> to select columns to select departure times, schedule departure and departure delay columns from the <code>flights</code> data frame.</p></li>
</ul>
<div class="webex-solution">
<button>
Take hint
</button>
<p>In the <code>flights</code> data frame arrival time and arrival delay columns all begin with the <code>arr</code> character, while departure and arrival delay columns end with the <code>delay</code> character. Lastly, departure times, schedule departure and departure delay columns all contain the <code>dep</code> characters</p>
</div>
<div class="cell" data-webex.hide="Click here to see the solution">
<div class="webex-solution">
<button>
Click here to see the solution
</button>
<details open="" class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb24"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Select arrival time and arrival delay columns</span></span>
<span><span class="va">flights</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html">starts_with</a></span><span class="op">(</span><span class="st">"arr"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/slice.html">slice</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">3</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code># A tibble: 3 × 2
  arr_time arr_delay
     &lt;int&gt;     &lt;dbl&gt;
1      830        11
2      850        20
3      923        33</code></pre>
</div>
<details open="" class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb26"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Select departure and arrival delay columns</span></span>
<span><span class="va">flights</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html">ends_with</a></span><span class="op">(</span><span class="st">"delay"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/slice.html">slice</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">3</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code># A tibble: 3 × 2
  dep_delay arr_delay
      &lt;dbl&gt;     &lt;dbl&gt;
1         2        11
2         4        20
3         2        33</code></pre>
</div>
<details open="" class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb28"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Select departure times, schedule departure and departure delay columns</span></span>
<span><span class="va">flights</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html">contains</a></span><span class="op">(</span><span class="st">"dep"</span><span class="op">)</span><span class="op">)</span><span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/slice.html">slice</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">3</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code># A tibble: 3 × 3
  dep_time sched_dep_time dep_delay
     &lt;int&gt;          &lt;int&gt;     &lt;dbl&gt;
1      517            515         2
2      533            529         4
3      542            540         2</code></pre>
</div>
</div>
</div>
</div>
</div>
<p>Finally, if we want to rename a column while preserving the other columns we can use the <code>rename</code> function. Suppose we wanted <code>dep_time</code> and <code>arr_time</code> to be <code>departure_time</code> and <code>arrival_time</code> instead in the <code>flights_time</code> data frame:</p>
<div class="cell">
<details open="" class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb30"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">flights_time</span> <span class="op">&lt;-</span> <span class="va">flights</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html">contains</a></span><span class="op">(</span><span class="st">"time"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html">rename</a></span><span class="op">(</span>departure_time <span class="op">=</span> <span class="va">dep_time</span>, arrival_time <span class="op">=</span> <span class="va">arr_time</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">flights_time</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code>[1] "departure_time" "sched_dep_time" "arrival_time"   "sched_arr_time"
[5] "air_time"       "time_hour"     </code></pre>
</div>
</div>
<p>Note that in this case we used a single <code>=</code> sign with <code>rename</code>. e.g,. <code>departure_time = dep_time</code>. This is because we are not testing for equality like we would using <code>==</code>, but instead we want to assign a new variable <code>departure_time</code> to have the same values as <code>dep_time</code> and then delete the variable <code>dep_time</code>.</p>
</section><section id="filter" class="level2" data-number="6.4"><h2 data-number="6.4" class="anchored" data-anchor-id="filter">
<span class="header-section-number">6.4</span> Filter observations using filter</h2>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure"><p><img src="filter.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>The <code>filter</code> function allows you to specify criteria about values of a variable in your data set and then chooses only those rows that match that criteria.</p>
<div class="callout callout-style-default callout-important callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Important
</div>
</div>
<div class="callout-body-container callout-body">
<p>Recall that the base R has already a filter function defined. So make sure to avoid any conflicts either by calling <code><a href="https://dplyr.tidyverse.org/reference/filter.html">dplyr::filter()</a></code> every time you use the function (specially if you have loaded the <code>conflicts</code> library) or alternatively run the<code>conflict_prefer()</code> function to let R know that it should use <code>dplyr</code>’s <code>filter</code> function as default.</p>
<div class="cell">
<details open="" class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb32"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">conflict_prefer</span><span class="op">(</span><span class="st">"filter"</span>, <span class="st">"dplyr"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stderr">
<pre><code>[conflicted] Will prefer dplyr::filter over any other package.</code></pre>
</div>
</div>
</div>
</div>
<p>Since you have already covered this in your <strong>R programming course</strong>, let’s begin straight away by focusing only at <em>Alaska Airlines</em> flights leaving from New York City in 2013. We can combine the data wrangling output with ggplot plotting techniques. Run the following code and look at the resulting scatterplot.</p>
<div class="cell" data-layout-align="center">
<details open="" class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb34"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">flights</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">carrier</span> <span class="op">==</span>  <span class="st">"AS"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">dep_delay</span>, y <span class="op">=</span> <span class="va">arr_delay</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span><span class="op">(</span><span class="op">)</span><span class="op">+</span></span>
<span>   <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span>x <span class="op">=</span> <span class="st">"Departure delay (minutes)"</span>, y <span class="op">=</span> <span class="st">"Arrival delay (minutes)"</span>,</span>
<span>       title <span class="op">=</span> <span class="st">"Alaska Airlines flights leaving NYC in 2013"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><img src="notes_24_25_files/figure-html/unnamed-chunk-29-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="480"></p>
</figure>
</div>
</div>
</div>
<p>Here is an explanation of what we’ve just did:</p>
<ul>
<li>Take the data frame <code>flights</code> <strong>then</strong>
</li>
<li>
<code>filter</code> the data frame so that only those where the <code>carrier</code> equals <code>AS</code> are included. (recall that the double equals sign <code>==</code> tests equality, and not a single equals sign <code>=</code>).</li>
<li>pass the filtered data to the ggplot function and add a point layer and then modify axis labels.</li>
</ul>
<p>You can combine multiple criteria together using operators that make comparisons:</p>
<ul>
<li>
<code>|</code> corresponds to <strong>or</strong>
</li>
<li>
<code>&amp;</code> corresponds to <strong>and</strong>
</li>
</ul>
<p>We can often skip the use of <code>&amp;</code> and just separate our conditions with a comma. You’ll see this in the example below.</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>In addition, you can use other mathematical checks (similar to <code>==</code>):</p>
<ul>
<li><p><code>&gt;</code> corresponds to <strong>greater than</strong></p></li>
<li><p><code>&lt;</code> corresponds to <strong>less than</strong></p></li>
<li><p><code>&gt;=</code> corresponds to <strong>greater than or equal to</strong></p></li>
<li><p><code>&lt;=</code> corresponds to <strong>less than or equal to</strong></p></li>
<li><p><code>!=</code> corresponds to <strong>not equal to</strong></p></li>
</ul>
</div>
</div>
<p>To see many of these in action, let’s select all flights that left JFK airport heading to Burlington, Vermont (<code>BTV</code>) or Seattle, Washington (<code>SEA</code>) in the months of October, November, or December. Run the following:</p>
<div class="cell">
<details open="" class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb35"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">btv_sea_flights_fall</span> <span class="op">&lt;-</span> <span class="va">flights</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">origin</span> <span class="op">==</span> <span class="st">"JFK"</span>, <span class="op">(</span><span class="va">dest</span> <span class="op">==</span> <span class="st">"BTV"</span> <span class="op">|</span> <span class="va">dest</span> <span class="op">==</span> <span class="st">"SEA"</span><span class="op">)</span>, <span class="va">month</span> <span class="op">&gt;=</span> <span class="fl">10</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/relocate.html">relocate</a></span><span class="op">(</span><span class="va">dest</span>,.before <span class="op">=</span> <span class="va">dep_time</span> <span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell">
<div class="cell-output-display">
<table class="table table-sm table-striped small">
<colgroup>
<col style="width: 2%">
<col style="width: 3%">
<col style="width: 2%">
<col style="width: 2%">
<col style="width: 5%">
<col style="width: 8%">
<col style="width: 5%">
<col style="width: 5%">
<col style="width: 8%">
<col style="width: 5%">
<col style="width: 4%">
<col style="width: 4%">
<col style="width: 4%">
<col style="width: 4%">
<col style="width: 5%">
<col style="width: 5%">
<col style="width: 2%">
<col style="width: 4%">
<col style="width: 11%">
</colgroup>
<thead><tr class="header">
<th style="text-align: right;">year</th>
<th style="text-align: right;">month</th>
<th style="text-align: right;">day</th>
<th style="text-align: left;">dest</th>
<th style="text-align: right;">dep_time</th>
<th style="text-align: right;">sched_dep_time</th>
<th style="text-align: right;">dep_delay</th>
<th style="text-align: right;">arr_time</th>
<th style="text-align: right;">sched_arr_time</th>
<th style="text-align: right;">arr_delay</th>
<th style="text-align: left;">carrier</th>
<th style="text-align: right;">flight</th>
<th style="text-align: left;">tailnum</th>
<th style="text-align: left;">origin</th>
<th style="text-align: right;">air_time</th>
<th style="text-align: right;">distance</th>
<th style="text-align: right;">hour</th>
<th style="text-align: right;">minute</th>
<th style="text-align: left;">time_hour</th>
</tr></thead>
<tbody>
<tr class="odd">
<td style="text-align: right;">2013</td>
<td style="text-align: right;">10</td>
<td style="text-align: right;">1</td>
<td style="text-align: left;">SEA</td>
<td style="text-align: right;">729</td>
<td style="text-align: right;">735</td>
<td style="text-align: right;">-6</td>
<td style="text-align: right;">1049</td>
<td style="text-align: right;">1040</td>
<td style="text-align: right;">9</td>
<td style="text-align: left;">DL</td>
<td style="text-align: right;">183</td>
<td style="text-align: left;">N721TW</td>
<td style="text-align: left;">JFK</td>
<td style="text-align: right;">352</td>
<td style="text-align: right;">2422</td>
<td style="text-align: right;">7</td>
<td style="text-align: right;">35</td>
<td style="text-align: left;">2013-10-01 07:00:00</td>
</tr>
<tr class="even">
<td style="text-align: right;">2013</td>
<td style="text-align: right;">10</td>
<td style="text-align: right;">1</td>
<td style="text-align: left;">SEA</td>
<td style="text-align: right;">853</td>
<td style="text-align: right;">900</td>
<td style="text-align: right;">-7</td>
<td style="text-align: right;">1217</td>
<td style="text-align: right;">1157</td>
<td style="text-align: right;">20</td>
<td style="text-align: left;">B6</td>
<td style="text-align: right;">63</td>
<td style="text-align: left;">N807JB</td>
<td style="text-align: left;">JFK</td>
<td style="text-align: right;">362</td>
<td style="text-align: right;">2422</td>
<td style="text-align: right;">9</td>
<td style="text-align: right;">0</td>
<td style="text-align: left;">2013-10-01 09:00:00</td>
</tr>
<tr class="odd">
<td style="text-align: right;">2013</td>
<td style="text-align: right;">10</td>
<td style="text-align: right;">1</td>
<td style="text-align: left;">BTV</td>
<td style="text-align: right;">916</td>
<td style="text-align: right;">925</td>
<td style="text-align: right;">-9</td>
<td style="text-align: right;">1016</td>
<td style="text-align: right;">1033</td>
<td style="text-align: right;">-17</td>
<td style="text-align: left;">B6</td>
<td style="text-align: right;">1634</td>
<td style="text-align: left;">N192JB</td>
<td style="text-align: left;">JFK</td>
<td style="text-align: right;">48</td>
<td style="text-align: right;">266</td>
<td style="text-align: right;">9</td>
<td style="text-align: right;">25</td>
<td style="text-align: left;">2013-10-01 09:00:00</td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>Even though colloquially speaking one might say “all flights leaving Burlington, Vermont <em>and</em> Seattle, Washington,” in terms of computer logical operations, we really mean “all flights leaving Burlington, Vermont <em>or</em> Seattle, Washington.” For a given row in the data, <code>dest</code> can be <code>BTV</code>, <code>SEA</code>, or something else, but not <code>BTV</code> <strong>and</strong> <code>SEA</code> at the same time. Also note that we have used the <code>relocate</code> function to change the <code>dest</code> column position to just before the <code>dep_time</code>. See <code><a href="https://dplyr.tidyverse.org/reference/relocate.html">?relocate</a></code> for further details.</p>
</div>
</div>
<p>Another example uses <code>!</code> to pick rows that <em>do not</em> match a condition. The <code>!</code> can be read as <strong>not</strong>. Here, we are selecting rows corresponding to flights that <strong>did not</strong> go to Burlington, VT or Seattle, WA.</p>
<div class="cell">
<details open="" class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb36"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">not_BTV_SEA</span> <span class="op">&lt;-</span> <span class="va">flights</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="op">!</span><span class="op">(</span><span class="va">dest</span> <span class="op">==</span> <span class="st">"BTV"</span> <span class="op">|</span> <span class="va">dest</span> <span class="op">==</span> <span class="st">"SEA"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/relocate.html">relocate</a></span><span class="op">(</span><span class="va">dest</span>,.before <span class="op">=</span> <span class="va">dep_time</span> <span class="op">)</span></span>
<span><span class="va">not_BTV_SEA</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/slice.html">slice</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">3</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code># A tibble: 3 × 19
   year month   day dest  dep_time sched_dep_time dep_delay arr_time
  &lt;int&gt; &lt;int&gt; &lt;int&gt; &lt;chr&gt;    &lt;int&gt;          &lt;int&gt;     &lt;dbl&gt;    &lt;int&gt;
1  2013     1     1 IAH        517            515         2      830
2  2013     1     1 IAH        533            529         4      850
3  2013     1     1 MIA        542            540         2      923
# ℹ 11 more variables: sched_arr_time &lt;int&gt;, arr_delay &lt;dbl&gt;, carrier &lt;chr&gt;,
#   flight &lt;int&gt;, tailnum &lt;chr&gt;, origin &lt;chr&gt;, air_time &lt;dbl&gt;, distance &lt;dbl&gt;,
#   hour &lt;dbl&gt;, minute &lt;dbl&gt;, time_hour &lt;dttm&gt;</code></pre>
</div>
</div>
<p>As a final note we point out that <code>filter</code> should often be the first verb you’ll apply to your data. This narrows down the data to just the observations your are interested in.</p>
<div class="callout callout-style-default callout-warning no-icon callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<i class="bi-pencil-square " style="color: #c8793c;" role="img" aria-hidden="true"></i> Task
</div>
</div>
<div class="callout-body-container callout-body">
<p>What is another way of using the <strong>not</strong> operator <code>!</code> to filter only the rows that are not going to Burlington, VT nor Seattle, WA in the <code>flights</code> data frame?</p>
<div class="webex-solution">
<button>
Take a hint
</button>
<p>Try using the <code>%in%</code> operator</p>
</div>
<div class="cell" data-webex.hide="Click here to see the solution">
<div class="webex-solution">
<button>
Click here to see the solution
</button>
<details open="" class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb38"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">flights</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span> <span class="op">!</span><span class="va">dest</span> <span class="op"><a href="https://rdrr.io/r/base/match.html">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"BTV"</span>,<span class="st">"SEA"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code># A tibble: 6 × 19
   year month   day dep_time sched_dep_time dep_delay arr_time sched_arr_time
  &lt;int&gt; &lt;int&gt; &lt;int&gt;    &lt;int&gt;          &lt;int&gt;     &lt;dbl&gt;    &lt;int&gt;          &lt;int&gt;
1  2013     1     1      517            515         2      830            819
2  2013     1     1      533            529         4      850            830
3  2013     1     1      542            540         2      923            850
4  2013     1     1      544            545        -1     1004           1022
5  2013     1     1      554            600        -6      812            837
6  2013     1     1      554            558        -4      740            728
# ℹ 11 more variables: arr_delay &lt;dbl&gt;, carrier &lt;chr&gt;, flight &lt;int&gt;,
#   tailnum &lt;chr&gt;, origin &lt;chr&gt;, dest &lt;chr&gt;, air_time &lt;dbl&gt;, distance &lt;dbl&gt;,
#   hour &lt;dbl&gt;, minute &lt;dbl&gt;, time_hour &lt;dttm&gt;</code></pre>
</div>
</div>
</div>
</div>
</div>
</section><section id="mutate" class="level2" data-number="6.5"><h2 data-number="6.5" class="anchored" data-anchor-id="mutate">
<span class="header-section-number">6.5</span> Create new variables/change old variables using mutate</h2>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure"><p><img src="mutate.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>When looking at the <code>flights</code> data set, there are some clear additional variables that could be calculated based on the values of variables already in the data set. Passengers are often frustrated when their flights depart late, but change their mood a bit if pilots can make up some time during the flight to get them to their destination close to when they expected to land. This is commonly referred to as “gain” and we will create this variable using the <code>mutate</code> function. Note that we will be overwriting the <code>flights</code> data frame with one including the additional variable <code>gain</code> here, or put differently, the <code>mutate</code> command outputs a new data frame which then gets saved over the original <code>flights</code> data frame.</p>
<div class="cell">
<details open="" class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb40"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">flights</span> <span class="op">&lt;-</span> <span class="va">flights</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>gain <span class="op">=</span> <span class="va">dep_delay</span> <span class="op">-</span> <span class="va">arr_delay</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Let’s take a look at <code>dep_delay</code>, <code>arr_delay</code>, and the resulting <code>gain</code> variables in our new <code>flights</code> data frame:</p>
<div class="cell">
<div class="cell-output-display">
<table class="table table-sm table-striped small">
<thead><tr class="header">
<th style="text-align: right;">dep_delay</th>
<th style="text-align: right;">arr_delay</th>
<th style="text-align: right;">gain</th>
</tr></thead>
<tbody>
<tr class="odd">
<td style="text-align: right;">2</td>
<td style="text-align: right;">11</td>
<td style="text-align: right;">-9</td>
</tr>
<tr class="even">
<td style="text-align: right;">4</td>
<td style="text-align: right;">20</td>
<td style="text-align: right;">-16</td>
</tr>
<tr class="odd">
<td style="text-align: right;">2</td>
<td style="text-align: right;">33</td>
<td style="text-align: right;">-31</td>
</tr>
<tr class="even">
<td style="text-align: right;">-1</td>
<td style="text-align: right;">-18</td>
<td style="text-align: right;">17</td>
</tr>
<tr class="odd">
<td style="text-align: right;">-6</td>
<td style="text-align: right;">-25</td>
<td style="text-align: right;">19</td>
</tr>
</tbody>
</table>
</div>
</div>
<p>The flight in the first row departed 2 minutes late but arrived 11 minutes late, so its “gained time in the air” is actually a loss of 9 minutes, hence its <code>gain</code> is <code>-9</code>. Contrast this to the flight in the fourth row which departed a minute early (<code>dep_delay</code> of <code>-1</code>) but arrived 18 minutes early (<code>arr_delay</code> of <code>-18</code>), so its “gained time in the air” is 17 minutes, hence its <code>gain</code> is <code>+17</code>.</p>
<div class="callout callout-style-default callout-tip no-icon callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<i class="bi-question-octagon " style="color: #6dc83c;" role="img" aria-hidden="true"></i> Question
</div>
</div>
<div class="callout-body-container callout-body">
<p>Why did we overwrite <code>flights</code> instead of assigning the resulting data frame to a new object, like <code>flights_with_gain</code>?</p>
<div class="webex-solution">
<button>
Answer
</button>
<p>As a rough rule of thumb, as long as you are not losing information that you might need later, it’s acceptable practice to overwrite data frames. However, if you overwrite existing variables and/or change the observational units, recovering the original information might prove difficult. In this case, it might make sense to create a new data object.</p>
</div>
</div>
</div>
<p>Let’s look at visualize this <code>gain</code> variable in the form of a histogram:</p>
<div class="cell" data-layout-align="center">
<details open="" class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb41"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">flights</span>, mapping <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">gain</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_histogram.html">geom_histogram</a></span><span class="op">(</span>color <span class="op">=</span> <span class="st">"white"</span>, bins <span class="op">=</span> <span class="fl">20</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><img src="notes_24_25_files/figure-html/unnamed-chunk-36-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="384"></p>
</figure>
</div>
</div>
</div>
<p>We can also create multiple columns at once and even refer to columns that were just created in a new column.</p>
<div class="cell">
<div class="cell-output-display">
<table class="table table-sm table-striped small">
<thead><tr class="header">
<th style="text-align: right;">gain</th>
<th style="text-align: right;">hours</th>
<th style="text-align: right;">gain_per_hour</th>
</tr></thead>
<tbody>
<tr class="odd">
<td style="text-align: right;">-9</td>
<td style="text-align: right;">3.783333</td>
<td style="text-align: right;">-2.378855</td>
</tr>
<tr class="even">
<td style="text-align: right;">-16</td>
<td style="text-align: right;">3.783333</td>
<td style="text-align: right;">-4.229075</td>
</tr>
<tr class="odd">
<td style="text-align: right;">-31</td>
<td style="text-align: right;">2.666667</td>
<td style="text-align: right;">-11.625000</td>
</tr>
<tr class="even">
<td style="text-align: right;">17</td>
<td style="text-align: right;">3.050000</td>
<td style="text-align: right;">5.573771</td>
</tr>
<tr class="odd">
<td style="text-align: right;">19</td>
<td style="text-align: right;">1.933333</td>
<td style="text-align: right;">9.827586</td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="callout callout-style-default callout-tip no-icon callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<i class="bi-question-octagon " style="color: #6dc83c;" role="img" aria-hidden="true"></i> Question
</div>
</div>
<div class="callout-body-container callout-body">
<p>What do positive values of the <code>gain</code> variable in <code>flights</code> correspond to?</p>
<p><select class="webex-select"><option value="blank"></option>
<option value="answer">Departure delays are greater than arrivals delays</option>
<option value="">Departure delays are lower than arrivals delays</option>
<option value="">Departures and arrivals delays are the same</option></select></p>
<p>What about negative values?</p>
<p><select class="webex-select"><option value="blank"></option>
<option value="">Departure delays are greater than arrivals delays</option>
<option value="answer">Departure delays are lower than arrivals delays</option>
<option value="">Departures and arrivals delays are the same</option></select></p>
<p>And what about a zero value?</p>
<p><select class="webex-select"><option value="blank"></option>
<option value="">Departure delays are greater than arrivals delays</option>
<option value="">Departuredelays are lower than arrivals delays</option>
<option value="answer">Departures and arrivals delays are the same</option></select></p>
</div>
</div>
<div class="callout callout-style-default callout-tip no-icon callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<i class="bi-question-octagon " style="color: #6dc83c;" role="img" aria-hidden="true"></i> Question
</div>
</div>
<div class="callout-body-container callout-body">
<p>Could we create the <code>dep_delay</code> and <code>arr_delay</code> columns by simply subtracting <code>dep_time</code> from <code>sched_dep_time</code> and similarly for arrivals? Try the code out and explain any differences between the result and what actually appears in <code>flights</code>.</p>
<div class="cell">
<div class="sourceCode" id="cb42"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">flights</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>dep_delay  <span class="op">=</span> <span class="va">sched_dep_time</span> <span class="op">-</span> <span class="va">dep_time</span> ,</span>
<span>         arr_delay  <span class="op">=</span> <span class="va">sched_arr_time</span>  <span class="op">-</span> <span class="va">arr_time</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="webex-solution">
<button>
Take a hint
</button>
<p>See the description of the variables <code>arr_time</code>, <code>dep_time</code>, <code>sched_dep_time</code> and <code>sched_arr_time</code> in the flights data set <code><a href="https://rdrr.io/pkg/nycflights13/man/flights.html">?flights</a></code></p>
</div>
<div class="webex-solution">
<button>
Answer
</button>
<p>The differences are due to departure and arrival times have a HHMM or HMM format. E.g., if we compute the difference between a flight scheduled to arrive by 923 and its actual arrival time at 850, the result would be a difference of 73, while in reality there was only a 33 min difference if we consider the correct time format! We will see more detials on how to work with time-date variables later on in this session.</p>
</div>
</div>
</div>
</section><section id="summarize" class="level2" data-number="6.6"><h2 data-number="6.6" class="anchored" data-anchor-id="summarize">
<span class="header-section-number">6.6</span> Summarise variables using summarize</h2>
<p>The next common task is to be able to summarise data: take a large number of values and summarise them with a single value. While this may seem like a very abstract idea, something as simple as the sum, the smallest value, and the largest values are all summaries of a large number of values.</p>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure"><p><img src="summary.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>We can calculate the standard deviation and mean of the temperature variable <code>temp</code> in the <code>weather</code> data frame of <code>nycflights13</code> in one step using the <code>summarize</code> (or equivalently using the UK spelling <code>summarise</code>) function in <code>dplyr</code>. Before compute the mean it is important to notice that there are some <strong>missing values</strong> in the data. Thus, by default any time you try to summarise a number of values (using <code><a href="https://rdrr.io/r/base/mean.html">mean()</a></code> and <code><a href="https://rdrr.io/r/stats/sd.html">sd()</a></code> for example) that has one or more missing values, an <code>NA</code> will be returned.</p>
<p>You can summarise all non-missing values by setting the <code>na.rm</code> argument to TRUE (<code>rm</code> is short for remove). This will remove any <code>NA</code> missing values and only return the summary value for all non-missing values. So the code below computes the mean and standard deviation of all non-missing values. Notice how the <code>na.rm=TRUE</code> are set as arguments to the <code>mean</code> and <code>sd</code> functions, and not to the <code>summarize</code> function.</p>
<div class="cell">
<details open="" class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb43"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">summary_temp</span> <span class="op">&lt;-</span> <span class="va">weather</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarize</a></span><span class="op">(</span>mean <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">temp</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>, std_dev <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/sd.html">sd</a></span><span class="op">(</span><span class="va">temp</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">summary_temp</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code># A tibble: 1 × 2
   mean std_dev
  &lt;dbl&gt;   &lt;dbl&gt;
1  55.3    17.8</code></pre>
</div>
</div>
<!-- ::: {.callout-tip icon="false"} -->
<!-- ##  Question -->
<!-- Modify `summary_temp` from above to also use the `n` summary function: `summarize(count = n())`. What does the returned value correspond to? -->
<!-- <select class='webex-select'><option value='blank'></option><option value=''>Number of weather stations</option><option value=''>Number of columns in the data</option><option value='answer'>Sample size</option></select> -->
<!-- ::: -->
<!-- Another very useful function that allows you to summarise multiple columns is the `summarise_at()` function. Here, we can supply a vector of variables we want to summarise and a list of functions that we want to apply to each of the variables. See the following example where we compute the minimum and maximum values of temperature and relative humidity (notice that we also specified the argument `na.rm=T` to remove missing values - this arguments gets passed on to all the functions in the list): -->
<!-- ```{r} -->
<!-- #| echo: false -->
<!-- #| eval: false -->
<!-- weather %>% -->
<!--   summarise_at(.vars = c("temp","humid"), -->
<!--                .funs = list(min = min, max = max), -->
<!--                na.rm = TRUE) -->
<!-- ``` -->
<div class="callout callout-style-default callout-important callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Important
</div>
</div>
<div class="callout-body-container callout-body">
<p>It is <strong>not</strong> good practice to include <code>na.rm = TRUE</code> in your summary commands by default; you should attempt to run code first without this argument as this will alert you to the presence of missing data. Only after you have identified where missing values occur and have thought about the potential issues of these should you consider using <code>na.rm = TRUE</code>.</p>
</div>
</div>
<!-- What other summary functions can we use inside the `summarize` verb? Any function in R that takes a vector of values and returns just one. Here are just a few: -->
<!-- -   `mean`: the mean (or average) -->
<!-- -   `sd`: the standard deviation, which is a measure of spread -->
<!-- -   `min` and `max`: the minimum and maximum values, respectively -->
<!-- -   `IQR`: the interquartile range -->
<!-- -   `sum`: the sum -->
<!-- -   `n`: a count of the number of rows/observations in each group. This particular summary function will make more sense when **grouping** is used in the next section. -->
<div class="callout callout-style-default callout-tip no-icon callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<i class="bi-question-octagon " style="color: #6dc83c;" role="img" aria-hidden="true"></i> Question
</div>
</div>
<div class="callout-body-container callout-body">
<p>Say a doctor is studying the effect of smoking on lung cancer for a large number of patients who have records measured at five year intervals. She notices that a large number of patients have missing data points because the patient has died, so she chooses to ignore these patients in her analysis. What is wrong with this doctor’s approach?</p>
<div id="radio_UZCAHDTMDL" class="webex-radiogroup">
<label><input type="radio" autocomplete="off" name="radio_UZCAHDTMDL" value="answer"><span>Introduces a selection bias since patient who died due to lung cancer are excluded from the analysis, leading to an underestimation of the true impact of smoking on lung cancer risk</span></label><label><input type="radio" autocomplete="off" name="radio_UZCAHDTMDL" value=""><span>There is no problem, smaller datasets with fewer missing values may require less computational resources, leading to faster processing times.</span></label><label><input type="radio" autocomplete="off" name="radio_UZCAHDTMDL" value="answer"><span>Removing patients with missing data reduces the sample size. Hence, conclusions may not be as easily generalizable to the broader population, as the excluded patients may represent a different subset with unique characteristics.</span></label><label><input type="radio" autocomplete="off" name="radio_UZCAHDTMDL" value=""><span>Removing missing values can result in a dataset with fewer errors and inconsistencies, which can lead to more accurate analyses.</span></label>
</div>
</div>
</div>
<!-- ::: {.callout-tip icon="false"} -->
<!-- ##  Question -->
<!-- Why does the code below not work? -->
<!-- ```{r} -->
<!-- #| error: true -->
<!-- #| code-fold: show -->
<!-- summary_temp <- weather %>% -->
<!--   summarize(mean = mean(temp, na.rm = TRUE)) %>% -->
<!--   summarize(std_dev = sd(temp, na.rm = TRUE)) -->
<!-- ``` -->
<!-- 
<div class='webex-solution'><button>Take hint</button>
 -->
<!-- Run the code line by line instead of all at once, and then look at the data. In other words, run `summary_temp <- weather %>% summarize(mean = mean(temp, na.rm = TRUE))` first. -->
<!-- 
</div>
 -->
<!-- 
<div class='webex-solution'><button>Answer</button>
 -->
<!-- The first line of code computes the temperature mean for the weather data set. Then, the output gets passed on to `weather %>% summarize(std_dev= sd(temp, na.rm = TRUE))`. However, the temperature value is no longer present in the first result, hence the error: `! object 'temp' not found` -->
<!-- 
</div>
 -->
<!-- ::: -->
</section><section id="groupby" class="level2" data-number="6.7"><h2 data-number="6.7" class="anchored" data-anchor-id="groupby">
<span class="header-section-number">6.7</span> Using grouping structures</h2>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure"><p><img src="group_summary.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>It is often more useful to summarise a variable based on the groupings of another variable. Let’s say we are interested in the mean and standard deviation of temperatures but <em>grouped by month</em>. Run the following code:</p>
<div class="cell">
<details open="" class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb45"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">summary_monthly_temp</span> <span class="op">&lt;-</span> <span class="va">weather</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarize</a></span><span class="op">(</span>mean <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">temp</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>            std_dev <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/sd.html">sd</a></span><span class="op">(</span><span class="va">temp</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>            .by <span class="op">=</span> <span class="va">month</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>This code is identical to the previous code that created <code>summary_temp</code>, with an extra <code>.by = month</code> added. This kind per-operation grouping allow us to do the grouping within the operation where the summarisation takes place without changing the structure of the data .</p>
<!-- ::: {#note_grouping .callout-note} -->
<!-- Previous versions of `dplyr` relied on the specification of a `group_by` function within the pipeline to do the grouping. For example, in the next line of code the `weather` data set is initially grouped by `month`and then passed as a new grouped data frame into `summarize`. Yielding to the same data frame that shows the mean and standard deviation of temperature for each month in New York City: -->
<!-- ```{r} -->
<!-- #| eval: false -->
<!-- #| code-fold: true -->
<!-- summary_monthly_temp <- weather |>  -->
<!--   group_by(month) |>  -->
<!--   summarize(mean = mean(temp, na.rm = TRUE),  -->
<!--             std_dev = sd(temp, na.rm = TRUE)) -->
<!-- ``` -->
<!-- While`group_by` doesn't change the data frame, it sets *meta-data* (data about the data), specifically the group structure of the data. If we wanted to remove this group structure meta-data, we could add the `.groups = "drop"` option. -->
<!-- ```{r} -->
<!-- #| eval: false -->
<!-- #| code-fold: show -->
<!-- summary_monthly_temp <- weather |>  -->
<!--   group_by(month) |>  -->
<!--   summarize(mean = mean(temp, na.rm = TRUE),  -->
<!--             std_dev = sd(temp, na.rm = TRUE), -->
<!--             .groups = "drop") -->
<!-- ``` -->
<!-- The advantage of using the `.by` argument is that the grouping occurs within the `summarise` function and thus the resulting data frame is no longer grouped. -->
<!-- ::: -->
<div class="callout callout-style-default callout-tip no-icon callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<i class="bi-question-octagon " style="color: #6dc83c;" role="img" aria-hidden="true"></i> Question
</div>
</div>
<div class="callout-body-container callout-body">
<p>The <code><a href="https://tidyr.tidyverse.org/reference/drop_na.html">drop_na()</a></code> function can be used in the pipeline to remove missing observations from a data set. Try running the following code to compute the mean and standard deviation of the temperature in the <code>weather</code> data set and comment on the output. Why is this different from one one we had before?</p>
<div class="cell">
<div class="sourceCode" id="cb46"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">summary_monthly_temp</span> <span class="op">&lt;-</span> <span class="va">weather</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/drop_na.html">drop_na</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarize</a></span><span class="op">(</span>mean <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">temp</span><span class="op">)</span>,</span>
<span>            std_dev <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/sd.html">sd</a></span><span class="op">(</span><span class="va">temp</span><span class="op">)</span>,</span>
<span>            .by <span class="op">=</span> <span class="va">month</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="webex-solution">
<button>
Answer
</button>
<p>The <code><a href="https://tidyr.tidyverse.org/reference/drop_na.html">drop_na()</a></code> function remove all missing observation from the data set while specifying <code>na.rm =T</code> in each summarizing function only removes the missing values for the specific variable to which the function is applied.</p>
</div>
</div>
</div>
<p>We now revisit the <code>n</code> counting summary function (see the <strong>R programming course</strong> for more details). For example, suppose we would like to get a sense for how many flights departed from each of the three airports in New York City:</p>
<div class="cell">
<details open="" class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb47"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">by_origin</span> <span class="op">&lt;-</span> <span class="va">flights</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarize</a></span><span class="op">(</span>count <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/context.html">n</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>            .by <span class="op">=</span><span class="va">origin</span><span class="op">)</span></span>
<span><span class="va">by_origin</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell">
<div class="cell-output-display">
<div>
<table class="table table-sm table-striped small" data-quarto-postprocess="true">
<thead><tr class="header">
<th style="text-align: left;" data-quarto-table-cell-role="th">origin</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">count</th>
</tr></thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">EWR</td>
<td style="text-align: right;">120835</td>
</tr>
<tr class="even">
<td style="text-align: left;">JFK</td>
<td style="text-align: right;">111279</td>
</tr>
<tr class="odd">
<td style="text-align: left;">LGA</td>
<td style="text-align: right;">104662</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<p>We see that Newark (<code>EWR</code>) had the most flights departing in 2013 followed by <code>JFK</code> and lastly by LaGuardia (<code>LGA</code>). Note, there is a subtle but important difference between <code>sum</code> and <code>n</code>. While <code>sum</code> simply adds up a large set of numbers, the latter counts the number of times each of many different values occur.</p>
<div class="callout callout-style-default callout-warning no-icon callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Task
</div>
</div>
<div class="callout-body-container callout-body">
<p>With the <code>weather</code> data set, write code to produce the mean and standard deviation temperature for each day in 2013 for NYC.</p>
<div class="webex-solution">
<button>
Take a hint
</button>
<p>See the documentation for <code><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarize()</a></code> (<code><a href="https://dplyr.tidyverse.org/reference/summarise.html">?summarize</a></code>)</p>
</div>
<div class="cell" data-webex.hide="Click here to see the solution">
<div class="webex-solution">
<button>
Click here to see the solution
</button>
<details open="" class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb48"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span> <span class="va">weather</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarize</a></span><span class="op">(</span>mean <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">temp</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>            std_dev <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/sd.html">sd</a></span><span class="op">(</span><span class="va">temp</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>            .by <span class="op">=</span> <span class="va">day</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code># A tibble: 31 × 3
     day  mean std_dev
   &lt;int&gt; &lt;dbl&gt;   &lt;dbl&gt;
 1     1  57.6    17.4
 2     2  55.7    20.2
 3     3  53.8    18.9
 4     4  54.0    18.8
 5     5  55.6    16.2
 6     6  55.7    15.6
 7     7  55.6    17.4
 8     8  55.0    17.6
 9     9  56.6    17.4
10    10  56.9    17.8
# ℹ 21 more rows</code></pre>
</div>
</div>
</div>
</div>
</div>
</section><section id="grouping-by-more-than-one-variable" class="level2" data-number="6.8"><h2 data-number="6.8" class="anchored" data-anchor-id="grouping-by-more-than-one-variable">
<span class="header-section-number">6.8</span> Grouping by more than one variable</h2>
<p>You are not limited to grouping by one variable. Say you wanted to know the number of flights leaving each of the three New York City airports <em>for each month</em>, we can also group by a second variable <code>month</code>:</p>
<div class="cell">
<details open="" class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb50"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">by_origin_monthly</span> <span class="op">&lt;-</span> <span class="va">flights</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarize</a></span><span class="op">(</span>count <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/context.html">n</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>            .by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">origin</span>, <span class="va">month</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">by_origin_monthly</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code># A tibble: 36 × 3
   origin month count
   &lt;chr&gt;  &lt;int&gt; &lt;int&gt;
 1 EWR        1  9893
 2 LGA        1  7950
 3 JFK        1  9161
 4 EWR       10 10104
 5 JFK       10  9143
 6 LGA       10  9642
 7 JFK       11  8710
 8 EWR       11  9707
 9 LGA       11  8851
10 JFK       12  9146
# ℹ 26 more rows</code></pre>
</div>
</div>
<p>We see there are 36 rows for <code>by_origin_monthly</code> because there are 12 months times 3 airports (<code>EWR</code>, <code>JFK</code>, and <code>LGA</code>). How can we visualize this information? Lets look now into different techniques for manipulation and visualizing categorical data.</p>
</section></section><section id="working-with-categorical-data" class="level1" data-number="7"><h1 data-number="7">
<span class="header-section-number">7</span> Working with categorical data</h1>
<section id="visualizing-categorical-data" class="level2" data-number="7.1"><h2 data-number="7.1" class="anchored" data-anchor-id="visualizing-categorical-data">
<span class="header-section-number">7.1</span> Visualizing categorical data</h2>
<p>Recall that barplots, or barcharts, are used to visualise the distributions of categorical variables. This essentially provides us with the frequencies of categories within a categorical variable. You can use either the raw data (e.g.&nbsp;the original <code>flights</code> data set) or the summarised data set (e.g.&nbsp;the <code>by_origin_monthly</code> data set we just created) to create barplots in <code>ggplot.</code></p>
<div class="tabset-margin-container"></div><div class="panel-tabset">
<ul class="nav nav-tabs" role="tablist">
<li class="nav-item" role="presentation"><a class="nav-link active" id="tabset-1-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-1-1" role="tab" aria-controls="tabset-1-1" aria-selected="true">Raw data and geom_bar()</a></li>
<li class="nav-item" role="presentation"><a class="nav-link" id="tabset-1-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-1-2" role="tab" aria-controls="tabset-1-2" aria-selected="false">Summarized data set and geom_col()</a></li>
</ul>
<div class="tab-content">
<div id="tabset-1-1" class="tab-pane active" role="tabpanel" aria-labelledby="tabset-1-1-tab">
<p>Here we can use a data set with variable(s) representing the categories. We can add a <code><a href="https://ggplot2.tidyverse.org/reference/geom_bar.html">geom_bar()</a></code> layer to create a barplot layer by counting the number of cases for each level of a categorical variable and use the <code>fill=origin</code> option to assign a different color to the counts based on the origin.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb52"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">flights</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span><span class="op">(</span><span class="va">month</span><span class="op">)</span>,fill<span class="op">=</span><span class="va">origin</span><span class="op">)</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_bar.html">geom_bar</a></span><span class="op">(</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_discrete.html">scale_x_discrete</a></span><span class="op">(</span>labels <span class="op">=</span> <span class="va">month.abb</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span>x<span class="op">=</span> <span class="st">"Months"</span>,y<span class="op">=</span><span class="st">"Number of flights"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><img src="notes_24_25_files/figure-html/unnamed-chunk-48-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="480"></p>
</figure>
</div>
</div>
</div>
<p>Note that the month variable in our data set is an integer. Thus, we convert this into a factor using the <code><a href="https://rdrr.io/r/base/factor.html">factor()</a></code> function directly in the aesthetic mapping. Then we provide appropriate labels for each month (<code>labels = month.abb)</code> by adding one more <code>scale_x_discrete</code>layer.</p>
</div>
<div id="tabset-1-2" class="tab-pane" role="tabpanel" aria-labelledby="tabset-1-2-tab">
<p>Here we can use a data set with variables representing the categories and the counts of each category (e.g.&nbsp;the <code>by_origin_monthly</code> data set we just created). To produce the bar plot we add a <code><a href="https://ggplot2.tidyverse.org/reference/geom_bar.html">geom_col()</a></code> layer which expects a data set that already contains the counts for each group. We use the <code>fill=origin</code> option to assign a different color to the counts based on the origin.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb53"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">by_origin_monthly</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span><span class="op">(</span><span class="va">month</span><span class="op">)</span>, y <span class="op">=</span> <span class="va">count</span>, fill<span class="op">=</span> <span class="va">origin</span> <span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_bar.html">geom_col</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_discrete.html">scale_x_discrete</a></span><span class="op">(</span>labels <span class="op">=</span> <span class="va">month.abb</span><span class="op">)</span><span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span>x<span class="op">=</span> <span class="st">"Months"</span>,y<span class="op">=</span><span class="st">"Number of flights"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><img src="notes_24_25_files/figure-html/unnamed-chunk-49-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="480"></p>
</figure>
</div>
</div>
</div>
<p>Note that the month variable in our data set is an integer. Thus, we convert this into a factor using the <code><a href="https://rdrr.io/r/base/factor.html">factor()</a></code> function directly in the aesthetic mapping. Then we provide appropriate labels for each month (<code>labels = month.abb)</code> by adding one more <code>scale_x_discrete</code>layer.</p>
</div>
</div>
</div>
<p>This is what is referred to as a <em>Stacked barplot</em> since the bars for each <code>origin</code> are simply stacked on top of one another for each of the carriers. This provides us with a visually nice barplot to present the monthly number of flights by airport of origin. However, there are also alternative barplots to the stacked barplot.</p>
<ul>
<li>One alternative to a stacked barplot is the <strong>side-by-side</strong> (or <strong>dodged</strong>) <strong>barplot</strong>, which, as suggested by its name, places the bars next to each other instead of on top of one another. This can be produced by including <code>position = 'dodge'</code> within the <code>geom_col</code> or <code>geom_bar</code> layer.</li>
</ul>
<div class="callout callout-style-default callout-tip no-icon callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<i class="bi-question-octagon " style="color: #6dc83c;" role="img" aria-hidden="true"></i> Question
</div>
</div>
<div class="callout-body-container callout-body">
How would you modify the code above to produced a <em>dodged</em> barplot?
<div class="webex-solution">
<button>
Answer
</button>
<p>Depending on the structure of your data you could change the column/bar layer to <code>geom_col(position = "dodge")</code> or <code>geom_bar(position = "dodge")</code> respectively.</p>
</div>
</div>
</div>
<ul>
<li>A second alternative is to use a <strong>faceted barplot</strong>. This can be produced by adding a <code><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html">facet_wrap()</a></code> layer to ggplot. E.g. try adding <code>facet_wrap(~ origin, ncol = 1)</code> to any of the previous barplots you have produced. The <code>facet_wrap</code> function tells ggplot that we want to separate out barplots by <code>origin</code>, and hence we use <code>~ origin</code>.</li>
</ul>
<div class="callout callout-style-default callout-warning no-icon callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Task
</div>
</div>
<div class="callout-body-container callout-body">
<p>Boxplots are useful visualisations when comparing the distribution of a numerical variable split across groups (or a categorical variable). Taking the <code>weather</code> data set, use ggplot to create a boxplot showing how the hourly temperature changes by month for each of the three different Weather stations (<code>origin</code> variable). Use a different color for each station.</p>
<div class="webex-solution">
<button>
Take a hint
</button>
<p>To create boxplots using ggplot you can use the <code>geom_boxplot</code> function. If we want to look at boxplots of a variable separately for a categorical variable then you need to declare that variable as a factor using the <code>factor</code> function.</p>
</div>
<div class="cell" data-webex.hide="Click here to see the solution">
<div class="webex-solution">
<button>
Click here to see the solution
</button>
<details open="" class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb54"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">weather</span>, mapping <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span><span class="op">(</span><span class="va">month</span><span class="op">)</span>, y <span class="op">=</span> <span class="va">temp</span>, fill <span class="op">=</span> <span class="va">origin</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_boxplot.html">geom_boxplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html">facet_wrap</a></span><span class="op">(</span><span class="op">~</span><span class="va">origin</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span>x <span class="op">=</span> <span class="st">"Month"</span>, y <span class="op">=</span> <span class="st">"Temperature (Hourly)"</span>,</span>
<span>        title <span class="op">=</span> <span class="st">"Hourly temperatures from NYC in 2013 by month"</span><span class="op">)</span>  <span class="op">+</span></span>
<span>   <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_discrete.html">scale_x_discrete</a></span><span class="op">(</span>labels <span class="op">=</span> <span class="va">month.abb</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<div>
<figure class="figure"><p><img src="notes_24_25_files/figure-html/unnamed-chunk-50-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="callout callout-style-default callout-warning no-icon callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Task
</div>
</div>
<div class="callout-body-container callout-body">
<p>By using the <code><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarise()</a></code> function, how could we identify how many flights left each of the three airports for each <code>carrier</code>? Can you create a barplot showing these results?</p>
<div class="webex-solution">
<button>
Take a hint
</button>
<p>You can count how many flights left each of the three airports by summarising the data using the <code><a href="https://dplyr.tidyverse.org/reference/context.html">n()</a></code> function while grouping by the origin and carrier. Then, you can pass the resulting data frame to <code>ggplot</code> using the pipeline command <code>%&gt;%</code> and use a <code>geom_col</code> layer as in the previous example.</p>
</div>
<div class="cell" data-webex.hide="Click here to see the solution">
<div class="webex-solution">
<button>
Click here to see the solution
</button>
<details open="" class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb55"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">flights</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarise</a></span><span class="op">(</span>count <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/context.html">n</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>            .by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">origin</span>,<span class="va">carrier</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">carrier</span>, y <span class="op">=</span> <span class="va">count</span>, fill <span class="op">=</span> <span class="va">origin</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_bar.html">geom_col</a></span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<div>
<figure class="figure"><p><img src="notes_24_25_files/figure-html/unnamed-chunk-51-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</div>
</div>
</div>
</section><section id="vectorised-if-else-thru-case_when" class="level2" data-number="7.2"><h2 data-number="7.2" class="anchored" data-anchor-id="vectorised-if-else-thru-case_when">
<span class="header-section-number">7.2</span> Vectorised if-else thru <code>case_when</code>
</h2>
<p>In many situations, we may want to represent continuous variables as discrete categories (e.g., grouping temperatures into “cold,” “warm,” and “hot” ranges). The <code>case_when</code> function provides an efficient way to handle multiple if-else statements by vectorizing them, allowing us to evaluate conditions and assign categories more cleanly and concisely. In this session, we will use <code>case_when</code> to categorize weather conditions based on meteorological data from the <code>weather</code> dataset. Let suppose that we want to categorize the temperature variable into three categories:</p>
<ul>
<li><p><strong>low</strong> for temperatures <span class="math inline">\(&lt;39.9\)</span></p></li>
<li><p><strong>medium</strong> for temperature values <span class="math inline">\(\geq 39.9\)</span> and <span class="math inline">\(\leq 70\)</span></p></li>
<li><p><strong>high</strong> for temperature values <span class="math inline">\(&gt; 70\)</span></p></li>
</ul>
<p>We can achieve this with the following code:</p>
<div class="cell">
<details open="" class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb56"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">weather</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span></span>
<span>    temp_cat <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_when.html">case_when</a></span><span class="op">(</span></span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">temp</span><span class="op">)</span> <span class="op">~</span> <span class="cn">NA</span>,</span>
<span>      <span class="va">temp</span> <span class="op">&lt;</span> <span class="fl">39.9</span> <span class="op">~</span> <span class="st">"low"</span>,</span>
<span>      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/between.html">between</a></span><span class="op">(</span><span class="va">temp</span>,<span class="fl">39.9</span> ,<span class="fl">70</span><span class="op">)</span><span class="op">~</span> <span class="st">"medium"</span>,</span>
<span>      .default <span class="op">=</span> <span class="st">"large"</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/relocate.html">relocate</a></span><span class="op">(</span><span class="va">temp</span>,<span class="va">temp_cat</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell">
<details class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb57"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">weather</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span></span>
<span>    temp_cat <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_when.html">case_when</a></span><span class="op">(</span></span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">temp</span><span class="op">)</span> <span class="op">~</span> <span class="cn">NA</span>,</span>
<span>      <span class="va">temp</span> <span class="op">&lt;</span> <span class="fl">39.9</span> <span class="op">~</span> <span class="st">"low"</span>,</span>
<span>      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/between.html">between</a></span><span class="op">(</span><span class="va">temp</span>,<span class="fl">39.9</span> ,<span class="fl">70</span><span class="op">)</span><span class="op">~</span> <span class="st">"medium"</span>,</span>
<span>      .default <span class="op">=</span> <span class="st">"large"</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/relocate.html">relocate</a></span><span class="op">(</span><span class="va">temp</span>,<span class="va">temp_cat</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/slice.html">slice</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">5</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu">kable</span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<table class="table table-sm table-striped small">
<colgroup>
<col style="width: 4%">
<col style="width: 7%">
<col style="width: 5%">
<col style="width: 3%">
<col style="width: 4%">
<col style="width: 3%">
<col style="width: 3%">
<col style="width: 4%">
<col style="width: 4%">
<col style="width: 7%">
<col style="width: 8%">
<col style="width: 7%">
<col style="width: 5%">
<col style="width: 7%">
<col style="width: 4%">
<col style="width: 15%">
</colgroup>
<thead><tr class="header">
<th style="text-align: right;">temp</th>
<th style="text-align: left;">temp_cat</th>
<th style="text-align: left;">origin</th>
<th style="text-align: right;">year</th>
<th style="text-align: right;">month</th>
<th style="text-align: right;">day</th>
<th style="text-align: right;">hour</th>
<th style="text-align: right;">dewp</th>
<th style="text-align: right;">humid</th>
<th style="text-align: right;">wind_dir</th>
<th style="text-align: right;">wind_speed</th>
<th style="text-align: right;">wind_gust</th>
<th style="text-align: right;">precip</th>
<th style="text-align: right;">pressure</th>
<th style="text-align: right;">visib</th>
<th style="text-align: left;">time_hour</th>
</tr></thead>
<tbody>
<tr class="odd">
<td style="text-align: right;">39.02</td>
<td style="text-align: left;">low</td>
<td style="text-align: left;">EWR</td>
<td style="text-align: right;">2013</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">26.06</td>
<td style="text-align: right;">59.37</td>
<td style="text-align: right;">270</td>
<td style="text-align: right;">10.35702</td>
<td style="text-align: right;">NA</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1012.0</td>
<td style="text-align: right;">10</td>
<td style="text-align: left;">2013-01-01 01:00:00</td>
</tr>
<tr class="even">
<td style="text-align: right;">39.02</td>
<td style="text-align: left;">low</td>
<td style="text-align: left;">EWR</td>
<td style="text-align: right;">2013</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">2</td>
<td style="text-align: right;">26.96</td>
<td style="text-align: right;">61.63</td>
<td style="text-align: right;">250</td>
<td style="text-align: right;">8.05546</td>
<td style="text-align: right;">NA</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1012.3</td>
<td style="text-align: right;">10</td>
<td style="text-align: left;">2013-01-01 02:00:00</td>
</tr>
<tr class="odd">
<td style="text-align: right;">39.02</td>
<td style="text-align: left;">low</td>
<td style="text-align: left;">EWR</td>
<td style="text-align: right;">2013</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">3</td>
<td style="text-align: right;">28.04</td>
<td style="text-align: right;">64.43</td>
<td style="text-align: right;">240</td>
<td style="text-align: right;">11.50780</td>
<td style="text-align: right;">NA</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1012.5</td>
<td style="text-align: right;">10</td>
<td style="text-align: left;">2013-01-01 03:00:00</td>
</tr>
<tr class="even">
<td style="text-align: right;">39.92</td>
<td style="text-align: left;">medium</td>
<td style="text-align: left;">EWR</td>
<td style="text-align: right;">2013</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">4</td>
<td style="text-align: right;">28.04</td>
<td style="text-align: right;">62.21</td>
<td style="text-align: right;">250</td>
<td style="text-align: right;">12.65858</td>
<td style="text-align: right;">NA</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1012.2</td>
<td style="text-align: right;">10</td>
<td style="text-align: left;">2013-01-01 04:00:00</td>
</tr>
<tr class="odd">
<td style="text-align: right;">39.02</td>
<td style="text-align: left;">low</td>
<td style="text-align: left;">EWR</td>
<td style="text-align: right;">2013</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">5</td>
<td style="text-align: right;">28.04</td>
<td style="text-align: right;">64.43</td>
<td style="text-align: right;">260</td>
<td style="text-align: right;">12.65858</td>
<td style="text-align: right;">NA</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1011.9</td>
<td style="text-align: right;">10</td>
<td style="text-align: left;">2013-01-01 05:00:00</td>
</tr>
</tbody>
</table>
</div>
</div>
<p>Here we use the <code>mutate</code> command to create new variable named <code>temp_cat</code>. The <code>case_when</code> will then set to <code>NA</code> those values in the original <code>temp</code> variable that are missing. Then if the values of <code>temp</code> are <span class="math inline">\(&lt; 30.9\)</span> it will assign them the label of <code>low</code>. If they lie between <span class="math inline">\(39.9\)</span> and <span class="math inline">\(70\)</span> it will assign them the label of <code>medium</code> and finally set to <code>large</code> any of the values that do not meet any of the aforementioned conditions. We can also use the function <code>relocate</code> to change the columns position so that the <code>temp</code> and <code>temp_cat</code> appears first on the data frame.</p>
<div class="callout callout-style-default callout-warning no-icon callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Task
</div>
</div>
<div class="callout-body-container callout-body">
<p>Create a new variable called <code>extreme_weather</code> that takes the value of <code>extreme</code> if the wind speed exceeds 64 mph and the temperature is less than 40°F and <code>not extreme</code> otherwise. Then, relocate this new variable along with the variables used to create it at the first columns of the data frame, and sort them out based on <code>wind_speed</code>.</p>
<div class="webex-solution">
<button>
Take a hint
</button>
<p>Use the conditional operators <code>|</code> and <code>&amp;</code> to add multiple conditions.</p>
</div>
<div class="cell" data-webex.hide="Click here to see the solution">
<div class="webex-solution">
<button>
Click here to see the solution
</button>
<details open="" class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb58"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">weather</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span></span>
<span>    extreme_weather  <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_when.html">case_when</a></span><span class="op">(</span></span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">temp</span><span class="op">)</span><span class="op">|</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">wind_speed</span><span class="op">)</span> <span class="op">~</span> <span class="cn">NA</span>,</span>
<span>      <span class="va">temp</span> <span class="op">&lt;</span> <span class="fl">40</span> <span class="op">&amp;</span> <span class="va">wind_speed</span>  <span class="op">&gt;</span> <span class="fl">64</span><span class="op">~</span> <span class="st">"extreme"</span>,</span>
<span>      .default <span class="op">=</span> <span class="st">"not extreme"</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/relocate.html">relocate</a></span><span class="op">(</span><span class="va">extreme_weather</span>,<span class="va">temp</span>,<span class="va">wind_speed</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html">arrange</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/desc.html">desc</a></span><span class="op">(</span><span class="va">wind_speed</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code># A tibble: 26,115 × 16
   extreme_weather  temp wind_speed origin  year month   day  hour  dewp humid
   &lt;chr&gt;           &lt;dbl&gt;      &lt;dbl&gt; &lt;chr&gt;  &lt;int&gt; &lt;int&gt; &lt;int&gt; &lt;int&gt; &lt;dbl&gt; &lt;dbl&gt;
 1 extreme          39.0     1048.  EWR     2013     2    12     3 27.0   61.6
 2 not extreme      57.2       42.6 EWR     2013     1    31     6 53.6   87.7
 3 not extreme      53.6       42.6 JFK     2013     1    31     4 53.1  100  
 4 not extreme      60.8       40.3 EWR     2013     1    31     4 59     93.8
 5 not extreme      59         40.3 LGA     2013     1    31     4 55.4   93.7
 6 not extreme      46.0       39.1 EWR     2013     1    31     8 30.0   53.3
 7 not extreme      41         38.0 JFK     2013     3     6    14 28.9   61.9
 8 not extreme      53.1       36.8 JFK     2013     1    31     3 52.0  100  
 9 not extreme      51.8       36.8 JFK     2013     1    31     7 46.4   81.7
10 not extreme      28.0       36.8 JFK     2013    11    24    10 -0.04  29.2
# ℹ 26,105 more rows
# ℹ 6 more variables: wind_dir &lt;dbl&gt;, wind_gust &lt;dbl&gt;, precip &lt;dbl&gt;,
#   pressure &lt;dbl&gt;, visib &lt;dbl&gt;, time_hour &lt;dttm&gt;</code></pre>
</div>
</div>
</div>
</div>
</div>
</section></section><section id="joins" class="level1" data-number="8"><h1 data-number="8">
<span class="header-section-number">8</span> Joining data frames</h1>
<p>Another common task is joining (merging) two different data sets. For example, in the <code>flights</code> data, the variable <code>carrier</code> lists the carrier code for the different flights. While <code>UA</code> and <code>AA</code> might be somewhat easy to guess for some (United and American Airlines), what are VX, HA, and B6? This information is provided in a separate data frame <code>airlines</code>.</p>
<div class="cell">
<div class="sourceCode" id="cb60"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">airlines</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="cell-output-display">
<table class="table table-sm table-striped small">
<thead><tr class="header">
<th style="text-align: left;">carrier</th>
<th style="text-align: left;">name</th>
</tr></thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">9E</td>
<td style="text-align: left;">Endeavor Air Inc.</td>
</tr>
<tr class="even">
<td style="text-align: left;">AA</td>
<td style="text-align: left;">American Airlines Inc.</td>
</tr>
<tr class="odd">
<td style="text-align: left;">AS</td>
<td style="text-align: left;">Alaska Airlines Inc.</td>
</tr>
<tr class="even">
<td style="text-align: left;">B6</td>
<td style="text-align: left;">JetBlue Airways</td>
</tr>
<tr class="odd">
<td style="text-align: left;">DL</td>
<td style="text-align: left;">Delta Air Lines Inc.</td>
</tr>
</tbody>
</table>
</div>
</div>
<p>We see that in <code>airports</code>, <code>carrier</code> is the carrier code while <code>name</code> is the full name of the airline. Using this table, we can map the carrier in the <code>flights</code> data set to its corresponding full name stored in the <code>airlines</code> data. However, will we have to continually look up the carrier’s name for each flight in the <code>airlines</code> data set?</p>
<p>No! Instead of having to do this manually, we can have R automatically do the “looking up” for us.</p>
<p>Note that the values in the variable <code>carrier</code> in <code>flights</code> match the values in the variable <code>carrier</code> in <code>airlines</code>. In this case, we can use the variable <code>carrier</code> as a <em>key variable</em> to join/merge/match the two data frames by. Key variables are almost always identification variables that uniquely identify the observational units. This ensures that rows in both data frames are appropriately matched during the join. This diagram helps us understand how the different data sets are linked by various key variables:</p>
<div class="cell">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><img src="relational-nycflights.png" class="img-fluid figure-img"></p>
<figcaption>Data relationships in nycflights13 from R for Data Science, Hadley and Garrett (2016).</figcaption></figure>
</div>
</div>
</div>
<section id="joining-by-key-variables" class="level2" data-number="8.1"><h2 data-number="8.1" class="anchored" data-anchor-id="joining-by-key-variables">
<span class="header-section-number">8.1</span> Joining by “key” variables</h2>
<p>In both <code>flights</code> and <code>airlines</code>, the key variable we want to join/merge/match the two data frames with has the same name in both data sets: <code>carriers</code>. We make use of the <code>inner_join</code> function to join by the variable <code>carrier</code>.</p>
<div class="cell">
<details open="" class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb61"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">flights_joined</span> <span class="op">&lt;-</span> <span class="va">flights</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">inner_join</a></span><span class="op">(</span><span class="va">airlines</span>,</span>
<span>             by <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/join_by.html">join_by</a></span><span class="op">(</span><span class="va">carrier</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>If we compare the <code>flights</code> and the <code>flights_joined</code> we just created, we will observe that these are identical except that <code>flights_joined</code> has an additional variable <code>name</code> whose values were drawn from <code>airlines</code>.</p>
<p>A visual representation of the <code>inner_join</code> is given below:</p>
<div class="cell">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><img src="join-inner.png" class="img-fluid figure-img"></p>
<figcaption>Diagram of inner join from R for Data Science.</figcaption></figure>
</div>
</div>
</div>
<p>There are more complex joins available, but the <code>inner_join</code> will solve nearly all of the problems you will face here.</p>
</section><section id="joining-by-key-variables-with-different-names" class="level2" data-number="8.2"><h2 data-number="8.2" class="anchored" data-anchor-id="joining-by-key-variables-with-different-names">
<span class="header-section-number">8.2</span> Joining by “key” variables with different names</h2>
<p>Say instead, you are interested in all the destinations of flights from NYC in 2013 and ask yourself:</p>
<ul>
<li>“What cities are these airports in?”</li>
<li>“Is <code>ORD</code> Orlando?”</li>
<li>“Where is <code>FLL</code>?”</li>
</ul>
<p>The <code>airports</code> data frame contains airport codes:</p>
<div class="cell">
<div class="sourceCode" id="cb62"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">airports</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="cell-output-display">
<table class="table table-sm table-striped small">
<colgroup>
<col style="width: 4%">
<col style="width: 36%">
<col style="width: 10%">
<col style="width: 12%">
<col style="width: 6%">
<col style="width: 3%">
<col style="width: 4%">
<col style="width: 20%">
</colgroup>
<thead><tr class="header">
<th style="text-align: left;">faa</th>
<th style="text-align: left;">name</th>
<th style="text-align: right;">lat</th>
<th style="text-align: right;">lon</th>
<th style="text-align: right;">alt</th>
<th style="text-align: right;">tz</th>
<th style="text-align: left;">dst</th>
<th style="text-align: left;">tzone</th>
</tr></thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">04G</td>
<td style="text-align: left;">Lansdowne Airport</td>
<td style="text-align: right;">41.13047</td>
<td style="text-align: right;">-80.61958</td>
<td style="text-align: right;">1044</td>
<td style="text-align: right;">-5</td>
<td style="text-align: left;">A</td>
<td style="text-align: left;">America/New_York</td>
</tr>
<tr class="even">
<td style="text-align: left;">06A</td>
<td style="text-align: left;">Moton Field Municipal Airport</td>
<td style="text-align: right;">32.46057</td>
<td style="text-align: right;">-85.68003</td>
<td style="text-align: right;">264</td>
<td style="text-align: right;">-6</td>
<td style="text-align: left;">A</td>
<td style="text-align: left;">America/Chicago</td>
</tr>
<tr class="odd">
<td style="text-align: left;">06C</td>
<td style="text-align: left;">Schaumburg Regional</td>
<td style="text-align: right;">41.98934</td>
<td style="text-align: right;">-88.10124</td>
<td style="text-align: right;">801</td>
<td style="text-align: right;">-6</td>
<td style="text-align: left;">A</td>
<td style="text-align: left;">America/Chicago</td>
</tr>
<tr class="even">
<td style="text-align: left;">06N</td>
<td style="text-align: left;">Randall Airport</td>
<td style="text-align: right;">41.43191</td>
<td style="text-align: right;">-74.39156</td>
<td style="text-align: right;">523</td>
<td style="text-align: right;">-5</td>
<td style="text-align: left;">A</td>
<td style="text-align: left;">America/New_York</td>
</tr>
<tr class="odd">
<td style="text-align: left;">09J</td>
<td style="text-align: left;">Jekyll Island Airport</td>
<td style="text-align: right;">31.07447</td>
<td style="text-align: right;">-81.42778</td>
<td style="text-align: right;">11</td>
<td style="text-align: right;">-5</td>
<td style="text-align: left;">A</td>
<td style="text-align: left;">America/New_York</td>
</tr>
</tbody>
</table>
</div>
</div>
<p>However, looking at both the <code>airports</code> and <code>flights</code> and the visual representation of the relations between the data frames in the figure above, we see that in:</p>
<ul>
<li>
<code>airports</code> the airport code is in the variable <code>faa</code>
</li>
<li>
<code>flights</code> the airport code is in the variable <code>origin</code>
</li>
</ul>
<p>So to join these two data sets, our <code>inner_join</code> operation involves a logical operator <code>==</code> argument that accounts for the different names.</p>
<div class="cell">
<details open="" class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb63"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">flights</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">inner_join</a></span><span class="op">(</span><span class="va">airports</span>,</span>
<span>             by <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/join_by.html">join_by</a></span><span class="op">(</span><span class="va">dest</span> <span class="op">==</span> <span class="va">faa</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>We can read the code out loud as:</p>
<p>“<em>Take the flights data frame and inner join it to the airports data frame by the entries where the variable</em> <code>dest</code> <em>is equal to</em> <code>faa</code>”</p>
<p>Let’s construct the sequence of commands that computes the number of flights from NYC to each destination, but also includes information about each destination airport:</p>
<div class="cell">
<details open="" class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb64"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">named_dests</span> <span class="op">&lt;-</span> <span class="va">flights</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarize</a></span><span class="op">(</span>num_flights <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/context.html">n</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>            .by <span class="op">=</span> <span class="va">dest</span><span class="op">)</span>  <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html">arrange</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/desc.html">desc</a></span><span class="op">(</span><span class="va">num_flights</span><span class="op">)</span><span class="op">)</span>  <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">inner_join</a></span><span class="op">(</span><span class="va">airports</span>, by <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/join_by.html">join_by</a></span><span class="op">(</span><span class="va">dest</span> <span class="op">==</span> <span class="va">faa</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html">rename</a></span><span class="op">(</span>airport_name <span class="op">=</span> <span class="va">name</span><span class="op">)</span></span>
<span><span class="va">named_dests</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 5 × 9
  dest  num_flights airport_name              lat    lon   alt    tz dst   tzone
  &lt;chr&gt;       &lt;int&gt; &lt;chr&gt;                   &lt;dbl&gt;  &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;chr&gt; &lt;chr&gt;
1 ORD         17283 Chicago Ohare Intl       42.0  -87.9   668    -6 A     Amer…
2 ATL         17215 Hartsfield Jackson Atl…  33.6  -84.4  1026    -5 A     Amer…
3 LAX         16174 Los Angeles Intl         33.9 -118.    126    -8 A     Amer…
4 BOS         15508 General Edward Lawrenc…  42.4  -71.0    19    -5 A     Amer…
5 MCO         14082 Orlando Intl             28.4  -81.3    96    -5 A     Amer…</code></pre>
</div>
</div>
<p>In case you didn’t know, <code>ORD</code> is the airport code of Chicago O’Hare airport and <code>FLL</code> is the main airport in Fort Lauderdale, Florida, which we can now see in our <code>named_dests</code> data frame.</p>
</section><section id="joining-by-multiple-key-variables" class="level2" data-number="8.3"><h2 data-number="8.3" class="anchored" data-anchor-id="joining-by-multiple-key-variables">
<span class="header-section-number">8.3</span> Joining by multiple “key” variables</h2>
<p>Say instead we are in a situation where we need to join by multiple variables. For example, in the first figure in this section we see that in order to join the <code>flights</code> and <code>weather</code> data frames, we need more than one key variable: <code>year</code>, <code>month</code>, <code>day</code>, <code>hour</code>, and <code>origin</code>. This is because the combination of these 5 variables act to uniquely identify each observational unit in the <code>weather</code> data frame: hourly weather recordings at each of the 3 NYC airports.</p>
<p>We achieve this by specifying a vector of key variables to join by.</p>
<div class="cell">
<details open="" class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb66"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">flights_weather_joined</span> <span class="op">&lt;-</span> <span class="va">flights</span>  <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">inner_join</a></span><span class="op">(</span><span class="va">weather</span>,</span>
<span>             by <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/join_by.html">join_by</a></span><span class="op">(</span><span class="va">year</span>,<span class="va">month</span>,<span class="va">day</span>,<span class="va">hour</span>,<span class="va">origin</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">flights_weather_joined</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code># A tibble: 335,220 × 32
    year month   day dep_time sched_dep_time dep_delay arr_time sched_arr_time
   &lt;int&gt; &lt;int&gt; &lt;int&gt;    &lt;int&gt;          &lt;int&gt;     &lt;dbl&gt;    &lt;int&gt;          &lt;int&gt;
 1  2013     1     1      517            515         2      830            819
 2  2013     1     1      533            529         4      850            830
 3  2013     1     1      542            540         2      923            850
 4  2013     1     1      544            545        -1     1004           1022
 5  2013     1     1      554            600        -6      812            837
 6  2013     1     1      554            558        -4      740            728
 7  2013     1     1      555            600        -5      913            854
 8  2013     1     1      557            600        -3      709            723
 9  2013     1     1      557            600        -3      838            846
10  2013     1     1      558            600        -2      753            745
# ℹ 335,210 more rows
# ℹ 24 more variables: arr_delay &lt;dbl&gt;, carrier &lt;chr&gt;, flight &lt;int&gt;,
#   tailnum &lt;chr&gt;, origin &lt;chr&gt;, dest &lt;chr&gt;, air_time &lt;dbl&gt;, distance &lt;dbl&gt;,
#   hour &lt;dbl&gt;, minute &lt;dbl&gt;, time_hour.x &lt;dttm&gt;, gain &lt;dbl&gt;, hours &lt;dbl&gt;,
#   gain_per_hour &lt;dbl&gt;, temp &lt;dbl&gt;, dewp &lt;dbl&gt;, humid &lt;dbl&gt;, wind_dir &lt;dbl&gt;,
#   wind_speed &lt;dbl&gt;, wind_gust &lt;dbl&gt;, precip &lt;dbl&gt;, pressure &lt;dbl&gt;,
#   visib &lt;dbl&gt;, time_hour.y &lt;dttm&gt;</code></pre>
</div>
</div>
<div class="callout callout-style-default callout-tip no-icon callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<i class="bi-question-octagon " style="color: #6dc83c;" role="img" aria-hidden="true"></i> Question
</div>
</div>
<div class="callout-body-container callout-body">
<p>Looking at the first figure in this section, when joining <code>flights</code> and <code>weather</code> (or, in other words, matching the hourly weather values with each flight), why do we need to join by all of <code>year</code>, <code>month</code>, <code>day</code>, <code>hour</code>, and <code>origin</code>, and not just <code>hour</code>?</p>
<div class="webex-solution">
<button>
Answer
</button>
<p><code>year</code>,<code>month</code>,<code>day</code>,<code>hour</code>,<code>origin</code> are the key variables that allow us to uniquely identify the observational units.</p>
</div>
</div>
</div>
<div class="callout callout-style-default callout-warning no-icon callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Task
</div>
</div>
<div class="callout-body-container callout-body">
<p>Create a new data frame that shows the top 5 airports with the largest average arrival delays from NYC in 2013.</p>
<div class="webex-solution">
<button>
Take a hint
</button>
<p>Compute the mean arrival delay from each destination. You can then join the resulting data set with the <code>airports</code> data which contains the airports names and search for the top 5 entries.</p>
</div>
<div class="cell" data-webex.hide="Click here to see the solution">
<div class="webex-solution">
<button>
Click here to see the solution
</button>
<details open="" class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb68"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span>  <span class="va">flights</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarize</a></span><span class="op">(</span>mean_arr_delay <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">arr_delay</span>,na.rm<span class="op">=</span><span class="cn">T</span><span class="op">)</span>,</span>
<span>            .by <span class="op">=</span> <span class="va">dest</span><span class="op">)</span>  <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">inner_join</a></span><span class="op">(</span><span class="va">airports</span>, by <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/join_by.html">join_by</a></span><span class="op">(</span><span class="va">dest</span> <span class="op">==</span> <span class="va">faa</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html">rename</a></span><span class="op">(</span>airport_name <span class="op">=</span> <span class="va">name</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/slice.html">slice_max</a></span><span class="op">(</span><span class="va">mean_arr_delay</span>,n<span class="op">=</span><span class="fl">5</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</div>
</div>
</div>
</section></section><section id="the-end" class="level1 unnumbered"><h1 class="unnumbered">The end?</h1>
<p>Congratulations! You have reached the end of today’s session. But wait, there’s still more! To further enhance your skills in Data analysis, check out the additional material provided on handling date-time data. This will help you learn how to manage and manipulate date-time variables within the framework of tidy data, enabling you to perform more precise and effective analyses.</p>


</section></main><!-- /main --><script>

/* update total correct if #webex-total_correct exists */
update_total_correct = function() {
  console.log("webex: update total_correct");

  var t = document.getElementsByClassName("webex-total_correct");
  for (var i = 0; i < t.length; i++) {
    p = t[i].parentElement;
    var correct = p.getElementsByClassName("webex-correct").length;
    var solvemes = p.getElementsByClassName("webex-solveme").length;
    var radiogroups = p.getElementsByClassName("webex-radiogroup").length;
    var selects = p.getElementsByClassName("webex-select").length;

    t[i].innerHTML = correct + " of " + (solvemes + radiogroups + selects) + " correct";
  }
}

/* webex-solution button toggling function */
b_func = function() {
  console.log("webex: toggle hide");

  var cl = this.parentElement.classList;
  if (cl.contains('open')) {
    cl.remove("open");
  } else {
    cl.add("open");
  }
}

/* check answers */
check_func = function() {
  console.log("webex: check answers");

  var cl = this.parentElement.classList;
  if (cl.contains('unchecked')) {
    cl.remove("unchecked");
    this.innerHTML = "Hide Answers";
  } else {
    cl.add("unchecked");
    this.innerHTML = "Show Answers";
  }
}

/* function for checking solveme answers */
solveme_func = function(e) {
  console.log("webex: check solveme");

  var real_answers = JSON.parse(this.dataset.answer);
  var my_answer = this.value;
  var cl = this.classList;
  if (cl.contains("ignorecase")) {
    my_answer = my_answer.toLowerCase();
  }
  if (cl.contains("nospaces")) {
    my_answer = my_answer.replace(/ /g, "")
  }

  if (my_answer == "") {
    cl.remove("webex-correct");
    cl.remove("webex-incorrect");
  } else if (real_answers.includes(my_answer)) {
    cl.add("webex-correct");
    cl.remove("webex-incorrect");
  } else {
    cl.add("webex-incorrect");
    cl.remove("webex-correct");
  }

  // match numeric answers within a specified tolerance
  if(this.dataset.tol > 0){
    var tol = JSON.parse(this.dataset.tol);
    var matches = real_answers.map(x => Math.abs(x - my_answer) < tol)
    if (matches.reduce((a, b) => a + b, 0) > 0) {
      cl.add("webex-correct");
    } else {
      cl.remove("webex-correct");
    }
  }

  // added regex bit
  if (cl.contains("regex")){
    answer_regex = RegExp(real_answers.join("|"))
    if (answer_regex.test(my_answer)) {
      cl.add("webex-correct");
    }
  }

  update_total_correct();
}

/* function for checking select answers */
select_func = function(e) {
  console.log("webex: check select");

  var cl = this.classList

  /* add style */
  cl.remove("webex-incorrect");
  cl.remove("webex-correct");
  if (this.value == "answer") {
    cl.add("webex-correct");
  } else if (this.value != "blank") {
    cl.add("webex-incorrect");
  }

  update_total_correct();
}

/* function for checking radiogroups answers */
radiogroups_func = function(e) {
  console.log("webex: check radiogroups");

  var checked_button = document.querySelector('input[name=' + this.id + ']:checked');
  var cl = checked_button.parentElement.classList;
  var labels = checked_button.parentElement.parentElement.children;

  /* get rid of styles */
  for (i = 0; i < labels.length; i++) {
    labels[i].classList.remove("webex-incorrect");
    labels[i].classList.remove("webex-correct");
  }

  /* add style */
  if (checked_button.value == "answer") {
    cl.add("webex-correct");
  } else {
    cl.add("webex-incorrect");
  }

  update_total_correct();
}

window.onload = function() {
  console.log("webex onload");
  /* set up solution buttons */
  var buttons = document.getElementsByTagName("button");

  for (var i = 0; i < buttons.length; i++) {
    if (buttons[i].parentElement.classList.contains('webex-solution')) {
      buttons[i].onclick = b_func;
    }
  }

  var check_sections = document.getElementsByClassName("webex-check");
  console.log("check:", check_sections.length);
  for (var i = 0; i < check_sections.length; i++) {
    check_sections[i].classList.add("unchecked");

    let btn = document.createElement("button");
    btn.innerHTML = "Show Answers";
    btn.classList.add("webex-check-button");
    btn.onclick = check_func;
    check_sections[i].appendChild(btn);

    let spn = document.createElement("span");
    spn.classList.add("webex-total_correct");
    check_sections[i].appendChild(spn);
  }

  /* set up webex-solveme inputs */
  var solveme = document.getElementsByClassName("webex-solveme");

  for (var i = 0; i < solveme.length; i++) {
    /* make sure input boxes don't auto-anything */
    solveme[i].setAttribute("autocomplete","off");
    solveme[i].setAttribute("autocorrect", "off");
    solveme[i].setAttribute("autocapitalize", "off");
    solveme[i].setAttribute("spellcheck", "false");
    solveme[i].value = "";

    /* adjust answer for ignorecase or nospaces */
    var cl = solveme[i].classList;
    var real_answer = solveme[i].dataset.answer;
    if (cl.contains("ignorecase")) {
      real_answer = real_answer.toLowerCase();
    }
    if (cl.contains("nospaces")) {
      real_answer = real_answer.replace(/ /g, "");
    }
    solveme[i].dataset.answer = real_answer;

    /* attach checking function */
    solveme[i].onkeyup = solveme_func;
    solveme[i].onchange = solveme_func;

    solveme[i].insertAdjacentHTML("afterend", " <span class='webex-icon'></span>")
  }

  /* set up radiogroups */
  var radiogroups = document.getElementsByClassName("webex-radiogroup");
  for (var i = 0; i < radiogroups.length; i++) {
    radiogroups[i].onchange = radiogroups_func;
  }

  /* set up selects */
  var selects = document.getElementsByClassName("webex-select");
  for (var i = 0; i < selects.length; i++) {
    selects[i].onchange = select_func;
    selects[i].insertAdjacentHTML("afterend", " <span class='webex-icon'></span>")
  }

  update_total_correct();
}

</script><script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const disableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'prefetch';
    }
  }
  const enableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'stylesheet';
    }
  }
  const manageTransitions = (selector, allowTransitions) => {
    const els = window.document.querySelectorAll(selector);
    for (let i=0; i < els.length; i++) {
      const el = els[i];
      if (allowTransitions) {
        el.classList.remove('notransition');
      } else {
        el.classList.add('notransition');
      }
    }
  }
  const toggleGiscusIfUsed = (isAlternate, darkModeDefault) => {
    const baseTheme = document.querySelector('#giscus-base-theme')?.value ?? 'light';
    const alternateTheme = document.querySelector('#giscus-alt-theme')?.value ?? 'dark';
    let newTheme = '';
    if(darkModeDefault) {
      newTheme = isAlternate ? baseTheme : alternateTheme;
    } else {
      newTheme = isAlternate ? alternateTheme : baseTheme;
    }
    const changeGiscusTheme = () => {
      // From: https://github.com/giscus/giscus/issues/336
      const sendMessage = (message) => {
        const iframe = document.querySelector('iframe.giscus-frame');
        if (!iframe) return;
        iframe.contentWindow.postMessage({ giscus: message }, 'https://giscus.app');
      }
      sendMessage({
        setConfig: {
          theme: newTheme
        }
      });
    }
    const isGiscussLoaded = window.document.querySelector('iframe.giscus-frame') !== null;
    if (isGiscussLoaded) {
      changeGiscusTheme();
    }
  }
  const toggleColorMode = (alternate) => {
    // Switch the stylesheets
    const alternateStylesheets = window.document.querySelectorAll('link.quarto-color-scheme.quarto-color-alternate');
    manageTransitions('#quarto-margin-sidebar .nav-link', false);
    if (alternate) {
      enableStylesheet(alternateStylesheets);
      for (const sheetNode of alternateStylesheets) {
        if (sheetNode.id === "quarto-bootstrap") {
          toggleBodyColorMode(sheetNode);
        }
      }
    } else {
      disableStylesheet(alternateStylesheets);
      toggleBodyColorPrimary();
    }
    manageTransitions('#quarto-margin-sidebar .nav-link', true);
    // Switch the toggles
    const toggles = window.document.querySelectorAll('.quarto-color-scheme-toggle');
    for (let i=0; i < toggles.length; i++) {
      const toggle = toggles[i];
      if (toggle) {
        if (alternate) {
          toggle.classList.add("alternate");     
        } else {
          toggle.classList.remove("alternate");
        }
      }
    }
    // Hack to workaround the fact that safari doesn't
    // properly recolor the scrollbar when toggling (#1455)
    if (navigator.userAgent.indexOf('Safari') > 0 && navigator.userAgent.indexOf('Chrome') == -1) {
      manageTransitions("body", false);
      window.scrollTo(0, 1);
      setTimeout(() => {
        window.scrollTo(0, 0);
        manageTransitions("body", true);
      }, 40);  
    }
  }
  const isFileUrl = () => { 
    return window.location.protocol === 'file:';
  }
  const hasAlternateSentinel = () => {  
    let styleSentinel = getColorSchemeSentinel();
    if (styleSentinel !== null) {
      return styleSentinel === "alternate";
    } else {
      return false;
    }
  }
  const setStyleSentinel = (alternate) => {
    const value = alternate ? "alternate" : "default";
    if (!isFileUrl()) {
      window.localStorage.setItem("quarto-color-scheme", value);
    } else {
      localAlternateSentinel = value;
    }
  }
  const getColorSchemeSentinel = () => {
    if (!isFileUrl()) {
      const storageValue = window.localStorage.getItem("quarto-color-scheme");
      return storageValue != null ? storageValue : localAlternateSentinel;
    } else {
      return localAlternateSentinel;
    }
  }
  const darkModeDefault = false;
  let localAlternateSentinel = darkModeDefault ? 'alternate' : 'default';
  // Dark / light mode switch
  window.quartoToggleColorScheme = () => {
    // Read the current dark / light value 
    let toAlternate = !hasAlternateSentinel();
    toggleColorMode(toAlternate);
    setStyleSentinel(toAlternate);
    toggleGiscusIfUsed(toAlternate, darkModeDefault);
  };
  // Ensure there is a toggle, if there isn't float one in the top right
  if (window.document.querySelector('.quarto-color-scheme-toggle') === null) {
    const a = window.document.createElement('a');
    a.classList.add('top-right');
    a.classList.add('quarto-color-scheme-toggle');
    a.href = "";
    a.onclick = function() { try { window.quartoToggleColorScheme(); } catch {} return false; };
    const i = window.document.createElement("i");
    i.classList.add('bi');
    a.appendChild(i);
    window.document.body.appendChild(a);
  }
  // Switch to dark mode if need be
  if (hasAlternateSentinel()) {
    toggleColorMode(true);
  } else {
    toggleColorMode(false);
  }
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  const viewSource = window.document.getElementById('quarto-view-source') ||
                     window.document.getElementById('quarto-code-tools-source');
  if (viewSource) {
    const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
    viewSource.addEventListener("click", function(e) {
      if (sourceUrl) {
        // rstudio viewer pane
        if (/\bcapabilities=\b/.test(window.location)) {
          window.open(sourceUrl);
        } else {
          window.location.href = sourceUrl;
        }
      } else {
        const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
        modal.show();
      }
      return false;
    });
  }
  function toggleCodeHandler(show) {
    return function(e) {
      const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
      for (let i=0; i<detailsSrc.length; i++) {
        const details = detailsSrc[i].parentElement;
        if (show) {
          details.open = true;
        } else {
          details.removeAttribute("open");
        }
      }
      const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
      const fromCls = show ? "hidden" : "unhidden";
      const toCls = show ? "unhidden" : "hidden";
      for (let i=0; i<cellCodeDivs.length; i++) {
        const codeDiv = cellCodeDivs[i];
        if (codeDiv.classList.contains(fromCls)) {
          codeDiv.classList.remove(fromCls);
          codeDiv.classList.add(toCls);
        } 
      }
      return false;
    }
  }
  const hideAllCode = window.document.getElementById("quarto-hide-all-code");
  if (hideAllCode) {
    hideAllCode.addEventListener("click", toggleCodeHandler(false));
  }
  const showAllCode = window.document.getElementById("quarto-show-all-code");
  if (showAllCode) {
    showAllCode.addEventListener("click", toggleCodeHandler(true));
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->



</body></html>