<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.450">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
<title>Week 2: Tidying and Wrangling data using R</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>

<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<link href="site_libs/quarto-contrib/bootstrap-icons-1.9.1/all.css" rel="stylesheet"><script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script><script src="site_libs/kePrint-0.0.1/kePrint.js"></script><link href="site_libs/lightable-0.0.1/lightable.css" rel="stylesheet">
<script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script><script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script><link rel="stylesheet" href="styles.css">
<link rel="stylesheet" href="include/webex.css">
</head>
<body class="floating nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top"><nav class="navbar navbar-expand-lg navbar-dark "><div class="navbar-container container-fluid">
      <div class="navbar-brand-container">
    <a class="navbar-brand" href="./index.html">
    <span class="navbar-title">Week 2: Tidying and Wrangling data using R</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
<li class="nav-item">
    <a class="nav-link active" href="./index.html" rel="" target="" aria-current="page">
 <span class="menu-text">Home</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="./about.html" rel="" target="">
 <span class="menu-text">Week 2 Tasks</span></a>
  </li>  
</ul>
<div class="quarto-navbar-tools ms-auto">
</div>
          </div> <!-- /navcollapse -->
      </div> <!-- /container-fluid -->
    </nav></header><!-- content --><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal sidebar-navigation floating overflow-auto"><nav id="TOC" role="doc-toc" class="toc-active"><h2 id="toc-title">Contents</h2>
   
  <ul>
<li><a href="#getting-started" id="toc-getting-started" class="nav-link active" data-scroll-target="#getting-started"><span class="header-section-number">1</span> Getting started</a></li>
  <li><a href="#what-is-tidy-data" id="toc-what-is-tidy-data" class="nav-link" data-scroll-target="#what-is-tidy-data"><span class="header-section-number">2</span> What is tidy data?</a></li>
  <li><a href="#observational-units" id="toc-observational-units" class="nav-link" data-scroll-target="#observational-units"><span class="header-section-number">3</span> Observational units</a></li>
  <li><a href="#identification-vs-measurement" id="toc-identification-vs-measurement" class="nav-link" data-scroll-target="#identification-vs-measurement"><span class="header-section-number">4</span> Identification vs measurement variables</a></li>
  <li>
<a href="#csv" id="toc-csv" class="nav-link" data-scroll-target="#csv"><span class="header-section-number">5</span> Importing spreadsheets into R</a>
  <ul class="collapse">
<li><a href="#method-1-from-the-console" id="toc-method-1-from-the-console" class="nav-link" data-scroll-target="#method-1-from-the-console"><span class="header-section-number">5.1</span> Method 1: From the console</a></li>
  <li><a href="#method-2-using-rstudios-interface" id="toc-method-2-using-rstudios-interface" class="nav-link" data-scroll-target="#method-2-using-rstudios-interface"><span class="header-section-number">5.2</span> Method 2: Using RStudio’s interface</a></li>
  </ul>
</li>
  <li><a href="#tidying" id="toc-tidying" class="nav-link" data-scroll-target="#tidying"><span class="header-section-number">6</span> Converting to <strong>tidy</strong> data format</a></li>
  <li>
<a href="#wrangling" id="toc-wrangling" class="nav-link" data-scroll-target="#wrangling"><span class="header-section-number">7</span> Introduction to data wrangling</a>
  <ul class="collapse">
<li><a href="#piping" id="toc-piping" class="nav-link" data-scroll-target="#piping"><span class="header-section-number">7.1</span> The pipe |&gt;</a></li>
  <li><a href="#verbs" id="toc-verbs" class="nav-link" data-scroll-target="#verbs"><span class="header-section-number">7.2</span> Data wrangling verbs</a></li>
  </ul>
</li>
  <li><a href="#filter" id="toc-filter" class="nav-link" data-scroll-target="#filter"><span class="header-section-number">8</span> Filter observations using filter</a></li>
  <li><a href="#summarize" id="toc-summarize" class="nav-link" data-scroll-target="#summarize"><span class="header-section-number">9</span> Summarise variables using summarize</a></li>
  <li>
<a href="#groupby" id="toc-groupby" class="nav-link" data-scroll-target="#groupby"><span class="header-section-number">10</span> Group rows using grouping structures</a>
  <ul class="collapse">
<li><a href="#grouping-by-more-than-one-variable" id="toc-grouping-by-more-than-one-variable" class="nav-link" data-scroll-target="#grouping-by-more-than-one-variable"><span class="header-section-number">10.1</span> Grouping by more than one variable</a></li>
  </ul>
</li>
  <li><a href="#mutate" id="toc-mutate" class="nav-link" data-scroll-target="#mutate"><span class="header-section-number">11</span> Create new variables/change old variables using mutate</a></li>
  <li><a href="#arrange" id="toc-arrange" class="nav-link" data-scroll-target="#arrange"><span class="header-section-number">12</span> Reorder the data frame using arrange</a></li>
  <li>
<a href="#joins" id="toc-joins" class="nav-link" data-scroll-target="#joins"><span class="header-section-number">13</span> Joining data frames</a>
  <ul class="collapse">
<li><a href="#joining-by-key-variables" id="toc-joining-by-key-variables" class="nav-link" data-scroll-target="#joining-by-key-variables"><span class="header-section-number">13.1</span> Joining by “key” variables</a></li>
  <li><a href="#joining-by-key-variables-with-different-names" id="toc-joining-by-key-variables-with-different-names" class="nav-link" data-scroll-target="#joining-by-key-variables-with-different-names"><span class="header-section-number">13.2</span> Joining by “key” variables with different names</a></li>
  <li><a href="#joining-by-multiple-key-variables" id="toc-joining-by-multiple-key-variables" class="nav-link" data-scroll-target="#joining-by-multiple-key-variables"><span class="header-section-number">13.3</span> Joining by multiple “key” variables</a></li>
  </ul>
</li>
  <li>
<a href="#other-verbs" id="toc-other-verbs" class="nav-link" data-scroll-target="#other-verbs"><span class="header-section-number">14</span> Other verbs</a>
  <ul class="collapse">
<li><a href="#select" id="toc-select" class="nav-link" data-scroll-target="#select"><span class="header-section-number">14.1</span> Select variables using select</a></li>
  <li><a href="#rename" id="toc-rename" class="nav-link" data-scroll-target="#rename"><span class="header-section-number">14.2</span> Rename variables using rename</a></li>
  <li><a href="#find-the-top-number-of-values-using-slice" id="toc-find-the-top-number-of-values-using-slice" class="nav-link" data-scroll-target="#find-the-top-number-of-values-using-slice"><span class="header-section-number">14.3</span> Find the top number of values using slice</a></li>
  <li><a href="#vectorised-if-else-thru-case_when" id="toc-vectorised-if-else-thru-case_when" class="nav-link" data-scroll-target="#vectorised-if-else-thru-case_when"><span class="header-section-number">14.4</span> Vectorised if-else thru <code>case_when</code></a></li>
  </ul>
</li>
  <li><a href="#summary" id="toc-summary" class="nav-link" data-scroll-target="#summary"><span class="header-section-number">15</span> Summary</a></li>
  </ul><div class="quarto-alternate-formats"><h2>Other Formats</h2><ul><li><a href="index.pdf"><i class="bi bi-file-pdf"></i>PDF</a></li></ul></div></nav>
</nav><div id="quarto-sidebar-glass" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
    </div>
<!-- main -->
<main class="content" id="quarto-document-content"><header id="title-block-header" class="quarto-title-block default"><div class="quarto-title">
<div class="quarto-title-block"><div><h1 class="title">Week 2: Tidying and Wrangling data using R</h1><button type="button" class="btn code-tools-button dropdown-toggle" id="quarto-code-tools-menu" data-bs-toggle="dropdown" aria-expanded="false"><i class="bi"></i> Code</button><ul class="dropdown-menu dropdown-menu-end" aria-labelelledby="quarto-code-tools-menu"><li><a id="quarto-show-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Show All Code</a></li><li><a id="quarto-hide-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Hide All Code</a></li></ul></div></div>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  

</header><section id="getting-started" class="level1" data-number="1"><h1 data-number="1">
<span class="header-section-number">1</span> Getting started</h1>
<p>This week we will demonstrate various techniques for <strong>tidying</strong> and <strong>wrangling</strong> data in R. From the ‘Introduction to R Programming’ course we are familiar with a data frame in R: a rectangular spreadsheet-like representation of data in R where the rows correspond to observations and the columns correspond to variables describing each observation. In Week 1 of Data Analysis, we started exploring the data frame <code>flights</code> included in the <code>nycflights13</code> package by creating visualisations of the data contained within said data frame.</p>
<p>Here we will discover a type of data formatting called <strong>tidy</strong> data. You will see that having data stored in the <strong>tidy</strong> format is about more than what the colloquial definition of the term <strong>tidy</strong> might suggest of having your data “neatly organised” in a spreadsheet. Instead, we define the term <strong>tidy</strong> in a more rigorous fashion, outlining a set of rules by which data can be stored and the implications of these rules on analyses.</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>This session is based on Chapters 4 and 5 of the open-source book <a href="https://moderndive.com/index.html">An Introduction to Statistical and Data Science via R</a> which can be consulted at any point.</p>
</div>
</div>
<p>First, start by opening <strong>RStudio</strong> by going to <code>Desktop -&gt; Maths-Stats -&gt; RStudio</code>. Once RStudio has opened create a new R script by going to <code>File -&gt; New File -&gt; R Script</code>. Next go to <code>File -&gt; Save As...</code> and save the script into your personal drive, either <code>M:</code> or <code>K:</code> (do not save it to the <code>H:</code> drive). We shall now load into R all of the libraries we will need for this session. This can be done by typing the following into your R script:</p>
<div class="cell">
<details><summary>Code</summary><div class="sourceCode" id="cb1"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyverse.tidyverse.org">tidyverse</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/hadley/nycflights13">nycflights13</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/rudeboybert/fivethirtyeight">fivethirtyeight</a></span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>The <code>tidyverse</code> library is actually a collection of different R packages for transforming and visualising data. The final two libraries (<code>nycflights13</code> and <code>fivethirtyeight</code>) contain interesting data sets that we shall examine in this session. Notice that when loading the <code>tidyverse</code> package you get a message that tells you about conflicting functions of certain packages. This means that there is at least one or more functions with the same name loaded from different packages (and thus one the function will mask the other). You can use the function <code><a href="https://tidyverse.tidyverse.org/reference/tidyverse_conflicts.html">tidyverse_conflicts()</a></code> for getting a list of the conflicted packages:</p>
<div class="cell">
<details><summary>Code</summary><div class="sourceCode" id="cb2"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://tidyverse.tidyverse.org/reference/tidyverse_conflicts.html">tidyverse_conflicts</a></span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code>── Conflicts ────────────────────────────────────────── tidyverse_conflicts() ──
✖ dplyr::filter() masks stats::filter()
✖ dplyr::lag()    masks stats::lag()
ℹ Use the conflicted package (&lt;http://conflicted.r-lib.org/&gt;) to force all conflicts to become errors</code></pre>
</div>
</div>
<p>In here, we can see for example that the <code>filter</code> function from the <code>dplyr</code> package has a conflict with the <code>filter</code> function in base R <code>stats</code> library. A way of sorting that out is to load the <code>dplyr</code> library after base R so that R will only consider the version of the function that was last loaded. We can be more rigorous about this and load the <code>conflicted</code> library. This will prohibit us to us any functions that have some conflict with previously defined functions.</p>
<div class="cell">
<details><summary>Code</summary><div class="sourceCode" id="cb4"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://conflicted.r-lib.org/">conflicted</a></span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>By doing this, we would need to be more specific about the source package from which the desired function should be loaded. There are two ways of doing this:</p>
<ol type="1">
<li><p>Using <code>::</code> after calling the package name every time we use the function from that package. E.g., <code>dplyr::filter(…)</code> will tell R to explicitly use the function <code>filter</code> from the <code>dplyr</code> library.</p></li>
<li><p>Using the <code>conflicts_prefer("function","package")</code> function to explicitly declare which version of the function you want to use in the remaining R session (i.e.&nbsp;after <code><a href="https://conflicted.r-lib.org/reference/conflicts_prefer.html">conflicts_prefer()</a></code> is called, e.g., <code>conflict_prefer("filter","dplyr")</code> .</p></li>
</ol>
<div class="callout callout-style-default callout-tip no-icon callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<i class="bi-question-octagon " style="color: #6dc83c;" role="img" aria-hidden="true"></i> Question
</div>
</div>
<div class="callout-body-container callout-body">
<p>What do you think is the advantage of using the <code>conflicts_prefer</code> as opposed to the first approach?</p>
</div>
</div>
</section><section id="what-is-tidy-data" class="level1" data-number="2"><h1 data-number="2">
<span class="header-section-number">2</span> What is tidy data?</h1>
<p>What does it mean for your data to be <strong>tidy</strong>? Beyond just being organised, having <strong>tidy</strong> data means that your data follows a standardised format. This makes it easier for you and others to visualise your data, to wrangle/transform your data, and to model your data. We will follow Hadley Wickham’s definition of <strong>tidy data</strong> here:</p>
<blockquote class="blockquote">
<p>A data set is a collection of values, usually either numbers (if quantitative) or strings AKA text data (if qualitative). Values are organised in two ways. Every value belongs to a variable and an observation. A variable contains all values that measure the same underlying attribute (like height, temperature, duration) across units. An observation contains all values measured on the same unit (like a person, or a day, or a city) across attributes.</p>
</blockquote>
<blockquote class="blockquote">
<p>Tidy data is a standard way of mapping the meaning of a data set to its structure. A data set is messy or tidy depending on how rows, columns and tables are matched up with observations, variables and types. In tidy data:</p>
</blockquote>
<blockquote class="blockquote">
<ol type="1">
<li>Each variable forms a column.</li>
<li>Each observation forms a row.</li>
<li>Each type of observational unit forms a table.</li>
</ol>
</blockquote>
<div class="cell">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><img src="tidy-1.png" class="img-fluid figure-img" width="614"></p>
<figcaption class="figure-caption">Tidy data graphic from http://r4ds.had.co.nz/tidy-data.html</figcaption></figure>
</div>
</div>
</div>
<p>For example, say the following table consists of stock prices:</p>
<div class="cell">
<div class="cell-output-display">
<table class="table table-sm table-striped small" data-quarto-postprocess="true">
<caption>Stock Prices (Non-Tidy Format)</caption>
<thead><tr class="header">
<th style="text-align: left;" data-quarto-table-cell-role="th">Date</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">Boeing Stock Price</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">Amazon Stock Price</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">Google Stock Price</th>
</tr></thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">2009-01-01</td>
<td style="text-align: left;">$173.55</td>
<td style="text-align: left;">$174.90</td>
<td style="text-align: left;">$174.34</td>
</tr>
<tr class="even">
<td style="text-align: left;">2009-01-02</td>
<td style="text-align: left;">$172.61</td>
<td style="text-align: left;">$171.42</td>
<td style="text-align: left;">$170.04</td>
</tr>
</tbody>
</table>
</div>
</div>
<p>Although the data are neatly organised in a spreadsheet-type format, they are not in tidy format since there are three variables corresponding to three unique pieces of information (Date, Stock Name, and Stock Price), but there are not three columns. In tidy data format each variable should be its own column, as shown below. Notice that both tables present the same information, but in different formats.</p>
<div class="cell">
<div class="cell-output-display">
<table class="table table-sm table-striped small" data-quarto-postprocess="true">
<caption>Stock Prices (Tidy Format)</caption>
<thead><tr class="header">
<th style="text-align: left;" data-quarto-table-cell-role="th">Date</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">Stock Name</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">Stock Price</th>
</tr></thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">2009-01-01</td>
<td style="text-align: left;">Boeing</td>
<td style="text-align: left;">$173.55</td>
</tr>
<tr class="even">
<td style="text-align: left;">2009-01-02</td>
<td style="text-align: left;">Boeing</td>
<td style="text-align: left;">$172.61</td>
</tr>
<tr class="odd">
<td style="text-align: left;">2009-01-01</td>
<td style="text-align: left;">Amazon</td>
<td style="text-align: left;">$174.90</td>
</tr>
<tr class="even">
<td style="text-align: left;">2009-01-02</td>
<td style="text-align: left;">Amazon</td>
<td style="text-align: left;">$171.42</td>
</tr>
<tr class="odd">
<td style="text-align: left;">2009-01-01</td>
<td style="text-align: left;">Google</td>
<td style="text-align: left;">$174.34</td>
</tr>
<tr class="even">
<td style="text-align: left;">2009-01-02</td>
<td style="text-align: left;">Google</td>
<td style="text-align: left;">$170.04</td>
</tr>
</tbody>
</table>
</div>
</div>
<p>However, consider the following table:</p>
<div class="cell">
<div class="cell-output-display">
<table class="table table-sm table-striped small" data-quarto-postprocess="true">
<caption>Date, Boeing Price, Weather Data</caption>
<thead><tr class="header">
<th style="text-align: left;" data-quarto-table-cell-role="th">Date</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">Boeing Price</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">Weather</th>
</tr></thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">2009-01-01</td>
<td style="text-align: left;">$173.55</td>
<td style="text-align: left;">Sunny</td>
</tr>
<tr class="even">
<td style="text-align: left;">2009-01-02</td>
<td style="text-align: left;">$172.61</td>
<td style="text-align: left;">Overcast</td>
</tr>
</tbody>
</table>
</div>
</div>
<p>In this case, even though the variable <strong>Boeing Price</strong> occurs again, the data <em>is</em> tidy since there are three variables corresponding to three unique pieces of information (Date, Boeing stock price, and the weather on that particular day).</p>
<p>The non-tidy data format in the original table is also known as <a href="https://en.wikipedia.org/wiki/Wide_and_narrow_data">wide</a> format whereas the tidy data format in the second table is also known as <a href="https://en.wikipedia.org/wiki/Wide_and_narrow_data#Narrow">long/narrow</a> data format. In this course, we will work mostly with data sets that are already in the tidy format.</p>
<div class="callout callout-style-default callout-tip no-icon callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<i class="bi-question-octagon " style="color: #6dc83c;" role="img" aria-hidden="true"></i> Question
</div>
</div>
<div class="callout-body-container callout-body">
<p>Consider the following data frame of average number of servings of beer, spirits, and wine consumption in three countries as reported in the FiveThirtyEight article <a href="https://fivethirtyeight.com/features/dear-mona-followup-where-do-people-drink-the-most-beer-wine-and-spirits/">Dear Mona Followup: Where Do People Drink The Most Beer, Wine And Spirits?</a></p>
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 3 × 4
  country     beer_servings spirit_servings wine_servings
  &lt;chr&gt;               &lt;int&gt;           &lt;int&gt;         &lt;int&gt;
1 Canada                240             122           100
2 South Korea           140              16             9
3 USA                   249             158            84</code></pre>
</div>
</div>
<p>This data frame is not in tidy format. What would it look like if it were?</p>
</div>
</div>
<div class="webex-solution">
<button>
I need a hint
</button>
<p>Think of these data as being in a wide format. What variables in this data set could be placed in different columns?</p>
</div>
<!-- note: you could also just set webex.hide to TRUE -->
<div class="cell" data-webex.hide="See the solution">
<div class="webex-solution">
<button>
See the solution
</button>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 9 × 3
  country     `beverages type` `number of servings`
  &lt;chr&gt;       &lt;chr&gt;                           &lt;int&gt;
1 Canada      beer_servings                     240
2 South Korea beer_servings                     140
3 USA         beer_servings                     249
4 Canada      spirit_servings                   122
5 South Korea spirit_servings                    16
6 USA         spirit_servings                   158
7 Canada      wine_servings                     100
8 South Korea wine_servings                       9
9 USA         wine_servings                      84</code></pre>
</div>
</div>
</div>
</section><section id="observational-units" class="level1" data-number="3"><h1 data-number="3">
<span class="header-section-number">3</span> Observational units</h1>
<p>Recall the <code>nycflights13</code> package with data about all domestic flights departing from New York City in 2013 that we used in Week 1 to create visualisations. In particular, let’s revisit the <code>flights</code> data frame:</p>
<div class="cell">
<details><summary>Code</summary><div class="sourceCode" id="cb7"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/dim.html">dim</a></span><span class="op">(</span><span class="va">flights</span><span class="op">)</span>  <span class="co"># Returns the dimensions of a data frame (number obs. and variables)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code>[1] 336776     19</code></pre>
</div>
<details><summary>Code</summary><div class="sourceCode" id="cb9"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">flights</span><span class="op">)</span> <span class="co"># Returns the first 6 rows of the object</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code># A tibble: 6 × 19
   year month   day dep_time sched_dep_time dep_delay arr_time sched_arr_time
  &lt;int&gt; &lt;int&gt; &lt;int&gt;    &lt;int&gt;          &lt;int&gt;     &lt;dbl&gt;    &lt;int&gt;          &lt;int&gt;
1  2013     1     1      517            515         2      830            819
2  2013     1     1      533            529         4      850            830
3  2013     1     1      542            540         2      923            850
4  2013     1     1      544            545        -1     1004           1022
5  2013     1     1      554            600        -6      812            837
6  2013     1     1      554            558        -4      740            728
# ℹ 11 more variables: arr_delay &lt;dbl&gt;, carrier &lt;chr&gt;, flight &lt;int&gt;,
#   tailnum &lt;chr&gt;, origin &lt;chr&gt;, dest &lt;chr&gt;, air_time &lt;dbl&gt;, distance &lt;dbl&gt;,
#   hour &lt;dbl&gt;, minute &lt;dbl&gt;, time_hour &lt;dttm&gt;</code></pre>
</div>
<details><summary>Code</summary><div class="sourceCode" id="cb11"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://pillar.r-lib.org/reference/glimpse.html">glimpse</a></span><span class="op">(</span><span class="va">flights</span><span class="op">)</span> <span class="co"># Lists the variables in an object with their first few values </span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code>Rows: 336,776
Columns: 19
$ year           &lt;int&gt; 2013, 2013, 2013, 2013, 2013, 2013, 2013, 2013, 2013, 2…
$ month          &lt;int&gt; 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1…
$ day            &lt;int&gt; 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1…
$ dep_time       &lt;int&gt; 517, 533, 542, 544, 554, 554, 555, 557, 557, 558, 558, …
$ sched_dep_time &lt;int&gt; 515, 529, 540, 545, 600, 558, 600, 600, 600, 600, 600, …
$ dep_delay      &lt;dbl&gt; 2, 4, 2, -1, -6, -4, -5, -3, -3, -2, -2, -2, -2, -2, -1…
$ arr_time       &lt;int&gt; 830, 850, 923, 1004, 812, 740, 913, 709, 838, 753, 849,…
$ sched_arr_time &lt;int&gt; 819, 830, 850, 1022, 837, 728, 854, 723, 846, 745, 851,…
$ arr_delay      &lt;dbl&gt; 11, 20, 33, -18, -25, 12, 19, -14, -8, 8, -2, -3, 7, -1…
$ carrier        &lt;chr&gt; "UA", "UA", "AA", "B6", "DL", "UA", "B6", "EV", "B6", "…
$ flight         &lt;int&gt; 1545, 1714, 1141, 725, 461, 1696, 507, 5708, 79, 301, 4…
$ tailnum        &lt;chr&gt; "N14228", "N24211", "N619AA", "N804JB", "N668DN", "N394…
$ origin         &lt;chr&gt; "EWR", "LGA", "JFK", "JFK", "LGA", "EWR", "EWR", "LGA",…
$ dest           &lt;chr&gt; "IAH", "IAH", "MIA", "BQN", "ATL", "ORD", "FLL", "IAD",…
$ air_time       &lt;dbl&gt; 227, 227, 160, 183, 116, 150, 158, 53, 140, 138, 149, 1…
$ distance       &lt;dbl&gt; 1400, 1416, 1089, 1576, 762, 719, 1065, 229, 944, 733, …
$ hour           &lt;dbl&gt; 5, 5, 5, 5, 6, 5, 6, 6, 6, 6, 6, 6, 6, 6, 6, 5, 6, 6, 6…
$ minute         &lt;dbl&gt; 15, 29, 40, 45, 0, 58, 0, 0, 0, 0, 0, 0, 0, 0, 0, 59, 0…
$ time_hour      &lt;dttm&gt; 2013-01-01 05:00:00, 2013-01-01 05:00:00, 2013-01-01 0…</code></pre>
</div>
</div>
<p>We see that <code>flights</code> has a rectangular shape with each row corresponding to a different flight and each column corresponding to a characteristic of that flight. This matches exactly with the first two properties of tidy data, namely:</p>
<ol type="1">
<li>Each variable forms a column.</li>
<li>Each observation forms a row.</li>
</ol>
<p>But what about the third property?</p>
<ol start="3" type="1">
<li>Each type of observational unit forms a table.</li>
</ol>
<p>The observational unit in the <code>flights</code> data set is an individual flight and we can see above that this data set consists of 336,776 flights with 19 variables. In other words, rows of this data set don’t refer to a measurement on an airline or on an airport; they refer to characteristics/measurements on a given flight from New York City in 2013. This illustrates the third property of tidy data, i.e.&nbsp;each observational unit is fully described by a single data set.</p>
<p>Note that there is only one observational unit of interest in any analysis. For example, also included in the <code>nycflights13</code> package are data sets with different observational units:</p>
<ul>
<li>
<code>airlines</code> <!-- : translation between two letter IATA carrier codes and names (16 in total) -->
</li>
<li>
<code>planes</code> <!-- : construction information about each of 3,322 planes used -->
</li>
<li>
<code>weather</code> <!-- : hourly meteorological data (about 8705 observations) for each of the three NYC airports -->
</li>
<li>
<code>airports</code> <!-- : 1458 airport names and locations -->
</li>
</ul>
<p>The organisation of this data follows the third <strong>tidy</strong> data property: observations corresponding to the same observational unit are saved in the same data frame.</p>
<div class="callout callout-style-default callout-warning no-icon callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Task
</div>
</div>
<div class="callout-body-container callout-body">
<p>For each of the data sets listed above (other than <code>flights</code>), identify the observational unit and how many of these are described in each of the data sets.</p>
<ul>
<li>In the <code>airlines</code> data set the observational unit is<select class="webex-select"><option value="blank"></option>
<option value="">Type of plane</option>
<option value="">Flight number</option>
<option value="">airport code</option>
<option value="answer">IATA carrier codes and names</option></select> and there are <input class="webex-solveme nospaces" size="2" data-answer="[&quot;16&quot;]"> observational units.</li>
<li>In the <code>planes</code> data set the observational unit is <select class="webex-select"><option value="blank"></option>
<option value="">Flight</option>
<option value="">Manufacturer of the plane</option>
<option value="answer">Plane</option>
<option value="">Average cruising speed in mph</option></select> and there are <input class="webex-solveme nospaces" size="5" data-answer="[&quot;3,322&quot;]"> observational units.</li>
<li>In the <code>weather</code> data set the observational unit is the <select class="webex-select"><option value="blank"></option>
<option value="answer">Weather Station</option>
<option value="">Temperature</option>
<option value="">Relative humidity</option>
<option value="">Sea level pressure</option></select> and there are <input class="webex-solveme nospaces" size="4" data-answer="[&quot;8705&quot;]"> observations on <strong>average</strong> across the three NYC airports.</li>
<li>In the <code>airports</code> data set the observational unit is the <select class="webex-select"><option value="blank"></option>
<option value="">Time zone</option>
<option value="answer">Airport</option>
<option value="">Altitude</option>
<option value="">Daylight savings time zone</option></select> and there are <input class="webex-solveme nospaces" size="4" data-answer="[&quot;1458&quot;]"> observational units.</li>
</ul>
</div>
</div>
</section><section id="identification-vs-measurement" class="level1" data-number="4"><h1 data-number="4">
<span class="header-section-number">4</span> Identification vs measurement variables</h1>
<p>There is a subtle difference between the kinds of variables that you will encounter in data frames: <strong>measurement variables</strong> and <strong>identification variables</strong>. The <code>airports</code> data frame contains both these types of variables. Recall that in <code>airports</code> the observational unit is an airport, and thus each row corresponds to one particular airport. Let’s pull them apart using the <code>glimpse</code> function:</p>
<div class="cell">
<details><summary>Code</summary><div class="sourceCode" id="cb13"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://pillar.r-lib.org/reference/glimpse.html">glimpse</a></span><span class="op">(</span><span class="va">airports</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code>Rows: 1,458
Columns: 8
$ faa   &lt;chr&gt; "04G", "06A", "06C", "06N", "09J", "0A9", "0G6", "0G7", "0P2", "…
$ name  &lt;chr&gt; "Lansdowne Airport", "Moton Field Municipal Airport", "Schaumbur…
$ lat   &lt;dbl&gt; 41.13047, 32.46057, 41.98934, 41.43191, 31.07447, 36.37122, 41.4…
$ lon   &lt;dbl&gt; -80.61958, -85.68003, -88.10124, -74.39156, -81.42778, -82.17342…
$ alt   &lt;dbl&gt; 1044, 264, 801, 523, 11, 1593, 730, 492, 1000, 108, 409, 875, 10…
$ tz    &lt;dbl&gt; -5, -6, -6, -5, -5, -5, -5, -5, -5, -8, -5, -6, -5, -5, -5, -5, …
$ dst   &lt;chr&gt; "A", "A", "A", "A", "A", "A", "A", "A", "U", "A", "A", "U", "A",…
$ tzone &lt;chr&gt; "America/New_York", "America/Chicago", "America/Chicago", "Ameri…</code></pre>
</div>
</div>
<p>The variables <code>faa</code> and <code>name</code> are what we will call <strong>identification variables</strong>: variables that uniquely identify each observational unit. They are mainly used to provide a unique name to each observational unit, thereby allowing us to uniquely identify them. <code>faa</code> gives the unique code provided by the Federal Aviation Administration in the USA for that airport, while the <code>name</code> variable gives the longer more natural name of the airport. The remaining variables (<code>lat</code>, <code>lon</code>, <code>alt</code>, <code>tz</code>, <code>dst</code>, <code>tzone</code>) are often called <strong>measurement</strong> or <strong>characteristic</strong> variables: variables that describe properties of each observational unit, in other words each observation in each row. For example, <code>lat</code> and <code>long</code> describe the latitude and longitude of each airport.</p>
<p>Furthermore, sometimes a single variable might not be enough to uniquely identify each observational unit: combinations of variables might be needed (see <strong>Task</strong> below). While it is not an absolute rule, for organisational purposes it is considered good practice to have your identification variables in the far left-most columns of your data frame.</p>
<div class="callout callout-style-default callout-tip no-icon callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<i class="bi-question-octagon " style="color: #6dc83c;" role="img" aria-hidden="true"></i> Question
</div>
</div>
<div class="callout-body-container callout-body">
<p>What properties of the observational unit do each of <code>lat</code>, <code>lon</code>, <code>alt</code>, <code>tz</code>, <code>dst</code>, and <code>tzone</code> describe for the <code>airports</code> data frame? <select class="webex-select"><option value="blank"></option>
<option value="">Carriers in each airport</option>
<option value="">Airport Flights</option>
<option value="">Airport appliances</option>
<option value="answer">Spatial location of the airport</option></select></p>
</div>
</div>
<div class="callout callout-style-default callout-warning no-icon callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Task
</div>
</div>
<div class="callout-body-container callout-body">
<p>From the data sets listed above, find an example where combinations of variables are needed to uniquely identify each observational unit.</p>
<p><strong>Hint</strong> think about the weather data set, can you identify each observational unit based on the station id only?</p>
</div>
</div>
</section><section id="csv" class="level1" data-number="5"><h1 data-number="5">
<span class="header-section-number">5</span> Importing spreadsheets into R</h1>
<p>Up to this point, we have been using data stored inside of an R package. In the real world, your data will usually come from a spreadsheet file either on your computer or online. Spreadsheet data is often saved in one of two formats:</p>
<ul>
<li>A <strong>Comma Separated Values</strong> <code>.csv</code> file. You can think of a CSV file as a bare-bones spreadsheet where:
<ul>
<li>Each line in the file corresponds to one row of data/one observation.</li>
<li>Values for each line are separated with commas. In other words, the values of different variables are separated by commas.</li>
<li>The first line is often, but not always, a <em>header</em> row indicating the names of the columns/variables.</li>
</ul>
</li>
<li>An <strong>Excel</strong> <code>.xlsx</code> file. This format is based on Microsoft’s proprietary Excel software. As opposed to bare-bones <code>.csv</code> files, <code>.xlsx</code> Excel files contain a lot of <em>metadata</em>, i.e.&nbsp;data about the data. Examples include the use of bold and italic fonts, colored cells, different column widths, and formula macros etc.</li>
</ul>
<p>We’ll cover two methods for importing data in R: one using the R console and the other using RStudio’s graphical interface.</p>
<section id="method-1-from-the-console" class="level2" data-number="5.1"><h2 data-number="5.1" class="anchored" data-anchor-id="method-1-from-the-console">
<span class="header-section-number">5.1</span> Method 1: From the console</h2>
<p>First, let’s download a <strong>Comma Separated Values</strong> (CSV) file of ratings of the level of democracy in different countries spanning 1952 to 1992: <a href="https://moderndive.com/data/dem_score.csv" class="uri">https://moderndive.com/data/dem_score.csv</a>. We use the <code><a href="https://readr.tidyverse.org/reference/read_delim.html">read_csv()</a></code> function from the <code>readr</code> package to read it off the web:</p>
<div class="cell">
<details><summary>Code</summary><div class="sourceCode" id="cb15"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">dem_score</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://readr.tidyverse.org/reference/read_delim.html">read_csv</a></span><span class="op">(</span><span class="st">"https://moderndive.com/data/dem_score.csv"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code># A tibble: 96 × 10
   country    `1952` `1957` `1962` `1967` `1972` `1977` `1982` `1987` `1992`
   &lt;chr&gt;       &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;
 1 Albania        -9     -9     -9     -9     -9     -9     -9     -9      5
 2 Argentina      -9     -1     -1     -9     -9     -9     -8      8      7
 3 Armenia        -9     -7     -7     -7     -7     -7     -7     -7      7
 4 Australia      10     10     10     10     10     10     10     10     10
 5 Austria        10     10     10     10     10     10     10     10     10
 6 Azerbaijan     -9     -7     -7     -7     -7     -7     -7     -7      1
 7 Belarus        -9     -7     -7     -7     -7     -7     -7     -7      7
 8 Belgium        10     10     10     10     10     10     10     10     10
 9 Bhutan        -10    -10    -10    -10    -10    -10    -10    -10    -10
10 Bolivia        -4     -3     -3     -4     -7     -7      8      9      9
# ℹ 86 more rows</code></pre>
</div>
</div>
<p>In this <code>dem_score</code> data frame, the minimum value of -10 corresponds to a highly autocratic nation whereas a value of 10 corresponds to a highly democratic nation.</p>
</section><section id="method-2-using-rstudios-interface" class="level2" data-number="5.2"><h2 data-number="5.2" class="anchored" data-anchor-id="method-2-using-rstudios-interface">
<span class="header-section-number">5.2</span> Method 2: Using RStudio’s interface</h2>
<p>Let’s read in the same data saved in Excel format this time at <a href="https://moderndive.com/data/dem_score.xlsx" class="uri">https://moderndive.com/data/dem_score.xlsx</a>, but using RStudio’s graphical interface instead of via the R console. First download the Excel file, then go to the <code>Files -&gt; Import Dataset -&gt; From Excel...</code> and navigate to the directory where your downloaded <code>dem_score.xlsx</code> using <code>Browse...</code>. You should see something similar to the image below:</p>
<div class="cell">
<div class="cell-output-display">
<p><img src="read_excel.png" class="img-fluid" width="553"></p>
</div>
</div>
<p>After clicking on the <strong>Import</strong> button on the bottom-right save this spreadsheet’s data in a data frame called <code>dem_score</code> and display its contents in the spreadsheet viewer (<code><a href="https://rdrr.io/r/utils/View.html">View()</a></code>). Furthermore you’ll see the code that read in your data in the console; you can copy and paste this code to reload your data again later instead of repeating the above manual process.</p>
<div class="callout callout-style-default callout-caution callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Caution
</div>
</div>
<div class="callout-body-container callout-body">
<p>Note that if you use the <code>xlsx</code> package to import <code>.xlsx</code> files is important to have the latest version of java installed in your local PC. The <code>xlsx</code> package depends on the <code>rJava</code> package which requires the Java Runtime Environment 1.2 or above. Download and install the latest version of the Java Runtime Environment from <a href="https://www.java.com/en/download/">Oracle</a>.</p>
</div>
</div>
<div class="callout callout-style-default callout-warning no-icon callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Task
</div>
</div>
<div class="callout-body-container callout-body">
<p>Read in the life expectancy data stored at <a href="https://moderndive.com/data/le_mess.csv" class="uri">https://moderndive.com/data/le_mess.csv</a>, either using the R console or RStudio’s interface.</p>
</div>
</div>
</section></section><section id="tidying" class="level1" data-number="6"><h1 data-number="6">
<span class="header-section-number">6</span> Converting to <strong>tidy</strong> data format</h1>
<p>In this section, we will see how to convert a data set that is not in the <strong>tidy</strong> format i.e.&nbsp;<a href="https://en.wikipedia.org/wiki/Wide_and_narrow_data">wide</a> format, to a data set that is in the <strong>tidy</strong> format i.e.&nbsp;<a href="https://en.wikipedia.org/wiki/Wide_and_narrow_data#Narrow">long/narrow</a> format. Let’s use the <code>dem_score</code> data frame we loaded from a spreadsheet in the previous section but focus on only data corresponding to the country of Guatemala.</p>
<div class="cell">
<details><summary>Code</summary><div class="sourceCode" id="cb17"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">guat_dem</span> <span class="op">&lt;-</span> <span class="va">dem_score</span>  <span class="op">|&gt;</span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">country</span> <span class="op">==</span> <span class="st">"Guatemala"</span><span class="op">)</span>  </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code># A tibble: 1 × 10
  country   `1952` `1957` `1962` `1967` `1972` `1977` `1982` `1987` `1992`
  &lt;chr&gt;      &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;
1 Guatemala      2     -6     -5      3      1     -3     -7      3      3</code></pre>
</div>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>Here we have used the <code>filter</code> funtion from <code>dplyr</code> package to subset the data set. We will revisit this code for subsetting data later in the session.</p>
</div>
</div>
<p>Now let’s produce a plot showing how the democracy scores have changed over the 40 years from 1952 to 1992 for Guatemala. Let’s start by laying out how we would map our aesthetics to variables in the data frame:</p>
<ul>
<li>The <code>data</code> frame is <code>guat_dem</code> so we use <code>data = guat_dem</code>.</li>
</ul>
<p>We would like to see how the democracy score has changed over the years in Guatemala. But we have a problem. We see that we have a variable named <code>country</code> but its only value is <code>Guatemala</code>. We have other variables denoted by different year values. Unfortunately, we’ve run into a data set that is not in the appropriate format to apply the <strong>Grammar of Graphics</strong> in <code>ggplot2</code>. Remember that <code>ggplot2</code> is a package in the <code>tidyverse</code> and, thus, needs data to be in a tidy format. We’d like to finish off our mapping of aesthetics to variables by doing something like</p>
<ul>
<li>The <code>aes</code>thetic mapping is set by <code>aes(x = year, y = democracy_score)</code>,</li>
</ul>
<p>but this is not possible with our wide-formatted data. We need to take the values of the current column names in <code>guat_dem</code> (aside from <code>country</code>) and convert them into a new variable that will act as a key called <code>year</code>. Then, we’d like to take the numbers on the inside of the table and turn them into a column that will act as values called <code>democracy_score</code>. Our resulting data frame will have three columns: <code>country</code>, <code>year</code>, and <code>democracy_score</code>.</p>
<p>The <code>gather</code> function in the <code>tidyr</code> package can complete this task for us. The first argument to <code>gather</code>, just as with <code>ggplot2</code>, is the <code>data</code> argument where we specify which data frame we would like to tidy. The next two arguments to <code>gather</code> are <code>key</code> and <code>value</code>, which specify what we would like to call the new columns that convert our wide data into tidy/long format. Lastly, we include a specification for variables we would like to NOT include in the tidying process using a <code>-</code>.</p>
<div class="cell">
<details><summary>Code</summary><div class="sourceCode" id="cb19"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">guat_tidy</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://tidyr.tidyverse.org/reference/gather.html">gather</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">guat_dem</span>, </span>
<span>                    key <span class="op">=</span> <span class="va">year</span>,</span>
<span>                    value <span class="op">=</span> <span class="va">democracy_score</span>,</span>
<span>                    <span class="op">-</span> <span class="va">country</span><span class="op">)</span> </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code># A tibble: 9 × 3
  country   year  democracy_score
  &lt;chr&gt;     &lt;chr&gt;           &lt;dbl&gt;
1 Guatemala 1952                2
2 Guatemala 1957               -6
3 Guatemala 1962               -5
4 Guatemala 1967                3
5 Guatemala 1972                1
6 Guatemala 1977               -3
7 Guatemala 1982               -7
8 Guatemala 1987                3
9 Guatemala 1992                3</code></pre>
</div>
</div>
<p>We can now create a plot showing how democracy score in Guatemala has changed from 1952 to 1992 using a linegraph and <code>ggplot2</code>.</p>
<div class="cell" data-errors="true">
<details><summary>Code</summary><div class="sourceCode" id="cb21"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">guat_tidy</span>, mapping <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">year</span>, y <span class="op">=</span> <span class="va">democracy_score</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span>x <span class="op">=</span> <span class="st">"year"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<p><img src="index_files/figure-html/unnamed-chunk-12-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Observe that the <code>year</code> variable in <code>guat_tidy</code> is stored as a character vector since we had to circumvent the naming rules in R by adding backticks around the different year columns in <code>guat_dem</code>. This is leading to <code>ggplot</code> not knowing exactly how to plot a line using a categorical variable. We can fix this by using the <code>parse_number</code> function in the <code>readr</code> package:</p>
<div class="cell">
<details><summary>Code</summary><div class="sourceCode" id="cb22"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">guat_tidy</span>, mapping <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="fu"><a href="https://readr.tidyverse.org/reference/parse_number.html">parse_number</a></span><span class="op">(</span><span class="va">year</span><span class="op">)</span>, y <span class="op">=</span> <span class="va">democracy_score</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span>x <span class="op">=</span> <span class="st">"year"</span>, y <span class="op">=</span> <span class="st">"Democracy score"</span>,</span>
<span>       title <span class="op">=</span> <span class="st">"Guatemala's democracy score ratings from 1952 to 1992"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<p><img src="index_files/figure-html/guatline-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>We’ll see later how we could use the <code>mutate</code> function to change <code>year</code> to be a numeric variable during the tidying process (alternatively we could have added the argument <code>convert=T</code> in the <code><a href="https://tidyr.tidyverse.org/reference/gather.html">gather()</a></code> function to declare the <code>key</code> column values as an integers; see <code><a href="https://tidyr.tidyverse.org/reference/gather.html">?gather</a></code> for more details) . Notice now that the mappings of aesthetics to variables makes sense in the figure:</p>
<ul>
<li>The <code>data</code> frame is <code>guat_tidy</code> by setting <code>data = guat_tidy</code>;</li>
<li>The <code>x</code> <code>aes</code>thetic is mapped to <code>year</code>;</li>
<li>The <code>y</code> <code>aes</code>thetic is mapped to <code>democracy_score</code>; and</li>
<li>The <code>geom_</code>etry chosen is <code>line</code>.</li>
</ul>
<div class="callout callout-style-default callout-warning no-icon callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Task
</div>
</div>
<div class="callout-body-container callout-body">
<p>Convert the <code>dem_score</code> data frame into a tidy data frame and assign the name of <code>dem_score_tidy</code> to the resulting long-formatted data frame.</p>
<div class="webex-solution">
<button>
Take hint
</button>
<p>See the documentation for <code><a href="https://tidyr.tidyverse.org/reference/gather.html">gather()</a></code> (<code><a href="https://tidyr.tidyverse.org/reference/gather.html">?gather</a></code>). Try using the <code>convert= T</code> argument and comment on the output.</p>
</div>
<div class="cell" data-webex.hide="Click here to see the solution">
<div class="webex-solution">
<button>
Click here to see the solution
</button>
<details open=""><summary>Code</summary><div class="sourceCode" id="cb23"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">dem_score_tidy</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://tidyr.tidyverse.org/reference/gather.html">gather</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">dem_score</span>, </span>
<span>                    key <span class="op">=</span> <span class="va">year</span>,</span>
<span>                    convert<span class="op">=</span> <span class="cn">T</span>,</span>
<span>                    value <span class="op">=</span> <span class="va">democracy_score</span>,</span>
<span>                    <span class="op">-</span> <span class="va">country</span><span class="op">)</span> </span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">dem_score_tidy</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code># A tibble: 6 × 3
  country     year democracy_score
  &lt;chr&gt;      &lt;int&gt;           &lt;dbl&gt;
1 Albania     1952              -9
2 Argentina   1952              -9
3 Armenia     1952              -9
4 Australia   1952              10
5 Austria     1952              10
6 Azerbaijan  1952              -9</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="callout callout-style-default callout-warning no-icon callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Task
</div>
</div>
<div class="callout-body-container callout-body">
<p>Now try converting the life expectancy data set you created in a previous task into a tidy data frame.</p>
</div>
</div>
</section><section id="wrangling" class="level1" data-number="7"><h1 data-number="7">
<span class="header-section-number">7</span> Introduction to data wrangling</h1>
<p>We are now able to import data and perform basic operations on the data to get it into the <strong>tidy</strong> format. In this and subsequent sections we will use tools from the <code>dplyr</code> package to perform data <strong>wrangling</strong> which includes transforming, mapping and summarising variables.</p>
<section id="piping" class="level2" data-number="7.1"><h2 data-number="7.1" class="anchored" data-anchor-id="piping">
<span class="header-section-number">7.1</span> The pipe |&gt;</h2>
<p>Before we dig into data wrangling, let’s first introduce the pipe operator (<code>|&gt;</code>). Just as the <code>+</code> sign was used to add layers to a plot created using <code>ggplot</code>, the pipe operator allows us to chain together data wrangling functions. The pipe operator can be read as <strong>then</strong>. The <code>|&gt;</code> operator allows us to go from one step in to the next easily so we can, for example:</p>
<ul>
<li>
<code>filter</code> our data frame to only focus on a few rows <strong>then</strong>
</li>
<li>
<code>group_by</code> another variable to create groups <strong>then</strong>
</li>
<li>
<code>summarize</code> this grouped data to calculate the mean for each level of the group.</li>
</ul>
<p>The piping syntax will be our major focus throughout the rest of this course and you’ll find that you’ll quickly be addicted to the chaining with some practice.</p>
</section><section id="verbs" class="level2" data-number="7.2"><h2 data-number="7.2" class="anchored" data-anchor-id="verbs">
<span class="header-section-number">7.2</span> Data wrangling verbs</h2>
<p>The <code>d</code> in <code>dplyr</code> stands for data frames, so the functions in <code>dplyr</code> are built for working with objects of the data frame type. For now, we focus on the most commonly used functions that help wrangle and summarise data. A description of these verbs follows, with each subsequent section devoted to an example of that verb, or a combination of a few verbs, in action.</p>
<ol type="1">
<li>
<code>filter</code>: Pick rows based on conditions about their values</li>
<li>
<code>summarize</code>: Compute summary measures known as “summary statistics” of variables</li>
<li>
<code>group_by</code>: Group rows of observations together</li>
<li>
<code>mutate</code>: Create a new variable in the data frame by mutating existing ones</li>
<li>
<code>arrange</code>: Arrange/sort the rows based on one or more variables</li>
<li>
<code>join</code>: Join/merge two data frames by matching along a “key” variable. There are many different <code>join</code>s available. Here, we will focus on the <code>inner_join</code> function.</li>
</ol>
<p>All of the verbs are used similarly where you: take a data frame, pipe it using the <code>%&gt;%</code> syntax into one of the verbs above followed by other arguments specifying which criteria you would like the verb to work with in parentheses.</p>
</section></section><section id="filter" class="level1" data-number="8"><h1 data-number="8">
<span class="header-section-number">8</span> Filter observations using filter</h1>
<div class="cell">
<div class="cell-output-display">
<p><img src="filter.png" class="img-fluid" width="613"></p>
</div>
</div>
<p>The <code>filter</code> function allows you to specify criteria about values of a variable in your data set and then chooses only those rows that match that criteria.</p>
<div class="callout callout-style-default callout-important callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Important
</div>
</div>
<div class="callout-body-container callout-body">
<p>Recall that the base R has already a filter function defined. So make sure to avoid any conflicts either by calling <code><a href="https://dplyr.tidyverse.org/reference/filter.html">dplyr::filter()</a></code> every time you use the function (specially if you have loaded the <code>conflicts</code> library) or alternatively run the<code><a href="https://conflicted.r-lib.org/reference/conflict_prefer.html">conflict_prefer()</a></code> function to let R know that it should use <code>dplyr</code>’s <code>filter</code> function as default.</p>
<div class="cell">
<div class="cell-output cell-output-stderr">
<pre><code>Warning: package 'conflicted' was built under R version 4.2.3</code></pre>
</div>
</div>
<div class="cell">
<details open=""><summary>Code</summary><div class="sourceCode" id="cb26"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://conflicted.r-lib.org/reference/conflict_prefer.html">conflict_prefer</a></span><span class="op">(</span><span class="st">"filter"</span>, <span class="st">"dplyr"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stderr">
<pre><code>[conflicted] Will prefer dplyr::filter over any other package.</code></pre>
</div>
</div>
</div>
</div>
<p>We begin by focusing only on flights from New York City to Portland, Oregon. The <code>dest</code> code (or airport code) for Portland, Oregon is <code>PDX</code>. Run the following code and look at the resulting spreadsheet to ensure that only flights heading to Portland are chosen:</p>
<div class="cell" data-exercise="true">
<details><summary>Code</summary><div class="sourceCode" id="cb28"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">portland_flights</span> <span class="op">&lt;-</span> <span class="va">flights</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">dest</span> <span class="op">==</span> <span class="st">"PDX"</span><span class="op">)</span></span>
<span><span class="co"># We do not display columns 6-11 so we can see the destination (dest) variable.</span></span>
<span><span class="va">portland_flights</span><span class="op">[</span>,<span class="op">-</span><span class="op">(</span><span class="fl">6</span><span class="op">:</span><span class="fl">12</span><span class="op">)</span><span class="op">]</span> </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code># A tibble: 1,354 × 12
    year month   day dep_time sched_dep_time origin dest  air_time distance
   &lt;int&gt; &lt;int&gt; &lt;int&gt;    &lt;int&gt;          &lt;int&gt; &lt;chr&gt;  &lt;chr&gt;    &lt;dbl&gt;    &lt;dbl&gt;
 1  2013     1     1     1739           1740 JFK    PDX        341     2454
 2  2013     1     1     1805           1757 EWR    PDX        336     2434
 3  2013     1     1     2052           2029 JFK    PDX        331     2454
 4  2013     1     2      804            805 EWR    PDX        310     2434
 5  2013     1     2     1552           1550 JFK    PDX        305     2454
 6  2013     1     2     1727           1720 EWR    PDX        351     2434
 7  2013     1     2     1738           1740 JFK    PDX        322     2454
 8  2013     1     2     2024           2029 JFK    PDX        325     2454
 9  2013     1     3     1755           1745 JFK    PDX        325     2454
10  2013     1     3     1814           1727 EWR    PDX        320     2434
# ℹ 1,344 more rows
# ℹ 3 more variables: hour &lt;dbl&gt;, minute &lt;dbl&gt;, time_hour &lt;dttm&gt;</code></pre>
</div>
</div>
<p>Note the following:</p>
<ul>
<li>The ordering of the commands:
<ul>
<li>Take the data frame <code>flights</code> <strong>then</strong>
</li>
<li>
<code>filter</code> the data frame so that only those where the <code>dest</code> equals <code>PDX</code> are included.</li>
</ul>
</li>
<li>The double equals sign <code>==</code> tests equality, and not a single equals sign <code>=</code>.</li>
</ul>
<p>You can combine multiple criteria together using operators that make comparisons:</p>
<ul>
<li>
<code>|</code> corresponds to <strong>or</strong>
</li>
<li>
<code>&amp;</code> corresponds to <strong>and</strong>
</li>
</ul>
<p>We can often skip the use of <code>&amp;</code> and just separate our conditions with a comma. You’ll see this in the example below.</p>
<p>In addition, you can use other mathematical checks (similar to <code>==</code>):</p>
<ul>
<li>
<code>&gt;</code> corresponds to <strong>greater than</strong>
</li>
<li>
<code>&lt;</code> corresponds to <strong>less than</strong>
</li>
<li>
<code>&gt;=</code> corresponds to <strong>greater than or equal to</strong>
</li>
<li>
<code>&lt;=</code> corresponds to <strong>less than or equal to</strong>
</li>
<li>
<code>!=</code> corresponds to <strong>not equal to</strong>
</li>
</ul>
<p>To see many of these in action, let’s select all flights that left JFK airport heading to Burlington, Vermont (<code>BTV</code>) or Seattle, Washington (<code>SEA</code>) in the months of October, November, or December. Run the following</p>
<div class="cell" data-exercise="true">
<details><summary>Code</summary><div class="sourceCode" id="cb30"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">btv_sea_flights_fall</span> <span class="op">&lt;-</span> <span class="va">flights</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">origin</span> <span class="op">==</span> <span class="st">"JFK"</span>, <span class="op">(</span><span class="va">dest</span> <span class="op">==</span> <span class="st">"BTV"</span> <span class="op">|</span> <span class="va">dest</span> <span class="op">==</span> <span class="st">"SEA"</span><span class="op">)</span>, <span class="va">month</span> <span class="op">&gt;=</span> <span class="fl">10</span><span class="op">)</span></span>
<span><span class="va">btv_sea_flights_fall</span><span class="op">[</span>,<span class="op">-</span><span class="op">(</span><span class="fl">6</span><span class="op">:</span><span class="fl">12</span><span class="op">)</span><span class="op">]</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code># A tibble: 815 × 12
    year month   day dep_time sched_dep_time origin dest  air_time distance
   &lt;int&gt; &lt;int&gt; &lt;int&gt;    &lt;int&gt;          &lt;int&gt; &lt;chr&gt;  &lt;chr&gt;    &lt;dbl&gt;    &lt;dbl&gt;
 1  2013    10     1      729            735 JFK    SEA        352     2422
 2  2013    10     1      853            900 JFK    SEA        362     2422
 3  2013    10     1      916            925 JFK    BTV         48      266
 4  2013    10     1     1216           1221 JFK    BTV         49      266
 5  2013    10     1     1452           1459 JFK    BTV         46      266
 6  2013    10     1     1459           1500 JFK    SEA        348     2422
 7  2013    10     1     1754           1800 JFK    SEA        338     2422
 8  2013    10     1     1825           1830 JFK    SEA        366     2422
 9  2013    10     1     1925           1930 JFK    SEA        332     2422
10  2013    10     1     2238           2245 JFK    BTV         48      266
# ℹ 805 more rows
# ℹ 3 more variables: hour &lt;dbl&gt;, minute &lt;dbl&gt;, time_hour &lt;dttm&gt;</code></pre>
</div>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>Even though colloquially speaking one might say “all flights leaving Burlington, Vermont <em>and</em> Seattle, Washington,” in terms of computer logical operations, we really mean “all flights leaving Burlington, Vermont <em>or</em> Seattle, Washington.” For a given row in the data, <code>dest</code> can be <code>BTV</code>, <code>SEA</code>, or something else, but not <code>BTV</code> <strong>and</strong> <code>SEA</code> at the same time.</p>
</div>
</div>
<p>Another example uses <code>!</code> to pick rows that <em>do not</em> match a condition. The <code>!</code> can be read as <strong>not</strong>. Here, we are selecting rows corresponding to flights that <strong>did not</strong> go to Burlington, VT or Seattle, WA.</p>
<div class="cell" data-exercise="true">
<details><summary>Code</summary><div class="sourceCode" id="cb32"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">not_BTV_SEA</span> <span class="op">&lt;-</span> <span class="va">flights</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="op">!</span><span class="op">(</span><span class="va">dest</span> <span class="op">==</span> <span class="st">"BTV"</span> <span class="op">|</span> <span class="va">dest</span> <span class="op">==</span> <span class="st">"SEA"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">not_BTV_SEA</span><span class="op">[</span>,<span class="op">-</span><span class="op">(</span><span class="fl">6</span><span class="op">:</span><span class="fl">12</span><span class="op">)</span><span class="op">]</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code># A tibble: 330,264 × 12
    year month   day dep_time sched_dep_time origin dest  air_time distance
   &lt;int&gt; &lt;int&gt; &lt;int&gt;    &lt;int&gt;          &lt;int&gt; &lt;chr&gt;  &lt;chr&gt;    &lt;dbl&gt;    &lt;dbl&gt;
 1  2013     1     1      517            515 EWR    IAH        227     1400
 2  2013     1     1      533            529 LGA    IAH        227     1416
 3  2013     1     1      542            540 JFK    MIA        160     1089
 4  2013     1     1      544            545 JFK    BQN        183     1576
 5  2013     1     1      554            600 LGA    ATL        116      762
 6  2013     1     1      554            558 EWR    ORD        150      719
 7  2013     1     1      555            600 EWR    FLL        158     1065
 8  2013     1     1      557            600 LGA    IAD         53      229
 9  2013     1     1      557            600 JFK    MCO        140      944
10  2013     1     1      558            600 LGA    ORD        138      733
# ℹ 330,254 more rows
# ℹ 3 more variables: hour &lt;dbl&gt;, minute &lt;dbl&gt;, time_hour &lt;dttm&gt;</code></pre>
</div>
<details><summary>Code</summary><div class="sourceCode" id="cb34"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># We do not display columns 6-11 so we can see the "origin" and "dest" variables.</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>As a final note we point out that <code>filter</code> should often be the first verb you’ll apply to your data. This narrows down the data to just the observations your are interested in.</p>
<div class="callout callout-style-default callout-warning no-icon callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Task
</div>
</div>
<div class="callout-body-container callout-body">
<p>What is another way of using the <strong>not</strong> operator <code>!</code> to filter only the rows that are not going to Burlington, VT nor Seattle, WA in the <code>flights</code> data frame?</p>
<div class="webex-solution">
<button>
Take a hint
</button>
<p>Try using the <code>%in%</code> operator</p>
</div>
<div class="cell" data-webex.hide="Click here to see the solution">
<div class="webex-solution">
<button>
Click here to see the solution
</button>
<details open=""><summary>Code</summary><div class="sourceCode" id="cb35"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">flights</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span> <span class="op">!</span><span class="va">dest</span> <span class="op"><a href="https://rdrr.io/r/base/match.html">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"BTV"</span>,<span class="st">"SEA"</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code># A tibble: 6 × 19
   year month   day dep_time sched_dep_time dep_delay arr_time sched_arr_time
  &lt;int&gt; &lt;int&gt; &lt;int&gt;    &lt;int&gt;          &lt;int&gt;     &lt;dbl&gt;    &lt;int&gt;          &lt;int&gt;
1  2013     1     1      517            515         2      830            819
2  2013     1     1      533            529         4      850            830
3  2013     1     1      542            540         2      923            850
4  2013     1     1      544            545        -1     1004           1022
5  2013     1     1      554            600        -6      812            837
6  2013     1     1      554            558        -4      740            728
# ℹ 11 more variables: arr_delay &lt;dbl&gt;, carrier &lt;chr&gt;, flight &lt;int&gt;,
#   tailnum &lt;chr&gt;, origin &lt;chr&gt;, dest &lt;chr&gt;, air_time &lt;dbl&gt;, distance &lt;dbl&gt;,
#   hour &lt;dbl&gt;, minute &lt;dbl&gt;, time_hour &lt;dttm&gt;</code></pre>
</div>
</div>
</div>
</div>
</div>
</section><section id="summarize" class="level1" data-number="9"><h1 data-number="9">
<span class="header-section-number">9</span> Summarise variables using summarize</h1>
<p>The next common task is to be able to summarise data: take a large number of values and summarise them with a single value. While this may seem like a very abstract idea, something as simple as the sum, the smallest value, and the largest values are all summaries of a large number of values.</p>
<div class="cell">
<div class="cell-output-display">
<p><img src="summary.png" class="img-fluid" width="343"></p>
</div>
</div>
<p>We can calculate the standard deviation and mean of the temperature variable <code>temp</code> in the <code>weather</code> data frame of <code>nycflights13</code> in one step using the <code>summarize</code> (or equivalently using the UK spelling <code>summarise</code>) function in <code>dplyr</code></p>
<div class="cell">
<details><summary>Code</summary><div class="sourceCode" id="cb37"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">summary_temp</span> <span class="op">&lt;-</span> <span class="va">weather</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarize</a></span><span class="op">(</span>mean <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">temp</span><span class="op">)</span>, std_dev <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/sd.html">sd</a></span><span class="op">(</span><span class="va">temp</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell">
<div class="cell-output-display">
<table class="table table-sm table-striped small" data-quarto-postprocess="true">
<thead><tr class="header">
<th style="text-align: right;" data-quarto-table-cell-role="th">mean</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">std_dev</th>
</tr></thead>
<tbody><tr class="odd">
<td style="text-align: right;">NA</td>
<td style="text-align: right;">NA</td>
</tr></tbody>
</table>
</div>
</div>
<p>We have created a small data frame here called <code>summary_temp</code> that includes both the mean (<code>mean</code>) and standard deviation (<code>std_dev</code>) of the <code>temp</code> variable in <code>weather</code>. Notice, the data frame <code>weather</code> went from many rows to a single row of just the summary values in the data frame <code>summary_temp</code>.</p>
<p>But why are the values returned <code>NA</code>? This stands for <strong>not available or not applicable</strong> and is how R encodes <strong>missing values</strong>; if in a data frame for a particular row and column no value exists, <code>NA</code> is stored instead. Furthermore, by default any time you try to summarise a number of values (using <code><a href="https://rdrr.io/r/base/mean.html">mean()</a></code> and <code><a href="https://rdrr.io/r/stats/sd.html">sd()</a></code> for example) that has one or more missing values, then <code>NA</code> is returned.</p>
<p>Values can be missing for many reasons. Perhaps the data was collected but someone forgot to enter it? Perhaps the data was not collected at all because it was too difficult? Perhaps there was an erroneous value that someone entered that was changed to read as missing? You’ll often encounter issues with missing values.</p>
<p>You can summarise all non-missing values by setting the <code>na.rm</code> argument to TRUE (<code>rm</code> is short for remove). This will remove any <code>NA</code> missing values and only return the summary value for all non-missing values. So the code below computes the mean and standard deviation of all non-missing values. Notice how the <code>na.rm=TRUE</code> are set as arguments to the <code>mean</code> and <code>sd</code> functions, and not to the <code>summarize</code> function.</p>
<div class="cell">
<details><summary>Code</summary><div class="sourceCode" id="cb38"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">summary_temp</span> <span class="op">&lt;-</span> <span class="va">weather</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarize</a></span><span class="op">(</span>mean <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">temp</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>, std_dev <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/sd.html">sd</a></span><span class="op">(</span><span class="va">temp</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell">
<div class="cell-output-display">
<table class="table table-sm table-striped small" data-quarto-postprocess="true">
<thead><tr class="header">
<th style="text-align: right;" data-quarto-table-cell-role="th">mean</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">std_dev</th>
</tr></thead>
<tbody><tr class="odd">
<td style="text-align: right;">55.26039</td>
<td style="text-align: right;">17.78785</td>
</tr></tbody>
</table>
</div>
</div>
<p>Another very useful function that allows you to summarise multiple columns is the <code><a href="https://dplyr.tidyverse.org/reference/summarise_all.html">summarise_at()</a></code> function. Here, we can supply a vector of variables we want to summarise and a list of functions that we want to apply to each of the variables. See the following example where we compute the minimum and maximum values of temperature and relative humidity (notice that we also specified the argument <code>na.rm=T</code> to remove missing values - this arguments gets passed on to all the functions in the list):</p>
<div class="cell">
<details><summary>Code</summary><div class="sourceCode" id="cb39"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">weather</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise_all.html">summarise_at</a></span><span class="op">(</span>.vars <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"temp"</span>,<span class="st">"humid"</span><span class="op">)</span>,</span>
<span>               .funs <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>min <span class="op">=</span> <span class="va">min</span>, max <span class="op">=</span> <span class="va">max</span><span class="op">)</span>,</span>
<span>               na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code># A tibble: 1 × 4
  temp_min humid_min temp_max humid_max
     &lt;dbl&gt;     &lt;dbl&gt;    &lt;dbl&gt;     &lt;dbl&gt;
1     10.9      12.7     100.       100</code></pre>
</div>
</div>
<p>It is <strong>not</strong> good practice to include <code>na.rm = TRUE</code> in your summary commands by default; you should attempt to run code first without this argument as this will alert you to the presence of missing data. Only after you have identified where missing values occur and have thought about the potential issues of these should you consider using <code>na.rm = TRUE</code>. In the upcoming Tasks we will consider the possible ramifications of blindly sweeping rows with missing values under the rug.</p>
<p>What other summary functions can we use inside the <code>summarize</code> verb? Any function in R that takes a vector of values and returns just one. Here are just a few:</p>
<ul>
<li>
<code>mean</code>: the mean (or average)</li>
<li>
<code>sd</code>: the standard deviation, which is a measure of spread</li>
<li>
<code>min</code> and <code>max</code>: the minimum and maximum values, respectively</li>
<li>
<code>IQR</code>: the interquartile range</li>
<li>
<code>sum</code>: the sum</li>
<li>
<code>n</code>: a count of the number of rows/observations in each group. This particular summary function will make more sense when <code>group_by</code> is used in the next section.</li>
</ul>
<div class="callout callout-style-default callout-tip no-icon callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<i class="bi-question-octagon " style="color: #6dc83c;" role="img" aria-hidden="true"></i> Question
</div>
</div>
<div class="callout-body-container callout-body">
<p>Say a doctor is studying the effect of smoking on lung cancer for a large number of patients who have records measured at five year intervals. She notices that a large number of patients have missing data points because the patient has died, so she chooses to ignore these patients in her analysis. What is wrong with this doctor’s approach?</p>
<div id="radio_XPXZYAOMQP" class="webex-radiogroup">
<label><input type="radio" autocomplete="off" name="radio_XPXZYAOMQP" value="answer"><span>Introduces a selection bias since patient who died due to lung cancer are excluded from the analysis, leading to an underestimation of the true impact of smoking on lung cancer risk</span></label><label><input type="radio" autocomplete="off" name="radio_XPXZYAOMQP" value=""><span>There is no problem, smaller datasets with fewer missing values may require less computational resources, leading to faster processing times.</span></label><label><input type="radio" autocomplete="off" name="radio_XPXZYAOMQP" value="answer"><span>Removing patients with missing data reduces the sample size. Hence, conclusions may not be as easily generalizable to the broader population, as the excluded patients may represent a different subset with unique characteristics.</span></label><label><input type="radio" autocomplete="off" name="radio_XPXZYAOMQP" value=""><span>Removing missing values can result in a dataset with fewer errors and inconsistencies, which can lead to more accurate analyses.</span></label>
</div>
</div>
</div>
<div class="callout callout-style-default callout-tip no-icon callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<i class="bi-question-octagon " style="color: #6dc83c;" role="img" aria-hidden="true"></i> Question
</div>
</div>
<div class="callout-body-container callout-body">
<p>Modify <code>summary_temp</code> from above to also use the <code>n</code> summary function: <code>summarize(count = n())</code>. What does the returned value correspond to?</p>
<p><select class="webex-select"><option value="blank"></option>
<option value="">Number of weather stations</option>
<option value="">Number of columns in the data</option>
<option value="answer">Sample size</option></select></p>
</div>
</div>
<div class="callout callout-style-default callout-tip no-icon callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<i class="bi-question-octagon " style="color: #6dc83c;" role="img" aria-hidden="true"></i> Question
</div>
</div>
<div class="callout-body-container callout-body">
<p>Why does the code below not work?</p>
<div class="cell">
<details open=""><summary>Code</summary><div class="sourceCode" id="cb41"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">summary_temp</span> <span class="op">&lt;-</span> <span class="va">weather</span> <span class="op">|&gt;</span>   </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarize</a></span><span class="op">(</span>mean <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">temp</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarize</a></span><span class="op">(</span>std_dev <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/sd.html">sd</a></span><span class="op">(</span><span class="va">temp</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-error">
<pre><code>Error in `summarize()`:
ℹ In argument: `std_dev = sd(temp, na.rm = TRUE)`.
Caused by error in `is.data.frame()`:
! object 'temp' not found</code></pre>
</div>
</div>
<div class="webex-solution">
<button>
Take hint
</button>
<p>Run the code line by line instead of all at once, and then look at the data. In other words, run <code>summary_temp &lt;- weather |&gt; summarize(mean = mean(temp, na.rm = TRUE))</code> first.</p>
</div>
<div class="webex-solution">
<button>
Answer
</button>
<p>The first line of code computes the temperature mean for the weather data set. Then, the output gets passed on to <code>weather |&gt; summarize(std_dev= sd(temp, na.rm = TRUE))</code>. However, the temperature value is no longer present in the first result, hence the error: <code>! object 'temp' not found</code></p>
</div>
</div>
</div>
</section><section id="groupby" class="level1" data-number="10"><h1 data-number="10">
<span class="header-section-number">10</span> Group rows using grouping structures</h1>
<div class="cell">
<div class="cell-output-display">
<p><img src="group_summary.png" class="img-fluid" width="472"></p>
</div>
</div>
<p>It is often more useful to summarise a variable based on the groupings of another variable. Let’s say we are interested in the mean and standard deviation of temperatures but <em>grouped by month</em>. To be more specific: we want the mean and standard deviation of temperatures</p>
<ol type="1">
<li>split by month.</li>
<li>sliced by month.</li>
<li>aggregated by month.</li>
<li>collapsed over month.</li>
</ol>
<p>Run the following code:</p>
<div class="cell">
<details><summary>Code</summary><div class="sourceCode" id="cb43"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">summary_monthly_temp</span> <span class="op">&lt;-</span> <span class="va">weather</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarize</a></span><span class="op">(</span>mean <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">temp</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>, </span>
<span>            std_dev <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/sd.html">sd</a></span><span class="op">(</span><span class="va">temp</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>            .by <span class="op">=</span> <span class="va">month</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>This code is identical to the previous code that created <code>summary_temp</code>, with an extra <code>.by = month</code> added. This kind per-operation grouping allow us to do the grouping within the operation where the summarisation takes place without changing the structure of the data .</p>
<div id="note_grouping" class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>Previous versions of <code>dplyr</code> relied on the specification of a <code>group_by</code> function within the pipeline to do the grouping. For example, in the next line of code the <code>weather</code> data set is initially grouped by <code>month</code>and then passed as a new grouped data frame into <code>summarize</code>. Yielding to the same data frame that shows the mean and standard deviation of temperature for each month in New York City:</p>
<div class="cell">
<details><summary>Code</summary><div class="sourceCode" id="cb44"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">summary_monthly_temp</span> <span class="op">&lt;-</span> <span class="va">weather</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">month</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarize</a></span><span class="op">(</span>mean <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">temp</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>, </span>
<span>            std_dev <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/sd.html">sd</a></span><span class="op">(</span><span class="va">temp</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>While<code>group_by</code> doesn’t change the data frame, it sets <em>meta-data</em> (data about the data), specifically the group structure of the data. If we wanted to remove this group structure meta-data, we could add the <code>.groups = "drop"</code> option.</p>
<div class="cell">
<details open=""><summary>Code</summary><div class="sourceCode" id="cb45"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">summary_monthly_temp</span> <span class="op">&lt;-</span> <span class="va">weather</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">month</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarize</a></span><span class="op">(</span>mean <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">temp</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>, </span>
<span>            std_dev <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/sd.html">sd</a></span><span class="op">(</span><span class="va">temp</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>            .groups <span class="op">=</span> <span class="st">"drop"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>The advantage of using the <code>.by</code> argument is that the grouping occurs within the <code>summarise</code> function and thus the resulting data frame is no longer grouped.</p>
</div>
</div>
<div class="callout callout-style-default callout-tip no-icon callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<i class="bi-question-octagon " style="color: #6dc83c;" role="img" aria-hidden="true"></i> Question
</div>
</div>
<div class="callout-body-container callout-body">
<p>The <code><a href="https://tidyr.tidyverse.org/reference/drop_na.html">drop_na()</a></code> function can be used in the pipeline to remove missing observations from a data set. Try running the following code to compute the mean and standard deviation of the temperature in the <code>weather</code> data set and comment on the output. Why is this different from one one we had before?</p>
<div class="cell">
<details><summary>Code</summary><div class="sourceCode" id="cb46"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">summary_monthly_temp</span> <span class="op">&lt;-</span> <span class="va">weather</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/drop_na.html">drop_na</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarize</a></span><span class="op">(</span>mean <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">temp</span><span class="op">)</span>, </span>
<span>            std_dev <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/sd.html">sd</a></span><span class="op">(</span><span class="va">temp</span><span class="op">)</span>,</span>
<span>            .by <span class="op">=</span> <span class="va">month</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="webex-solution">
<button>
Answer
</button>
<p>The <code><a href="https://tidyr.tidyverse.org/reference/drop_na.html">drop_na()</a></code> function remove all missing observation from the data set while specifying <code>na.rm =T</code> in each summarizing function only removes the missing values for the specific variable to which the function is applied.</p>
</div>
</div>
</div>
<p>We now revisit the <code>n</code> counting summary function we introduced in the previous section. For example, suppose we would like to get a sense for how many flights departed each of the three airports in New York City:</p>
<div class="cell">
<details><summary>Code</summary><div class="sourceCode" id="cb47"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">by_origin</span> <span class="op">&lt;-</span> <span class="va">flights</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarize</a></span><span class="op">(</span>count <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/context.html">n</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>            .by <span class="op">=</span><span class="va">origin</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell">
<div class="cell-output-display">
<table class="table table-sm table-striped small" data-quarto-postprocess="true">
<thead><tr class="header">
<th style="text-align: left;" data-quarto-table-cell-role="th">origin</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">count</th>
</tr></thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">EWR</td>
<td style="text-align: right;">120835</td>
</tr>
<tr class="even">
<td style="text-align: left;">JFK</td>
<td style="text-align: right;">111279</td>
</tr>
<tr class="odd">
<td style="text-align: left;">LGA</td>
<td style="text-align: right;">104662</td>
</tr>
</tbody>
</table>
</div>
</div>
<p>We see that Newark (<code>EWR</code>) had the most flights departing in 2013 followed by <code>JFK</code> and lastly by LaGuardia (<code>LGA</code>). Note, there is a subtle but important difference between <code>sum</code> and <code>n</code>. While <code>sum</code> simply adds up a large set of numbers, the latter counts the number of times each of many different values occur.</p>
<section id="grouping-by-more-than-one-variable" class="level2" data-number="10.1"><h2 data-number="10.1" class="anchored" data-anchor-id="grouping-by-more-than-one-variable">
<span class="header-section-number">10.1</span> Grouping by more than one variable</h2>
<p>You are not limited to grouping by one variable. Say you wanted to know the number of flights leaving each of the three New York City airports <em>for each month</em>, we can also group by a second variable <code>month</code>:</p>
<div class="cell">
<details open=""><summary>Code</summary><div class="sourceCode" id="cb48"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">by_origin_monthly</span> <span class="op">&lt;-</span> <span class="va">flights</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarize</a></span><span class="op">(</span>count <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/context.html">n</a></span><span class="op">(</span><span class="op">)</span>, </span>
<span>            .by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">origin</span>, <span class="va">month</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">by_origin_monthly</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code># A tibble: 36 × 3
   origin month count
   &lt;chr&gt;  &lt;int&gt; &lt;int&gt;
 1 EWR        1  9893
 2 LGA        1  7950
 3 JFK        1  9161
 4 EWR       10 10104
 5 JFK       10  9143
 6 LGA       10  9642
 7 JFK       11  8710
 8 EWR       11  9707
 9 LGA       11  8851
10 JFK       12  9146
# ℹ 26 more rows</code></pre>
</div>
</div>
<p>We see there are 36 rows for <code>by_origin_monthly</code> because there are 12 months times 3 airports (<code>EWR</code>, <code>JFK</code>, and <code>LGA</code>). Let’s now pose a question.</p>
<ol type="1">
<li>First, what if we reverse the order of the grouping, i.e.&nbsp;<code>.by = c(month, origin)</code>?</li>
</ol>
<div class="cell">
<details><summary>Code</summary><div class="sourceCode" id="cb50"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">by_monthly_origin</span> <span class="op">&lt;-</span> <span class="va">flights</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarize</a></span><span class="op">(</span>count <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/context.html">n</a></span><span class="op">(</span><span class="op">)</span>, </span>
<span>            .by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">month</span>,<span class="va">origin</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">by_monthly_origin</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code># A tibble: 36 × 3
   month origin count
   &lt;int&gt; &lt;chr&gt;  &lt;int&gt;
 1     1 EWR     9893
 2     1 LGA     7950
 3     1 JFK     9161
 4    10 EWR    10104
 5    10 JFK     9143
 6    10 LGA     9642
 7    11 JFK     8710
 8    11 EWR     9707
 9    11 LGA     8851
10    12 JFK     9146
# ℹ 26 more rows</code></pre>
</div>
</div>
<p>In <code>by_monthly_origin</code> the <code>month</code> column is now first and the rows are sorted by <code>month</code> instead of origin. If you compare the values of <code>count</code> in <code>by_origin_monthly</code> and <code>by_monthly_origin</code> using the <code>View</code> function, you’ll see that the values are actually the same, just presented in a different order.</p>
<div class="callout callout-style-default callout-tip no-icon callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<i class="bi-question-octagon " style="color: #6dc83c;" role="img" aria-hidden="true"></i> Question
</div>
</div>
<div class="callout-body-container callout-body">
<p>Recall from Week 1 when we looked at plots of temperatures by months in NYC. What does the standard deviation column in the <code>summary_monthly_temp</code> data frame tell us about temperatures in New York City throughout the year?</p>
<div id="radio_QXIICITMSJ" class="webex-radiogroup">
<label><input type="radio" autocomplete="off" name="radio_QXIICITMSJ" value=""><span>Temperature are lower in the winter </span></label><label><input type="radio" autocomplete="off" name="radio_QXIICITMSJ" value="answer"><span>Temperature variability increases during winter</span></label><label><input type="radio" autocomplete="off" name="radio_QXIICITMSJ" value=""><span>Spring is the season with more outliers </span></label>
</div>
</div>
</div>
<div class="callout callout-style-default callout-warning no-icon callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Task
</div>
</div>
<div class="callout-body-container callout-body">
<p>Write code to produce the mean and standard deviation temperature for each day in 2013 for NYC</p>
<div class="webex-solution">
<button>
Take a hint
</button>
<p>See the documentation for <code><a href="https://rdrr.io/r/graphics/plot.default.html">plot()</a></code> (<code><a href="https://rdrr.io/r/graphics/plot.default.html">?plot</a></code>)</p>
</div>
<div class="cell" data-webex.hide="Click here to see the solution">
<div class="webex-solution">
<button>
Click here to see the solution
</button>
<details open=""><summary>Code</summary><div class="sourceCode" id="cb52"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span> <span class="va">weather</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarize</a></span><span class="op">(</span>mean <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">temp</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>, </span>
<span>            std_dev <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/sd.html">sd</a></span><span class="op">(</span><span class="va">temp</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>            .by <span class="op">=</span> <span class="va">day</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code># A tibble: 31 × 3
     day  mean std_dev
   &lt;int&gt; &lt;dbl&gt;   &lt;dbl&gt;
 1     1  57.6    17.4
 2     2  55.7    20.2
 3     3  53.8    18.9
 4     4  54.0    18.8
 5     5  55.6    16.2
 6     6  55.7    15.6
 7     7  55.6    17.4
 8     8  55.0    17.6
 9     9  56.6    17.4
10    10  56.9    17.8
# ℹ 21 more rows</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="callout callout-style-default callout-warning no-icon callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Task
</div>
</div>
<div class="callout-body-container callout-body">
<p>How could we identify how many flights left each of the three airports for each <code>carrier</code>? Can you create a bar plot showing these results?</p>
<div class="webex-solution">
<button>
Take a hint
</button>
<p>You can count how many flights left each of the three airports by summarising the data using the <code><a href="https://dplyr.tidyverse.org/reference/context.html">n()</a></code> function while grouping by the origin and carrier. Then, you can pass the resulting data frame to <code>ggplot</code> using the pipeline command <code>|&gt;</code> and use a <code>geom_col</code> layer as we saw in the previous week.</p>
</div>
<div class="cell" data-webex.hide="Click here to see the solution">
<div class="webex-solution">
<button>
Click here to see the solution
</button>
<details open=""><summary>Code</summary><div class="sourceCode" id="cb54"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">flights</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarise</a></span><span class="op">(</span>count <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/context.html">n</a></span><span class="op">(</span><span class="op">)</span>, </span>
<span>            .by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">origin</span>,<span class="va">carrier</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">carrier</span>, y <span class="op">=</span> <span class="va">count</span>, fill <span class="op">=</span> <span class="va">origin</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_bar.html">geom_col</a></span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<p><img src="index_files/figure-html/unnamed-chunk-34-1.png" class="img-fluid" width="672"></p>
</div>
</div>
</div>
</div>
</div>
</section></section><section id="mutate" class="level1" data-number="11"><h1 data-number="11">
<span class="header-section-number">11</span> Create new variables/change old variables using mutate</h1>
<div class="cell">
<div class="cell-output-display">
<p><img src="mutate.png" class="img-fluid" width="612"></p>
</div>
</div>
<p>When looking at the <code>flights</code> data set, there are some clear additional variables that could be calculated based on the values of variables already in the data set. Passengers are often frustrated when their flights depart late, but change their mood a bit if pilots can make up some time during the flight to get them to their destination close to when they expected to land. This is commonly referred to as “gain” and we will create this variable using the <code>mutate</code> function. Note that we will be overwriting the <code>flights</code> data frame with one including the additional variable <code>gain</code> here, or put differently, the <code>mutate</code> command outputs a new data frame which then gets saved over the original <code>flights</code> data frame.</p>
<div class="cell">
<details><summary>Code</summary><div class="sourceCode" id="cb55"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">flights</span> <span class="op">&lt;-</span> <span class="va">flights</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>gain <span class="op">=</span> <span class="va">dep_delay</span> <span class="op">-</span> <span class="va">arr_delay</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Let’s take a look at <code>dep_delay</code>, <code>arr_delay</code>, and the resulting <code>gain</code> variables in our new <code>flights</code> data frame:</p>
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 336,776 × 3
   dep_delay arr_delay  gain
       &lt;dbl&gt;     &lt;dbl&gt; &lt;dbl&gt;
 1         2        11    -9
 2         4        20   -16
 3         2        33   -31
 4        -1       -18    17
 5        -6       -25    19
 6        -4        12   -16
 7        -5        19   -24
 8        -3       -14    11
 9        -3        -8     5
10        -2         8   -10
# ℹ 336,766 more rows</code></pre>
</div>
</div>
<p>The flight in the first row departed 2 minutes late but arrived 11 minutes late, so its “gained time in the air” is actually a loss of 9 minutes, hence its <code>gain</code> is <code>-9</code>. Contrast this to the flight in the fourth row which departed a minute early (<code>dep_delay</code> of <code>-1</code>) but arrived 18 minutes early (<code>arr_delay</code> of <code>-18</code>), so its “gained time in the air” is 17 minutes, hence its <code>gain</code> is <code>+17</code>.</p>
<p>Why did we overwrite <code>flights</code> instead of assigning the resulting data frame to a new object, like <code>flights_with_gain</code>? As a rough rule of thumb, as long as you are not losing information that you might need later, it’s acceptable practice to overwrite data frames. However, if you overwrite existing variables and/or change the observational units, recovering the original information might prove difficult. In this case, it might make sense to create a new data object.</p>
<p>Let’s look at summary measures of this <code>gain</code> variable and plot it in the form of a histogram:</p>
<div class="cell">
<details><summary>Code</summary><div class="sourceCode cell-code" id="cb57"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a>gain_summary <span class="ot">&lt;-</span> flights <span class="sc">|&gt;</span> </span>
<span id="cb57-2"><a href="#cb57-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(</span>
<span id="cb57-3"><a href="#cb57-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">min =</span> <span class="fu">min</span>(gain, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb57-4"><a href="#cb57-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">q1 =</span> <span class="fu">quantile</span>(gain, <span class="fl">0.25</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb57-5"><a href="#cb57-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">median =</span> <span class="fu">quantile</span>(gain, <span class="fl">0.5</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb57-6"><a href="#cb57-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">q3 =</span> <span class="fu">quantile</span>(gain, <span class="fl">0.75</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb57-7"><a href="#cb57-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">max =</span> <span class="fu">max</span>(gain, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb57-8"><a href="#cb57-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">mean =</span> <span class="fu">mean</span>(gain, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb57-9"><a href="#cb57-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">sd =</span> <span class="fu">sd</span>(gain, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb57-10"><a href="#cb57-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">missing =</span> <span class="fu">sum</span>(<span class="fu">is.na</span>(gain))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell">
<div class="cell-output-display">
<table class="table table-sm table-striped small" data-quarto-postprocess="true">
<thead><tr class="header">
<th style="text-align: right;" data-quarto-table-cell-role="th">min</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">q1</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">median</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">q3</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">max</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">mean</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">sd</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">missing</th>
</tr></thead>
<tbody><tr class="odd">
<td style="text-align: right;">-196</td>
<td style="text-align: right;">-3</td>
<td style="text-align: right;">7</td>
<td style="text-align: right;">17</td>
<td style="text-align: right;">109</td>
<td style="text-align: right;">5.659779</td>
<td style="text-align: right;">18.04365</td>
<td style="text-align: right;">9430</td>
</tr></tbody>
</table>
</div>
</div>
<p>We have recreated the <code>summary</code> function we saw in Week 1 here using the <code>summarize</code> function in <code>dplyr</code>. Lets make a histogram for the new created <code>gain</code> variable.</p>
<div class="cell" data-layout-align="center">
<details><summary>Code</summary><div class="sourceCode" id="cb58"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">flights</span>, mapping <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">gain</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_histogram.html">geom_histogram</a></span><span class="op">(</span>color <span class="op">=</span> <span class="st">"white"</span>, bins <span class="op">=</span> <span class="fl">20</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><img src="index_files/figure-html/unnamed-chunk-39-1.png" class="img-fluid figure-img" width="672"></p>
<figcaption class="figure-caption">Histogram of gain variable.</figcaption></figure>
</div>
</div>
</div>
<p>We can also create multiple columns at once and even refer to columns that were just created in a new column.</p>
<div class="cell">
<details><summary>Code</summary><div class="sourceCode" id="cb59"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">flights</span> <span class="op">&lt;-</span> <span class="va">flights</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span></span>
<span>    gain <span class="op">=</span> <span class="va">dep_delay</span> <span class="op">-</span> <span class="va">arr_delay</span>,</span>
<span>    hours <span class="op">=</span> <span class="va">air_time</span> <span class="op">/</span> <span class="fl">60</span>,</span>
<span>    gain_per_hour <span class="op">=</span> <span class="va">gain</span> <span class="op">/</span> <span class="va">hours</span></span>
<span>  <span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="callout callout-style-default callout-tip no-icon callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<i class="bi-question-octagon " style="color: #6dc83c;" role="img" aria-hidden="true"></i> Question
</div>
</div>
<div class="callout-body-container callout-body">
<p>What do positive values of the <code>gain</code> variable in <code>flights</code> correspond to?</p>
<p><select class="webex-select"><option value="blank"></option>
<option value="answer">Departure delays are greater than arrivals delays</option>
<option value="">Departure delays are lower than arrivals delays</option>
<option value="">Departures and arrivals delays are the same</option></select></p>
<p>What about negative values?</p>
<p><select class="webex-select"><option value="blank"></option>
<option value="">Departure delays are greater than arrivals delays</option>
<option value="answer">Departure delays are lower than arrivals delays</option>
<option value="">Departures and arrivals delays are the same</option></select></p>
<p>And what about a zero value?</p>
<p><select class="webex-select"><option value="blank"></option>
<option value="">Departure delays are greater than arrivals delays</option>
<option value="">Departuredelays are lower than arrivals delays</option>
<option value="answer">Departures and arrivals delays are the same</option></select></p>
</div>
</div>
<div class="callout callout-style-default callout-tip no-icon callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<i class="bi-question-octagon " style="color: #6dc83c;" role="img" aria-hidden="true"></i> Question
</div>
</div>
<div class="callout-body-container callout-body">
<p>Could we create the <code>dep_delay</code> and <code>arr_delay</code> columns by simply subtracting <code>dep_time</code> from <code>sched_dep_time</code> and similarly for arrivals? Try the code out and explain any differences between the result and what actually appears in <code>flights</code>.</p>
<div class="cell">
<details open=""><summary>Code</summary><div class="sourceCode" id="cb60"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">flights</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>dep_delay  <span class="op">=</span> <span class="va">sched_dep_time</span> <span class="op">-</span> <span class="va">dep_time</span> ,</span>
<span>         arr_delay  <span class="op">=</span> <span class="va">sched_arr_time</span>  <span class="op">-</span> <span class="va">arr_time</span><span class="op">)</span>  </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="webex-solution">
<button>
Take a hint
</button>
<p>See the description of the variables <code>arr_time</code>, <code>dep_time</code>, <code>sched_dep_time</code> and <code>sched_arr_time</code> in the flights data set <code><a href="https://rdrr.io/pkg/nycflights13/man/flights.html">?flights</a></code></p>
</div>
<div class="webex-solution">
<button>
Answer
</button>
<p>The differences are due to departure and arrival times have a HHMM or HMM format. E.g., if we compute the difference between a flight scheduled to arrive by 923 and its actual arrival time at 850, the result would be a difference of 73, while in reality there was only a 33 min difference if we consider the correct time format!</p>
</div>
</div>
</div>
</section><section id="arrange" class="level1" data-number="12"><h1 data-number="12">
<span class="header-section-number">12</span> Reorder the data frame using arrange</h1>
<p>One of the most common things people working with data would like to do is sort the data frames by a specific variable in a column. Have you ever been asked to calculate a median by hand? This requires you to put the data in order from smallest to highest in value. The <code>dplyr</code> package has a function called <code>arrange</code> that we will use to sort/reorder our data according to the values of the specified variable. This is often used after we have grouped and summarized the data as we will see.</p>
<p>Let’s suppose we were interested in determining the most frequent destination airports from New York City in 2013:</p>
<div class="cell">
<details><summary>Code</summary><div class="sourceCode" id="cb61"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">freq_dest</span> <span class="op">&lt;-</span> <span class="va">flights</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarize</a></span><span class="op">(</span>num_flights <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/context.html">n</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>            .by <span class="op">=</span> <span class="va">dest</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code># A tibble: 105 × 2
   dest  num_flights
   &lt;chr&gt;       &lt;int&gt;
 1 IAH          7198
 2 MIA         11728
 3 BQN           896
 4 ATL         17215
 5 ORD         17283
 6 FLL         12055
 7 IAD          5700
 8 MCO         14082
 9 PBI          6554
10 TPA          7466
# ℹ 95 more rows</code></pre>
</div>
</div>
<p>You’ll see that by default the values of <code>dest</code> are displayed in alphabetical order here. We are interested in finding those airports that appear most:</p>
<div class="cell">
<details><summary>Code</summary><div class="sourceCode" id="cb63"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">freq_dest</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html">arrange</a></span><span class="op">(</span><span class="va">num_flights</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code># A tibble: 105 × 2
   dest  num_flights
   &lt;chr&gt;       &lt;int&gt;
 1 LEX             1
 2 LGA             1
 3 ANC             8
 4 SBN            10
 5 HDN            15
 6 MTJ            15
 7 EYW            17
 8 PSP            19
 9 JAC            25
10 BZN            36
# ℹ 95 more rows</code></pre>
</div>
</div>
<p>This is actually giving us the opposite of what we are looking for. It tells us the least frequent destination airports first. To switch the ordering to be descending instead of ascending we use the <code>desc</code> (<code>desc</code>ending) function:</p>
<div class="cell">
<details><summary>Code</summary><div class="sourceCode" id="cb65"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">freq_dest</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html">arrange</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/desc.html">desc</a></span><span class="op">(</span><span class="va">num_flights</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code># A tibble: 105 × 2
   dest  num_flights
   &lt;chr&gt;       &lt;int&gt;
 1 ORD         17283
 2 ATL         17215
 3 LAX         16174
 4 BOS         15508
 5 MCO         14082
 6 CLT         14064
 7 SFO         13331
 8 FLL         12055
 9 MIA         11728
10 DCA          9705
# ℹ 95 more rows</code></pre>
</div>
</div>
</section><section id="joins" class="level1" data-number="13"><h1 data-number="13">
<span class="header-section-number">13</span> Joining data frames</h1>
<p>Another common task is joining (merging) two different data sets. For example, in the <code>flights</code> data, the variable <code>carrier</code> lists the carrier code for the different flights. While <code>UA</code> and <code>AA</code> might be somewhat easy to guess for some (United and American Airlines), what are VX, HA, and B6? This information is provided in a separate data frame <code>airlines</code>.</p>
<div class="cell">
<details><summary>Code</summary><div class="sourceCode" id="cb67"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">airlines</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code># A tibble: 16 × 2
   carrier name                       
   &lt;chr&gt;   &lt;chr&gt;                      
 1 9E      Endeavor Air Inc.          
 2 AA      American Airlines Inc.     
 3 AS      Alaska Airlines Inc.       
 4 B6      JetBlue Airways            
 5 DL      Delta Air Lines Inc.       
 6 EV      ExpressJet Airlines Inc.   
 7 F9      Frontier Airlines Inc.     
 8 FL      AirTran Airways Corporation
 9 HA      Hawaiian Airlines Inc.     
10 MQ      Envoy Air                  
11 OO      SkyWest Airlines Inc.      
12 UA      United Air Lines Inc.      
13 US      US Airways Inc.            
14 VX      Virgin America             
15 WN      Southwest Airlines Co.     
16 YV      Mesa Airlines Inc.         </code></pre>
</div>
</div>
<p>We see that in <code>airports</code>, <code>carrier</code> is the carrier code while <code>name</code> is the full name of the airline. Using this table, we can see that VX, HA, and B6 correspond to Virgin America, Hawaiian Airlines Inc., and JetBlue Airways, respectively. However, will we have to continually look up the carrier’s name for each flight in the <code>airlines</code> data set? No! Instead of having to do this manually, we can have R automatically do the “looking up” for us.</p>
<p>Note that the values in the variable <code>carrier</code> in <code>flights</code> match the values in the variable <code>carrier</code> in <code>airlines</code>. In this case, we can use the variable <code>carrier</code> as a <em>key variable</em> to join/merge/match the two data frames by. Key variables are almost always identification variables that uniquely identify the observational units as we saw back in the <strong>Identification vs Measurement Variable</strong> section. This ensures that rows in both data frames are appropriately matched during the join. This diagram helps us understand how the different data sets are linked by various key variables:</p>
<div class="cell">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><img src="relational-nycflights.png" class="img-fluid figure-img" width="396"></p>
<figcaption class="figure-caption">Data relationships in nycflights13 from R for Data Science, Hadley and Garrett (2016).</figcaption></figure>
</div>
</div>
</div>
<section id="joining-by-key-variables" class="level2" data-number="13.1"><h2 data-number="13.1" class="anchored" data-anchor-id="joining-by-key-variables">
<span class="header-section-number">13.1</span> Joining by “key” variables</h2>
<p>In both <code>flights</code> and <code>airlines</code>, the key variable we want to join/merge/match the two data frames with has the same name in both data sets: <code>carriers</code>. We make use of the <code>inner_join</code> function to join by the variable <code>carrier</code>.</p>
<div class="cell">
<details><summary>Code</summary><div class="sourceCode" id="cb69"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">flights_joined</span> <span class="op">&lt;-</span> <span class="va">flights</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">inner_join</a></span><span class="op">(</span><span class="va">airlines</span>, </span>
<span>             by <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/join_by.html">join_by</a></span><span class="op">(</span><span class="va">carrier</span><span class="op">)</span><span class="op">)</span></span>
<span>             </span>
<span><span class="va">flights</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code># A tibble: 336,776 × 22
    year month   day dep_time sched_dep_time dep_delay arr_time sched_arr_time
   &lt;int&gt; &lt;int&gt; &lt;int&gt;    &lt;int&gt;          &lt;int&gt;     &lt;dbl&gt;    &lt;int&gt;          &lt;int&gt;
 1  2013     1     1      517            515         2      830            819
 2  2013     1     1      533            529         4      850            830
 3  2013     1     1      542            540         2      923            850
 4  2013     1     1      544            545        -1     1004           1022
 5  2013     1     1      554            600        -6      812            837
 6  2013     1     1      554            558        -4      740            728
 7  2013     1     1      555            600        -5      913            854
 8  2013     1     1      557            600        -3      709            723
 9  2013     1     1      557            600        -3      838            846
10  2013     1     1      558            600        -2      753            745
# ℹ 336,766 more rows
# ℹ 14 more variables: arr_delay &lt;dbl&gt;, carrier &lt;chr&gt;, flight &lt;int&gt;,
#   tailnum &lt;chr&gt;, origin &lt;chr&gt;, dest &lt;chr&gt;, air_time &lt;dbl&gt;, distance &lt;dbl&gt;,
#   hour &lt;dbl&gt;, minute &lt;dbl&gt;, time_hour &lt;dttm&gt;, gain &lt;dbl&gt;, hours &lt;dbl&gt;,
#   gain_per_hour &lt;dbl&gt;</code></pre>
</div>
<details><summary>Code</summary><div class="sourceCode" id="cb71"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">flights_joined</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code># A tibble: 336,776 × 23
    year month   day dep_time sched_dep_time dep_delay arr_time sched_arr_time
   &lt;int&gt; &lt;int&gt; &lt;int&gt;    &lt;int&gt;          &lt;int&gt;     &lt;dbl&gt;    &lt;int&gt;          &lt;int&gt;
 1  2013     1     1      517            515         2      830            819
 2  2013     1     1      533            529         4      850            830
 3  2013     1     1      542            540         2      923            850
 4  2013     1     1      544            545        -1     1004           1022
 5  2013     1     1      554            600        -6      812            837
 6  2013     1     1      554            558        -4      740            728
 7  2013     1     1      555            600        -5      913            854
 8  2013     1     1      557            600        -3      709            723
 9  2013     1     1      557            600        -3      838            846
10  2013     1     1      558            600        -2      753            745
# ℹ 336,766 more rows
# ℹ 15 more variables: arr_delay &lt;dbl&gt;, carrier &lt;chr&gt;, flight &lt;int&gt;,
#   tailnum &lt;chr&gt;, origin &lt;chr&gt;, dest &lt;chr&gt;, air_time &lt;dbl&gt;, distance &lt;dbl&gt;,
#   hour &lt;dbl&gt;, minute &lt;dbl&gt;, time_hour &lt;dttm&gt;, gain &lt;dbl&gt;, hours &lt;dbl&gt;,
#   gain_per_hour &lt;dbl&gt;, name &lt;chr&gt;</code></pre>
</div>
</div>
<p>We observe that the <code>flights</code> and <code>flights_joined</code> are identical except that <code>flights_joined</code> has an additional variable <code>name</code> whose values were drawn from <code>airlines</code>.</p>
<p>A visual representation of the <code>inner_join</code> is given below:</p>
<div class="cell">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><img src="join-inner.png" class="img-fluid figure-img" width="338"></p>
<figcaption class="figure-caption">Diagram of inner join from R for Data Science.</figcaption></figure>
</div>
</div>
</div>
<p>There are more complex joins available, but the <code>inner_join</code> will solve nearly all of the problems you will face here.</p>
</section><section id="joining-by-key-variables-with-different-names" class="level2" data-number="13.2"><h2 data-number="13.2" class="anchored" data-anchor-id="joining-by-key-variables-with-different-names">
<span class="header-section-number">13.2</span> Joining by “key” variables with different names</h2>
<p>Say instead, you are interested in all the destinations of flights from NYC in 2013 and ask yourself:</p>
<ul>
<li>“What cities are these airports in?”</li>
<li>“Is <code>ORD</code> Orlando?”</li>
<li>“Where is <code>FLL</code>?”</li>
</ul>
<p>The <code>airports</code> data frame contains airport codes:</p>
<div class="cell">
<details><summary>Code</summary><div class="sourceCode" id="cb73"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">airports</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code># A tibble: 1,458 × 8
   faa   name                             lat    lon   alt    tz dst   tzone    
   &lt;chr&gt; &lt;chr&gt;                          &lt;dbl&gt;  &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;chr&gt; &lt;chr&gt;    
 1 04G   Lansdowne Airport               41.1  -80.6  1044    -5 A     America/…
 2 06A   Moton Field Municipal Airport   32.5  -85.7   264    -6 A     America/…
 3 06C   Schaumburg Regional             42.0  -88.1   801    -6 A     America/…
 4 06N   Randall Airport                 41.4  -74.4   523    -5 A     America/…
 5 09J   Jekyll Island Airport           31.1  -81.4    11    -5 A     America/…
 6 0A9   Elizabethton Municipal Airport  36.4  -82.2  1593    -5 A     America/…
 7 0G6   Williams County Airport         41.5  -84.5   730    -5 A     America/…
 8 0G7   Finger Lakes Regional Airport   42.9  -76.8   492    -5 A     America/…
 9 0P2   Shoestring Aviation Airfield    39.8  -76.6  1000    -5 U     America/…
10 0S9   Jefferson County Intl           48.1 -123.    108    -8 A     America/…
# ℹ 1,448 more rows</code></pre>
</div>
</div>
<p>However, looking at both the <code>airports</code> and <code>flights</code> and the visual representation of the relations between the data frames in the figure above, we see that in:</p>
<ul>
<li>
<code>airports</code> the airport code is in the variable <code>faa</code>
</li>
<li>
<code>flights</code> the airport code is in the variable <code>origin</code>
</li>
</ul>
<p>So to join these two data sets, our <code>inner_join</code> operation involves a logical operator <code>==</code> argument that accounts for the different names.</p>
<div class="cell">
<details><summary>Code</summary><div class="sourceCode" id="cb75"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">flights</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">inner_join</a></span><span class="op">(</span><span class="va">airports</span>,</span>
<span>             by <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/join_by.html">join_by</a></span><span class="op">(</span><span class="va">dest</span> <span class="op">==</span> <span class="va">faa</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>We can read the code out loud as:</p>
<p>Let’s construct the sequence of commands that computes the number of flights from NYC to each destination, but also includes information about each destination airport:</p>
<div class="cell">
<details><summary>Code</summary><div class="sourceCode" id="cb76"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">named_dests</span> <span class="op">&lt;-</span> <span class="va">flights</span><span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarize</a></span><span class="op">(</span>num_flights <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/context.html">n</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>            .by <span class="op">=</span> <span class="va">dest</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html">arrange</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/desc.html">desc</a></span><span class="op">(</span><span class="va">num_flights</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">inner_join</a></span><span class="op">(</span><span class="va">airports</span>, by <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/join_by.html">join_by</a></span><span class="op">(</span><span class="va">dest</span> <span class="op">==</span> <span class="va">faa</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html">rename</a></span><span class="op">(</span>airport_name <span class="op">=</span> <span class="va">name</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code># A tibble: 101 × 9
   dest  num_flights airport_name             lat    lon   alt    tz dst   tzone
   &lt;chr&gt;       &lt;int&gt; &lt;chr&gt;                  &lt;dbl&gt;  &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;chr&gt; &lt;chr&gt;
 1 ORD         17283 Chicago Ohare Intl      42.0  -87.9   668    -6 A     Amer…
 2 ATL         17215 Hartsfield Jackson At…  33.6  -84.4  1026    -5 A     Amer…
 3 LAX         16174 Los Angeles Intl        33.9 -118.    126    -8 A     Amer…
 4 BOS         15508 General Edward Lawren…  42.4  -71.0    19    -5 A     Amer…
 5 MCO         14082 Orlando Intl            28.4  -81.3    96    -5 A     Amer…
 6 CLT         14064 Charlotte Douglas Intl  35.2  -80.9   748    -5 A     Amer…
 7 SFO         13331 San Francisco Intl      37.6 -122.     13    -8 A     Amer…
 8 FLL         12055 Fort Lauderdale Holly…  26.1  -80.2     9    -5 A     Amer…
 9 MIA         11728 Miami Intl              25.8  -80.3     8    -5 A     Amer…
10 DCA          9705 Ronald Reagan Washing…  38.9  -77.0    15    -5 A     Amer…
# ℹ 91 more rows</code></pre>
</div>
</div>
<p>In case you didn’t know, <code>ORD</code> is the airport code of Chicago O’Hare airport and <code>FLL</code> is the main airport in Fort Lauderdale, Florida, which we can now see in our <code>named_dests</code> data frame.</p>
</section><section id="joining-by-multiple-key-variables" class="level2" data-number="13.3"><h2 data-number="13.3" class="anchored" data-anchor-id="joining-by-multiple-key-variables">
<span class="header-section-number">13.3</span> Joining by multiple “key” variables</h2>
<p>Say instead we are in a situation where we need to join by multiple variables. For example, in the first figure in this section we see that in order to join the <code>flights</code> and <code>weather</code> data frames, we need more than one key variable: <code>year</code>, <code>month</code>, <code>day</code>, <code>hour</code>, and <code>origin</code>. This is because the combination of these 5 variables act to uniquely identify each observational unit in the <code>weather</code> data frame: hourly weather recordings at each of the 3 NYC airports.</p>
<p>We achieve this by specifying a vector of key variables to join by.</p>
<div class="cell">
<details><summary>Code</summary><div class="sourceCode" id="cb78"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">flights_weather_joined</span> <span class="op">&lt;-</span> <span class="va">flights</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">inner_join</a></span><span class="op">(</span><span class="va">weather</span>, </span>
<span>             by <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/join_by.html">join_by</a></span><span class="op">(</span><span class="va">year</span>,<span class="va">month</span>,<span class="va">day</span>,<span class="va">hour</span>,<span class="va">origin</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code># A tibble: 335,220 × 32
    year month   day dep_time sched_dep_time dep_delay arr_time sched_arr_time
   &lt;int&gt; &lt;int&gt; &lt;int&gt;    &lt;int&gt;          &lt;int&gt;     &lt;dbl&gt;    &lt;int&gt;          &lt;int&gt;
 1  2013     1     1      517            515         2      830            819
 2  2013     1     1      533            529         4      850            830
 3  2013     1     1      542            540         2      923            850
 4  2013     1     1      544            545        -1     1004           1022
 5  2013     1     1      554            600        -6      812            837
 6  2013     1     1      554            558        -4      740            728
 7  2013     1     1      555            600        -5      913            854
 8  2013     1     1      557            600        -3      709            723
 9  2013     1     1      557            600        -3      838            846
10  2013     1     1      558            600        -2      753            745
# ℹ 335,210 more rows
# ℹ 24 more variables: arr_delay &lt;dbl&gt;, carrier &lt;chr&gt;, flight &lt;int&gt;,
#   tailnum &lt;chr&gt;, origin &lt;chr&gt;, dest &lt;chr&gt;, air_time &lt;dbl&gt;, distance &lt;dbl&gt;,
#   hour &lt;dbl&gt;, minute &lt;dbl&gt;, time_hour.x &lt;dttm&gt;, gain &lt;dbl&gt;, hours &lt;dbl&gt;,
#   gain_per_hour &lt;dbl&gt;, temp &lt;dbl&gt;, dewp &lt;dbl&gt;, humid &lt;dbl&gt;, wind_dir &lt;dbl&gt;,
#   wind_speed &lt;dbl&gt;, wind_gust &lt;dbl&gt;, precip &lt;dbl&gt;, pressure &lt;dbl&gt;,
#   visib &lt;dbl&gt;, time_hour.y &lt;dttm&gt;</code></pre>
</div>
</div>
<div class="callout callout-style-default callout-tip no-icon callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<i class="bi-question-octagon " style="color: #6dc83c;" role="img" aria-hidden="true"></i> Question
</div>
</div>
<div class="callout-body-container callout-body">
<p>Looking at the first figure in this section, when joining <code>flights</code> and <code>weather</code> (or, in other words, matching the hourly weather values with each flight), why do we need to join by all of <code>year</code>, <code>month</code>, <code>day</code>, <code>hour</code>, and <code>origin</code>, and not just <code>hour</code>?</p>
<div class="webex-solution">
<button>
Answer
</button>
<p><code>year</code>,<code>month</code>,<code>day</code>,<code>hour</code>,<code>origin</code> are the key variables that allow us to uniquely identify the observational units.</p>
</div>
</div>
</div>
</section></section><section id="other-verbs" class="level1" data-number="14"><h1 data-number="14">
<span class="header-section-number">14</span> Other verbs</h1>
<section id="select" class="level2" data-number="14.1"><h2 data-number="14.1" class="anchored" data-anchor-id="select">
<span class="header-section-number">14.1</span> Select variables using select</h2>
<div class="cell">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><img src="select.png" class="img-fluid figure-img" width="578"></p>
<figcaption class="figure-caption">Select diagram from Data Wrangling with dplyr and tidyr cheatsheet.</figcaption></figure>
</div>
</div>
</div>
<p>We’ve seen that the <code>flights</code> data frame in the <code>nycflights13</code> package contains many different variables. The <code>names</code> function gives a listing of all the columns in a data frame; in our case you would run <code>names(flights)</code>. You can also identify these variables by running the <code>glimpse</code> function in the <code>dplyr</code> package:</p>
<div class="cell">
<details><summary>Code</summary><div class="sourceCode" id="cb80"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://pillar.r-lib.org/reference/glimpse.html">glimpse</a></span><span class="op">(</span><span class="va">flights</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code>Rows: 336,776
Columns: 22
$ year           &lt;int&gt; 2013, 2013, 2013, 2013, 2013, 2013, 2013, 2013, 2013, 2…
$ month          &lt;int&gt; 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1…
$ day            &lt;int&gt; 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1…
$ dep_time       &lt;int&gt; 517, 533, 542, 544, 554, 554, 555, 557, 557, 558, 558, …
$ sched_dep_time &lt;int&gt; 515, 529, 540, 545, 600, 558, 600, 600, 600, 600, 600, …
$ dep_delay      &lt;dbl&gt; 2, 4, 2, -1, -6, -4, -5, -3, -3, -2, -2, -2, -2, -2, -1…
$ arr_time       &lt;int&gt; 830, 850, 923, 1004, 812, 740, 913, 709, 838, 753, 849,…
$ sched_arr_time &lt;int&gt; 819, 830, 850, 1022, 837, 728, 854, 723, 846, 745, 851,…
$ arr_delay      &lt;dbl&gt; 11, 20, 33, -18, -25, 12, 19, -14, -8, 8, -2, -3, 7, -1…
$ carrier        &lt;chr&gt; "UA", "UA", "AA", "B6", "DL", "UA", "B6", "EV", "B6", "…
$ flight         &lt;int&gt; 1545, 1714, 1141, 725, 461, 1696, 507, 5708, 79, 301, 4…
$ tailnum        &lt;chr&gt; "N14228", "N24211", "N619AA", "N804JB", "N668DN", "N394…
$ origin         &lt;chr&gt; "EWR", "LGA", "JFK", "JFK", "LGA", "EWR", "EWR", "LGA",…
$ dest           &lt;chr&gt; "IAH", "IAH", "MIA", "BQN", "ATL", "ORD", "FLL", "IAD",…
$ air_time       &lt;dbl&gt; 227, 227, 160, 183, 116, 150, 158, 53, 140, 138, 149, 1…
$ distance       &lt;dbl&gt; 1400, 1416, 1089, 1576, 762, 719, 1065, 229, 944, 733, …
$ hour           &lt;dbl&gt; 5, 5, 5, 5, 6, 5, 6, 6, 6, 6, 6, 6, 6, 6, 6, 5, 6, 6, 6…
$ minute         &lt;dbl&gt; 15, 29, 40, 45, 0, 58, 0, 0, 0, 0, 0, 0, 0, 0, 0, 59, 0…
$ time_hour      &lt;dttm&gt; 2013-01-01 05:00:00, 2013-01-01 05:00:00, 2013-01-01 0…
$ gain           &lt;dbl&gt; -9, -16, -31, 17, 19, -16, -24, 11, 5, -10, 0, 1, -9, 1…
$ hours          &lt;dbl&gt; 3.7833333, 3.7833333, 2.6666667, 3.0500000, 1.9333333, …
$ gain_per_hour  &lt;dbl&gt; -2.3788546, -4.2290749, -11.6250000, 5.5737705, 9.82758…</code></pre>
</div>
</div>
<p>However, say you only want to consider two of these variables, say <code>carrier</code> and <code>flight</code>. You can <code>select</code> these:</p>
<div class="cell">
<details><summary>Code</summary><div class="sourceCode" id="cb82"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">flights</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">carrier</span>, <span class="va">flight</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code># A tibble: 336,776 × 2
   carrier flight
   &lt;chr&gt;    &lt;int&gt;
 1 UA        1545
 2 UA        1714
 3 AA        1141
 4 B6         725
 5 DL         461
 6 UA        1696
 7 B6         507
 8 EV        5708
 9 B6          79
10 AA         301
# ℹ 336,766 more rows</code></pre>
</div>
</div>
<p>This function makes navigating data sets with a very large number of variables easier for humans by restricting consideration to only those of interest, like <code>carrier</code> and <code>flight</code> above. So for example, this might make viewing the data set using the <code>View</code> spreadsheet viewer more digestible. However, as far as the computer is concerned it does not care how many additional variables are in the data set in question, so long as <code>carrier</code> and <code>flight</code> are included.</p>
<p>Another example involves the variable <code>year</code>. If you remember the original description of the <code>flights</code> data frame (or by running <code><a href="https://rdrr.io/pkg/nycflights13/man/flights.html">?flights</a></code>), you will remember that this data corresponds to flights in 2013 departing New York City. The <code>year</code> variable isn’t really a variable here in that it doesn’t vary, the <code>flights</code> data set actually comes from a larger data set that covers many years. We may want to remove the <code>year</code> variable from our data set since it won’t be helpful for analysis in this case. We can deselect <code>year</code> by using the <code>-</code> sign:</p>
<div class="cell">
<details><summary>Code</summary><div class="sourceCode" id="cb84"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">flights_no_year</span> <span class="op">&lt;-</span> <span class="va">flights</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="op">-</span><span class="va">year</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Or we could specify a ranges of columns:</p>
<div class="cell">
<details><summary>Code</summary><div class="sourceCode" id="cb85"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">flight_arr_times</span> <span class="op">&lt;-</span> <span class="va">flights</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">month</span><span class="op">:</span><span class="va">dep_time</span>, <span class="va">arr_time</span><span class="op">:</span><span class="va">sched_arr_time</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code># A tibble: 336,776 × 5
   month   day dep_time arr_time sched_arr_time
   &lt;int&gt; &lt;int&gt;    &lt;int&gt;    &lt;int&gt;          &lt;int&gt;
 1     1     1      517      830            819
 2     1     1      533      850            830
 3     1     1      542      923            850
 4     1     1      544     1004           1022
 5     1     1      554      812            837
 6     1     1      554      740            728
 7     1     1      555      913            854
 8     1     1      557      709            723
 9     1     1      557      838            846
10     1     1      558      753            745
# ℹ 336,766 more rows</code></pre>
</div>
</div>
<p>The <code>select</code> function can also be used to reorder columns in combination with the <code>everything</code> helper function. Let’s suppose we would like the <code>hour</code>, <code>minute</code>, and <code>time_hour</code> variables, which appear at the end of the <code>flights</code> data set, to actually appear immediately after the <code>day</code> variable:</p>
<div class="cell">
<details><summary>Code</summary><div class="sourceCode" id="cb87"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">flights_reorder</span> <span class="op">&lt;-</span> <span class="va">flights</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">month</span><span class="op">:</span><span class="va">day</span>, <span class="va">hour</span><span class="op">:</span><span class="va">time_hour</span>, <span class="fu"><a href="https://tidyselect.r-lib.org/reference/everything.html">everything</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code> [1] "month"          "day"            "hour"           "minute"        
 [5] "time_hour"      "year"           "dep_time"       "sched_dep_time"
 [9] "dep_delay"      "arr_time"       "sched_arr_time" "arr_delay"     
[13] "carrier"        "flight"         "tailnum"        "origin"        
[17] "dest"           "air_time"       "distance"       "gain"          
[21] "hours"          "gain_per_hour" </code></pre>
</div>
</div>
<p>in this case <code><a href="https://tidyselect.r-lib.org/reference/everything.html">everything()</a></code> picks up all remaining variables. Lastly, the helper functions <code>starts_with</code>, <code>ends_with</code>, and <code>contains</code> can be used to choose <strong>variables / column names</strong> that match those conditions:</p>
<div class="cell">
<details><summary>Code</summary><div class="sourceCode" id="cb89"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">flights_begin_a</span> <span class="op">&lt;-</span> <span class="va">flights</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html">starts_with</a></span><span class="op">(</span><span class="st">"a"</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code># A tibble: 336,776 × 3
   arr_time arr_delay air_time
      &lt;int&gt;     &lt;dbl&gt;    &lt;dbl&gt;
 1      830        11      227
 2      850        20      227
 3      923        33      160
 4     1004       -18      183
 5      812       -25      116
 6      740        12      150
 7      913        19      158
 8      709       -14       53
 9      838        -8      140
10      753         8      138
# ℹ 336,766 more rows</code></pre>
</div>
</div>
<div class="cell">
<details><summary>Code</summary><div class="sourceCode" id="cb91"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">flights_delays</span> <span class="op">&lt;-</span> <span class="va">flights</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html">ends_with</a></span><span class="op">(</span><span class="st">"delay"</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code># A tibble: 336,776 × 2
   dep_delay arr_delay
       &lt;dbl&gt;     &lt;dbl&gt;
 1         2        11
 2         4        20
 3         2        33
 4        -1       -18
 5        -6       -25
 6        -4        12
 7        -5        19
 8        -3       -14
 9        -3        -8
10        -2         8
# ℹ 336,766 more rows</code></pre>
</div>
</div>
<div class="cell">
<details><summary>Code</summary><div class="sourceCode" id="cb93"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">flights_time</span> <span class="op">&lt;-</span> <span class="va">flights</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html">contains</a></span><span class="op">(</span><span class="st">"time"</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code># A tibble: 336,776 × 6
   dep_time sched_dep_time arr_time sched_arr_time air_time time_hour          
      &lt;int&gt;          &lt;int&gt;    &lt;int&gt;          &lt;int&gt;    &lt;dbl&gt; &lt;dttm&gt;             
 1      517            515      830            819      227 2013-01-01 05:00:00
 2      533            529      850            830      227 2013-01-01 05:00:00
 3      542            540      923            850      160 2013-01-01 05:00:00
 4      544            545     1004           1022      183 2013-01-01 05:00:00
 5      554            600      812            837      116 2013-01-01 06:00:00
 6      554            558      740            728      150 2013-01-01 05:00:00
 7      555            600      913            854      158 2013-01-01 06:00:00
 8      557            600      709            723       53 2013-01-01 06:00:00
 9      557            600      838            846      140 2013-01-01 06:00:00
10      558            600      753            745      138 2013-01-01 06:00:00
# ℹ 336,766 more rows</code></pre>
</div>
</div>
</section><section id="rename" class="level2" data-number="14.2"><h2 data-number="14.2" class="anchored" data-anchor-id="rename">
<span class="header-section-number">14.2</span> Rename variables using rename</h2>
<p>Another useful function is <code>rename</code>, which as you may suspect renames one column to another name. Suppose we wanted <code>dep_time</code> and <code>arr_time</code> to be <code>departure_time</code> and <code>arrival_time</code> instead in the <code>flights_time</code> data frame:</p>
<div class="cell">
<details><summary>Code</summary><div class="sourceCode" id="cb95"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">flights_time</span> <span class="op">&lt;-</span> <span class="va">flights</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html">contains</a></span><span class="op">(</span><span class="st">"time"</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html">rename</a></span><span class="op">(</span>departure_time <span class="op">=</span> <span class="va">dep_time</span>,</span>
<span>         arrival_time <span class="op">=</span> <span class="va">arr_time</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code>[1] "departure_time" "sched_dep_time" "arrival_time"   "sched_arr_time"
[5] "air_time"       "time_hour"     </code></pre>
</div>
</div>
<p>Note that in this case we used a single <code>=</code> sign with <code>rename</code>. eg. <code>departure_time = dep_time</code>. This is because we are not testing for equality like we would using <code>==</code>, but instead we want to assign a new variable <code>departure_time</code> to have the same values as <code>dep_time</code> and then delete the variable <code>dep_time</code>.</p>
</section><section id="find-the-top-number-of-values-using-slice" class="level2" data-number="14.3"><h2 data-number="14.3" class="anchored" data-anchor-id="find-the-top-number-of-values-using-slice">
<span class="header-section-number">14.3</span> Find the top number of values using slice</h2>
<p>We can also use the <code><a href="https://dplyr.tidyverse.org/reference/slice.html">slice_max()</a></code> function which automatically tells us the most frequent <code>num_flights</code>. We specify the top 10 airports here:</p>
<div class="cell">
<details><summary>Code</summary><div class="sourceCode" id="cb97"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">named_dests</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/slice.html">slice_max</a></span><span class="op">(</span><span class="va">num_flights</span>, n <span class="op">=</span> <span class="fl">10</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code># A tibble: 10 × 9
   dest  num_flights airport_name             lat    lon   alt    tz dst   tzone
   &lt;chr&gt;       &lt;int&gt; &lt;chr&gt;                  &lt;dbl&gt;  &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;chr&gt; &lt;chr&gt;
 1 ORD         17283 Chicago Ohare Intl      42.0  -87.9   668    -6 A     Amer…
 2 ATL         17215 Hartsfield Jackson At…  33.6  -84.4  1026    -5 A     Amer…
 3 LAX         16174 Los Angeles Intl        33.9 -118.    126    -8 A     Amer…
 4 BOS         15508 General Edward Lawren…  42.4  -71.0    19    -5 A     Amer…
 5 MCO         14082 Orlando Intl            28.4  -81.3    96    -5 A     Amer…
 6 CLT         14064 Charlotte Douglas Intl  35.2  -80.9   748    -5 A     Amer…
 7 SFO         13331 San Francisco Intl      37.6 -122.     13    -8 A     Amer…
 8 FLL         12055 Fort Lauderdale Holly…  26.1  -80.2     9    -5 A     Amer…
 9 MIA         11728 Miami Intl              25.8  -80.3     8    -5 A     Amer…
10 DCA          9705 Ronald Reagan Washing…  38.9  -77.0    15    -5 A     Amer…</code></pre>
</div>
</div>
<p>We can find the most frequent flights in a single pipeline as follows:</p>
<div class="cell">
<details><summary>Code</summary><div class="sourceCode" id="cb99"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">ten_freq_dests</span> <span class="op">&lt;-</span> <span class="va">flights</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarize</a></span><span class="op">(</span>num_flights <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/context.html">n</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>            .by <span class="op">=</span> <span class="va">dest</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/slice.html">slice_max</a></span><span class="op">(</span><span class="va">num_flights</span>, n <span class="op">=</span> <span class="fl">10</span><span class="op">)</span> </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code># A tibble: 10 × 2
   dest  num_flights
   &lt;chr&gt;       &lt;int&gt;
 1 ORD         17283
 2 ATL         17215
 3 LAX         16174
 4 BOS         15508
 5 MCO         14082
 6 CLT         14064
 7 SFO         13331
 8 FLL         12055
 9 MIA         11728
10 DCA          9705</code></pre>
</div>
</div>
<div class="callout callout-style-default callout-warning no-icon callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Task
</div>
</div>
<div class="callout-body-container callout-body">
<p>How could one use <code>starts_with</code>, <code>ends_with</code>, and <code>contains</code> to select columns from the <code>flights</code> data frame? Provide three different examples in total: one for <code>starts_with</code>, one for <code>ends_with</code>, and one for <code>contains</code>.</p>
<div class="cell" data-webex.hide="Click here to see the solution">
<div class="webex-solution">
<button>
Click here to see the solution
</button>
<details open=""><summary>Code</summary><div class="sourceCode" id="cb101"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Select arrival time and arrival delay columns</span></span>
<span><span class="va">flights</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html">starts_with</a></span><span class="op">(</span><span class="st">"arr"</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code># A tibble: 336,776 × 2
   arr_time arr_delay
      &lt;int&gt;     &lt;dbl&gt;
 1      830        11
 2      850        20
 3      923        33
 4     1004       -18
 5      812       -25
 6      740        12
 7      913        19
 8      709       -14
 9      838        -8
10      753         8
# ℹ 336,766 more rows</code></pre>
</div>
<details open=""><summary>Code</summary><div class="sourceCode" id="cb103"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Select departure and arrival delay columns</span></span>
<span><span class="va">flights</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html">ends_with</a></span><span class="op">(</span><span class="st">"delay"</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code># A tibble: 336,776 × 2
   dep_delay arr_delay
       &lt;dbl&gt;     &lt;dbl&gt;
 1         2        11
 2         4        20
 3         2        33
 4        -1       -18
 5        -6       -25
 6        -4        12
 7        -5        19
 8        -3       -14
 9        -3        -8
10        -2         8
# ℹ 336,766 more rows</code></pre>
</div>
<details open=""><summary>Code</summary><div class="sourceCode" id="cb105"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Select departure times, schedule  departure and departure delay columns</span></span>
<span><span class="va">flights</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html">contains</a></span><span class="op">(</span><span class="st">"dep"</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code># A tibble: 336,776 × 3
   dep_time sched_dep_time dep_delay
      &lt;int&gt;          &lt;int&gt;     &lt;dbl&gt;
 1      517            515         2
 2      533            529         4
 3      542            540         2
 4      544            545        -1
 5      554            600        -6
 6      554            558        -4
 7      555            600        -5
 8      557            600        -3
 9      557            600        -3
10      558            600        -2
# ℹ 336,766 more rows</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="callout callout-style-default callout-warning no-icon callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Task
</div>
</div>
<div class="callout-body-container callout-body">
<p>Create a new data frame that shows the top 5 airports with the largest average arrival delays from NYC in 2013.</p>
<div class="webex-solution">
<button>
Take a hint
</button>
<p>Compute the mean arrival delay from each destination. You can then join the resulting data set with the <code>airports</code> data which contains the airports names and search for the top 5 entries.</p>
</div>
<div class="cell" data-webex.hide="Click here to see the solution">
<div class="webex-solution">
<button>
Click here to see the solution
</button>
<details open=""><summary>Code</summary><div class="sourceCode" id="cb107"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span>  <span class="va">flights</span><span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarize</a></span><span class="op">(</span>mean_arr_delay <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">arr_delay</span>,na.rm<span class="op">=</span><span class="cn">T</span><span class="op">)</span>,</span>
<span>            .by <span class="op">=</span> <span class="va">dest</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">inner_join</a></span><span class="op">(</span><span class="va">airports</span>, by <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/join_by.html">join_by</a></span><span class="op">(</span><span class="va">dest</span> <span class="op">==</span> <span class="va">faa</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html">rename</a></span><span class="op">(</span>airport_name <span class="op">=</span> <span class="va">name</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/slice.html">slice_max</a></span><span class="op">(</span><span class="va">mean_arr_delay</span>,n<span class="op">=</span><span class="fl">5</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</div>
</div>
</div>
</section><section id="vectorised-if-else-thru-case_when" class="level2" data-number="14.4"><h2 data-number="14.4" class="anchored" data-anchor-id="vectorised-if-else-thru-case_when">
<span class="header-section-number">14.4</span> Vectorised if-else thru <code>case_when</code>
</h2>
<p><code>case_when</code> serves as a method to streamline multiple if-else statements by vectorizing them. It allows us to assess a condition expression and make decisions accordingly. For instance, consider a scenario where we need to categorize weather conditions according to the meteorological data contained in the <code>weather</code> data set.</p>
<p>Let suppose that we want to categorize the temperature variable into three categories:</p>
<ul>
<li><p><strong>low</strong> for temperatures <span class="math inline">\(&lt;39.9\)</span></p></li>
<li><p><strong>medium</strong> for temperature values <span class="math inline">\(\geq 39.9\)</span> and <span class="math inline">\(\leq 70\)</span></p></li>
<li><p><strong>high</strong> for temperature values <span class="math inline">\(&gt; 70\)</span></p></li>
</ul>
<p>We can achieve this with the following code:</p>
<div class="cell">
<details open=""><summary>Code</summary><div class="sourceCode" id="cb108"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">weather</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span></span>
<span>    temp_cat <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_when.html">case_when</a></span><span class="op">(</span></span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">temp</span><span class="op">)</span> <span class="op">~</span> <span class="cn">NA</span>,</span>
<span>      <span class="va">temp</span> <span class="op">&lt;</span> <span class="fl">39.9</span> <span class="op">~</span> <span class="st">"low"</span>,</span>
<span>      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/between.html">between</a></span><span class="op">(</span><span class="va">temp</span>,<span class="fl">39.9</span> ,<span class="fl">70</span><span class="op">)</span><span class="op">~</span> <span class="st">"medium"</span>,</span>
<span>      .default <span class="op">=</span> <span class="st">"large"</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/relocate.html">relocate</a></span><span class="op">(</span><span class="va">temp</span>,<span class="va">temp_cat</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code># A tibble: 26,115 × 16
    temp temp_cat origin  year month   day  hour  dewp humid wind_dir wind_speed
   &lt;dbl&gt; &lt;chr&gt;    &lt;chr&gt;  &lt;int&gt; &lt;int&gt; &lt;int&gt; &lt;int&gt; &lt;dbl&gt; &lt;dbl&gt;    &lt;dbl&gt;      &lt;dbl&gt;
 1  39.0 low      EWR     2013     1     1     1  26.1  59.4      270      10.4 
 2  39.0 low      EWR     2013     1     1     2  27.0  61.6      250       8.06
 3  39.0 low      EWR     2013     1     1     3  28.0  64.4      240      11.5 
 4  39.9 medium   EWR     2013     1     1     4  28.0  62.2      250      12.7 
 5  39.0 low      EWR     2013     1     1     5  28.0  64.4      260      12.7 
 6  37.9 low      EWR     2013     1     1     6  28.0  67.2      240      11.5 
 7  39.0 low      EWR     2013     1     1     7  28.0  64.4      240      15.0 
 8  39.9 medium   EWR     2013     1     1     8  28.0  62.2      250      10.4 
 9  39.9 medium   EWR     2013     1     1     9  28.0  62.2      260      15.0 
10  41   medium   EWR     2013     1     1    10  28.0  59.6      260      13.8 
# ℹ 26,105 more rows
# ℹ 5 more variables: wind_gust &lt;dbl&gt;, precip &lt;dbl&gt;, pressure &lt;dbl&gt;,
#   visib &lt;dbl&gt;, time_hour &lt;dttm&gt;</code></pre>
</div>
</div>
<p>Here we use the <code>mutate</code> command to create new variable named <code>temp_cat</code>. The <code>case_when</code> will then set to <code>NA</code> those values in the original <code>temp</code> variable that are missing. Then if the values of <code>temp</code> are <span class="math inline">\(&lt; 30.9\)</span> it will assign them the label of <code>low</code>. If they lie between <span class="math inline">\(39.9\)</span> and <span class="math inline">\(70\)</span> it will assign them the label of <code>medium</code> and finally set to <code>large</code> any of the values that do not meet any of the aforementioned conditions. We can also use the function <code>relocate</code> to change the columns position so that the <code>temp</code> and <code>temp_cat</code> appears first on the data frame.</p>
<div class="callout callout-style-default callout-warning no-icon callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Task
</div>
</div>
<div class="callout-body-container callout-body">
<p>Create a new variable called <code>extreme_weather</code> that takes the value of <code>extreme</code> if the wind speed exceeds 64 mph and the temperature is less than 40 °F and <code>not extreme</code> otherwise. Then, relocate this new variable along with the variables used to create it at the first columns of the data frame, and sort them out based on <code>wind_speed</code>.</p>
<div class="webex-solution">
<button>
Take a hint
</button>
<p>Use the conditional operators <code>|</code> and <code>&amp;</code> to add multiple conditions.</p>
</div>
<div class="cell" data-webex.hide="Click here to see the solution">
<div class="webex-solution">
<button>
Click here to see the solution
</button>
<details open=""><summary>Code</summary><div class="sourceCode" id="cb110"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">weather</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span></span>
<span>    extreme_weather  <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_when.html">case_when</a></span><span class="op">(</span></span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">temp</span><span class="op">)</span><span class="op">|</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">wind_speed</span><span class="op">)</span> <span class="op">~</span> <span class="cn">NA</span>,</span>
<span>      <span class="va">temp</span> <span class="op">&lt;</span> <span class="fl">40</span> <span class="op">&amp;</span> <span class="va">wind_speed</span>  <span class="op">&gt;</span> <span class="fl">64</span><span class="op">~</span> <span class="st">"extreme"</span>,</span>
<span>      .default <span class="op">=</span> <span class="st">"not extreme"</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/relocate.html">relocate</a></span><span class="op">(</span><span class="va">extreme_weather</span>,<span class="va">temp</span>,<span class="va">wind_speed</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html">arrange</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/desc.html">desc</a></span><span class="op">(</span><span class="va">wind_speed</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code># A tibble: 26,115 × 16
   extreme_weather  temp wind_speed origin  year month   day  hour  dewp humid
   &lt;chr&gt;           &lt;dbl&gt;      &lt;dbl&gt; &lt;chr&gt;  &lt;int&gt; &lt;int&gt; &lt;int&gt; &lt;int&gt; &lt;dbl&gt; &lt;dbl&gt;
 1 extreme          39.0     1048.  EWR     2013     2    12     3 27.0   61.6
 2 not extreme      57.2       42.6 EWR     2013     1    31     6 53.6   87.7
 3 not extreme      53.6       42.6 JFK     2013     1    31     4 53.1  100  
 4 not extreme      60.8       40.3 EWR     2013     1    31     4 59     93.8
 5 not extreme      59         40.3 LGA     2013     1    31     4 55.4   93.7
 6 not extreme      46.0       39.1 EWR     2013     1    31     8 30.0   53.3
 7 not extreme      41         38.0 JFK     2013     3     6    14 28.9   61.9
 8 not extreme      53.1       36.8 JFK     2013     1    31     3 52.0  100  
 9 not extreme      51.8       36.8 JFK     2013     1    31     7 46.4   81.7
10 not extreme      28.0       36.8 JFK     2013    11    24    10 -0.04  29.2
# ℹ 26,105 more rows
# ℹ 6 more variables: wind_dir &lt;dbl&gt;, wind_gust &lt;dbl&gt;, precip &lt;dbl&gt;,
#   pressure &lt;dbl&gt;, visib &lt;dbl&gt;, time_hour &lt;dttm&gt;</code></pre>
</div>
</div>
</div>
</div>
</div>
</section></section><section id="summary" class="level1" data-number="15"><h1 data-number="15">
<span class="header-section-number">15</span> Summary</h1>
<p>The table below lists a selection of the data wrangling verbs and summarises what they do. Using these verbs and the pipe <code>|&gt;</code> operator, you’ll be able to write easily legible code to perform almost all the data wrangling necessary for the rest of this course.</p>
<div class="cell-output-display">
<table class="table" data-quarto-postprocess="true">
<caption>Summary of data wrangling verbs</caption>
<thead><tr class="header">
<th style="text-align: left;" data-quarto-table-cell-role="th">Verb</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">Operation</th>
</tr></thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">filter()</td>
<td style="text-align: left;">Pick out a subset of rows</td>
</tr>
<tr class="even">
<td style="text-align: left;">summarize()</td>
<td style="text-align: left;">Summarise many values to one using a summary statistic function like mean(), median(), etc.</td>
</tr>
<tr class="odd">
<td style="text-align: left;">mutate()</td>
<td style="text-align: left;">Create new variables by mutating existing ones</td>
</tr>
<tr class="even">
<td style="text-align: left;">arrange()</td>
<td style="text-align: left;">Arrange rows of a data variable in ascending (default) or descending order</td>
</tr>
<tr class="odd">
<td style="text-align: left;">inner_join()</td>
<td style="text-align: left;">Join/merge two data frames, matching rows by a key variable</td>
</tr>
<tr class="even">
<td style="text-align: left;">select()</td>
<td style="text-align: left;">Pick out a subset of columns to make data frames easier to view</td>
</tr>
</tbody>
</table>
</div>


</section></main><!-- /main --><script>

/* update total correct if #webex-total_correct exists */
update_total_correct = function() {
  console.log("webex: update total_correct");

  var t = document.getElementsByClassName("webex-total_correct");
  for (var i = 0; i < t.length; i++) {
    p = t[i].parentElement;
    var correct = p.getElementsByClassName("webex-correct").length;
    var solvemes = p.getElementsByClassName("webex-solveme").length;
    var radiogroups = p.getElementsByClassName("webex-radiogroup").length;
    var selects = p.getElementsByClassName("webex-select").length;

    t[i].innerHTML = correct + " of " + (solvemes + radiogroups + selects) + " correct";
  }
}

/* webex-solution button toggling function */
b_func = function() {
  console.log("webex: toggle hide");

  var cl = this.parentElement.classList;
  if (cl.contains('open')) {
    cl.remove("open");
  } else {
    cl.add("open");
  }
}

/* check answers */
check_func = function() {
  console.log("webex: check answers");

  var cl = this.parentElement.classList;
  if (cl.contains('unchecked')) {
    cl.remove("unchecked");
    this.innerHTML = "Hide Answers";
  } else {
    cl.add("unchecked");
    this.innerHTML = "Show Answers";
  }
}

/* function for checking solveme answers */
solveme_func = function(e) {
  console.log("webex: check solveme");

  var real_answers = JSON.parse(this.dataset.answer);
  var my_answer = this.value;
  var cl = this.classList;
  if (cl.contains("ignorecase")) {
    my_answer = my_answer.toLowerCase();
  }
  if (cl.contains("nospaces")) {
    my_answer = my_answer.replace(/ /g, "")
  }

  if (my_answer == "") {
    cl.remove("webex-correct");
    cl.remove("webex-incorrect");
  } else if (real_answers.includes(my_answer)) {
    cl.add("webex-correct");
    cl.remove("webex-incorrect");
  } else {
    cl.add("webex-incorrect");
    cl.remove("webex-correct");
  }

  // match numeric answers within a specified tolerance
  if(this.dataset.tol > 0){
    var tol = JSON.parse(this.dataset.tol);
    var matches = real_answers.map(x => Math.abs(x - my_answer) < tol)
    if (matches.reduce((a, b) => a + b, 0) > 0) {
      cl.add("webex-correct");
    } else {
      cl.remove("webex-correct");
    }
  }

  // added regex bit
  if (cl.contains("regex")){
    answer_regex = RegExp(real_answers.join("|"))
    if (answer_regex.test(my_answer)) {
      cl.add("webex-correct");
    }
  }

  update_total_correct();
}

/* function for checking select answers */
select_func = function(e) {
  console.log("webex: check select");

  var cl = this.classList

  /* add style */
  cl.remove("webex-incorrect");
  cl.remove("webex-correct");
  if (this.value == "answer") {
    cl.add("webex-correct");
  } else if (this.value != "blank") {
    cl.add("webex-incorrect");
  }

  update_total_correct();
}

/* function for checking radiogroups answers */
radiogroups_func = function(e) {
  console.log("webex: check radiogroups");

  var checked_button = document.querySelector('input[name=' + this.id + ']:checked');
  var cl = checked_button.parentElement.classList;
  var labels = checked_button.parentElement.parentElement.children;

  /* get rid of styles */
  for (i = 0; i < labels.length; i++) {
    labels[i].classList.remove("webex-incorrect");
    labels[i].classList.remove("webex-correct");
  }

  /* add style */
  if (checked_button.value == "answer") {
    cl.add("webex-correct");
  } else {
    cl.add("webex-incorrect");
  }

  update_total_correct();
}

window.onload = function() {
  console.log("webex onload");
  /* set up solution buttons */
  var buttons = document.getElementsByTagName("button");

  for (var i = 0; i < buttons.length; i++) {
    if (buttons[i].parentElement.classList.contains('webex-solution')) {
      buttons[i].onclick = b_func;
    }
  }

  var check_sections = document.getElementsByClassName("webex-check");
  console.log("check:", check_sections.length);
  for (var i = 0; i < check_sections.length; i++) {
    check_sections[i].classList.add("unchecked");

    let btn = document.createElement("button");
    btn.innerHTML = "Show Answers";
    btn.classList.add("webex-check-button");
    btn.onclick = check_func;
    check_sections[i].appendChild(btn);

    let spn = document.createElement("span");
    spn.classList.add("webex-total_correct");
    check_sections[i].appendChild(spn);
  }

  /* set up webex-solveme inputs */
  var solveme = document.getElementsByClassName("webex-solveme");

  for (var i = 0; i < solveme.length; i++) {
    /* make sure input boxes don't auto-anything */
    solveme[i].setAttribute("autocomplete","off");
    solveme[i].setAttribute("autocorrect", "off");
    solveme[i].setAttribute("autocapitalize", "off");
    solveme[i].setAttribute("spellcheck", "false");
    solveme[i].value = "";

    /* adjust answer for ignorecase or nospaces */
    var cl = solveme[i].classList;
    var real_answer = solveme[i].dataset.answer;
    if (cl.contains("ignorecase")) {
      real_answer = real_answer.toLowerCase();
    }
    if (cl.contains("nospaces")) {
      real_answer = real_answer.replace(/ /g, "");
    }
    solveme[i].dataset.answer = real_answer;

    /* attach checking function */
    solveme[i].onkeyup = solveme_func;
    solveme[i].onchange = solveme_func;

    solveme[i].insertAdjacentHTML("afterend", " <span class='webex-icon'></span>")
  }

  /* set up radiogroups */
  var radiogroups = document.getElementsByClassName("webex-radiogroup");
  for (var i = 0; i < radiogroups.length; i++) {
    radiogroups[i].onchange = radiogroups_func;
  }

  /* set up selects */
  var selects = document.getElementsByClassName("webex-select");
  for (var i = 0; i < selects.length; i++) {
    selects[i].onchange = select_func;
    selects[i].insertAdjacentHTML("afterend", " <span class='webex-icon'></span>")
  }

  update_total_correct();
}

</script><script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  const viewSource = window.document.getElementById('quarto-view-source') ||
                     window.document.getElementById('quarto-code-tools-source');
  if (viewSource) {
    const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
    viewSource.addEventListener("click", function(e) {
      if (sourceUrl) {
        // rstudio viewer pane
        if (/\bcapabilities=\b/.test(window.location)) {
          window.open(sourceUrl);
        } else {
          window.location.href = sourceUrl;
        }
      } else {
        const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
        modal.show();
      }
      return false;
    });
  }
  function toggleCodeHandler(show) {
    return function(e) {
      const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
      for (let i=0; i<detailsSrc.length; i++) {
        const details = detailsSrc[i].parentElement;
        if (show) {
          details.open = true;
        } else {
          details.removeAttribute("open");
        }
      }
      const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
      const fromCls = show ? "hidden" : "unhidden";
      const toCls = show ? "unhidden" : "hidden";
      for (let i=0; i<cellCodeDivs.length; i++) {
        const codeDiv = cellCodeDivs[i];
        if (codeDiv.classList.contains(fromCls)) {
          codeDiv.classList.remove(fromCls);
          codeDiv.classList.add(toCls);
        } 
      }
      return false;
    }
  }
  const hideAllCode = window.document.getElementById("quarto-hide-all-code");
  if (hideAllCode) {
    hideAllCode.addEventListener("click", toggleCodeHandler(false));
  }
  const showAllCode = window.document.getElementById("quarto-show-all-code");
  if (showAllCode) {
    showAllCode.addEventListener("click", toggleCodeHandler(true));
  }
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->



</body></html>